<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>10&nbsp; Example: Machine Learning Workflows ‚Äì Pocket</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./pocket_book.pocket_model.html" rel="next">
<link href="./pocket_book.extending_pocket.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4c01329f4fc381cbb6082899e66f51f8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pocket_book.ml_workflows.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example: Machine Learning Workflows</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Pocket</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Configuration</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.logging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.recursive_caching_in_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recursive Caching in Pipelines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.usage_practices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Usage Practices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.real_world_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Real-World Walkthrough: Weather Analysis Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.concurrency.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Concurrency</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.extending_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extending Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.ml_workflows.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example: Machine Learning Workflows</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.pocket_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">üöß Draft: <code>pocket-model</code> ‚Äî drop-in caching for metamorph.ml</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.cache_keys.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Under the hood: cache keys</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.developing_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Developing Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.api_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">API Reference</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#pipeline-functions" id="toc-pipeline-functions" class="nav-link" data-scroll-target="#pipeline-functions">Pipeline functions</a></li>
  <li><a href="#ground-truth" id="toc-ground-truth" class="nav-link" data-scroll-target="#ground-truth">Ground truth</a></li>
  <li><a href="#model-specifications" id="toc-model-specifications" class="nav-link" data-scroll-target="#model-specifications">Model specifications</a></li>
  <li><a href="#part-1-feature-engineering-matters-for-some-models" id="toc-part-1-feature-engineering-matters-for-some-models" class="nav-link" data-scroll-target="#part-1-feature-engineering-matters-for-some-models">Part 1 ‚Äî Feature engineering matters (for some models)</a>
  <ul>
  <li><a href="#generate-data" id="toc-generate-data" class="nav-link" data-scroll-target="#generate-data">Generate data</a></li>
  <li><a href="#split-into-train-and-test" id="toc-split-into-train-and-test" class="nav-link" data-scroll-target="#split-into-train-and-test">Split into train and test</a></li>
  <li><a href="#feature-sets" id="toc-feature-sets" class="nav-link" data-scroll-target="#feature-sets">Feature sets</a></li>
  <li><a href="#prepare-features-cached" id="toc-prepare-features-cached" class="nav-link" data-scroll-target="#prepare-features-cached">Prepare features (cached)</a></li>
  <li><a href="#train-models-cached" id="toc-train-models-cached" class="nav-link" data-scroll-target="#train-models-cached">Train models (cached)</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  <li><a href="#predictions-plot" id="toc-predictions-plot" class="nav-link" data-scroll-target="#predictions-plot">Predictions plot</a></li>
  </ul></li>
  <li><a href="#part-2-how-models-handle-noisy-data" id="toc-part-2-how-models-handle-noisy-data" class="nav-link" data-scroll-target="#part-2-how-models-handle-noisy-data">Part 2 ‚Äî How models handle noisy data</a>
  <ul>
  <li><a href="#rmse-vs.-noise" id="toc-rmse-vs.-noise" class="nav-link" data-scroll-target="#rmse-vs.-noise">RMSE vs.&nbsp;noise</a></li>
  </ul></li>
  <li><a href="#part-3-what-got-cached" id="toc-part-3-what-got-cached" class="nav-link" data-scroll-target="#part-3-what-got-cached">Part 3 ‚Äî What got cached?</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  <li><a href="#part-4-sharing-computations-across-branches" id="toc-part-4-sharing-computations-across-branches" class="nav-link" data-scroll-target="#part-4-sharing-computations-across-branches">Part 4 ‚Äî Sharing computations across branches</a>
  <ul>
  <li><a href="#pipeline-functions-1" id="toc-pipeline-functions-1" class="nav-link" data-scroll-target="#pipeline-functions-1">Pipeline functions</a></li>
  <li><a href="#build-the-dag-with-mixed-storage-policies" id="toc-build-the-dag-with-mixed-storage-policies" class="nav-link" data-scroll-target="#build-the-dag-with-mixed-storage-policies">Build the DAG with mixed storage policies</a></li>
  <li><a href="#visualize-the-dag" id="toc-visualize-the-dag" class="nav-link" data-scroll-target="#visualize-the-dag">Visualize the DAG</a></li>
  <li><a href="#execute-the-pipeline" id="toc-execute-the-pipeline" class="nav-link" data-scroll-target="#execute-the-pipeline">Execute the pipeline</a></li>
  </ul></li>
  <li><a href="#part-5-comparing-many-experiments-at-once" id="toc-part-5-comparing-many-experiments-at-once" class="nav-link" data-scroll-target="#part-5-comparing-many-experiments-at-once">Part 5 ‚Äî Comparing many experiments at once</a>
  <ul>
  <li><a href="#results-visualization" id="toc-results-visualization" class="nav-link" data-scroll-target="#results-visualization">Results visualization</a></li>
  </ul></li>
  <li><a href="#what-we-learned" id="toc-what-we-learned" class="nav-link" data-scroll-target="#what-we-learned">What we learned</a></li>
  <li><a href="#cleanup-1" id="toc-cleanup-1" class="nav-link" data-scroll-target="#cleanup-1">Cleanup</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example: Machine Learning Workflows</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<style></style>
<style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style>
<style>.clay-limit-image-width .clay-image {max-width: 100%}
.clay-side-by-side .sourceCode {margin: 0}
.clay-side-by-side {margin: 1em 0}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js" type="text/javascript"></script>
<p><strong>Last modified: 2026-02-08</strong></p>
<p>This chapter demonstrates Pocket in a realistic machine learning scenario. If you‚Äôre new to ML, don‚Äôt worry ‚Äî we‚Äôll explain the concepts as we go. The focus is on how caching helps when you‚Äôre exploring many combinations of data, features, and models.</p>
<p><strong>The problem</strong>: We want to predict a numeric value (like house prices or temperature) from input data. This is called <a href="https://en.wikipedia.org/wiki/Regression_analysis"><em>regression</em></a>. We‚Äôll generate synthetic data, try different ways of preparing it, and compare two learning algorithms.</p>
<p><strong>Why caching matters</strong>: Training models can be slow. When you‚Äôre experimenting ‚Äî tweaking parameters, trying new features ‚Äî you don‚Äôt want to recompute everything each time. Pocket caches each step independently, so only the parts you changed get recomputed.</p>
<p><strong>What we‚Äôll cover</strong>:</p>
<ul>
<li>Part 1: <a href="https://en.wikipedia.org/wiki/Feature_engineering">Feature engineering</a> ‚Äî transforming inputs to help models learn</li>
<li>Part 2: Noise sensitivity ‚Äî how models behave with messy data</li>
<li>Part 3: The caching payoff ‚Äî what got cached and why it matters</li>
<li>Part 4: DAG workflows ‚Äî when preprocessing steps share dependencies</li>
<li>Part 5: <a href="https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)">Hyperparameter</a> sweeps ‚Äî comparing many experiments at once</li>
</ul>
<p><strong>Note</strong>: This notebook uses <a href="https://scicloj.github.io/tablecloth/">tablecloth</a> for data manipulation, <a href="https://github.com/scicloj/metamorph.ml">metamorph.ml</a> and <a href="https://github.com/scicloj/scicloj.ml.tribuo">tribuo</a> for ML, and <a href="https://plotly.com/javascript/">Plotly.js</a> for visualization. These are not Pocket dependencies ‚Äî they illustrate a realistic ML workflow. All output is shown inline; to reproduce it, add <a href="https://scicloj.github.io/noj/">noj</a> to your project dependencies.</p>
<p><strong>Why synthetic data?</strong> Working with synthetic data is a standard practice in machine learning. Because we define the true relationship (<span class="math inline">\(y = \sin(x) \cdot x\)</span>), we can measure exactly how well each model recovers it ‚Äî something impossible with real-world data where the ground truth is unknown. Synthetic experiments let us isolate one variable at a time: does feature engineering help? How does noise affect each algorithm? These controlled comparisons build intuition that transfers to real problems. In our case, we‚Äôll see that a linear model is helpless against a nonlinear target <em>unless</em> we give it the right features, while a <a href="https://en.wikipedia.org/wiki/Decision_tree_learning">decision tree</a> handles the shape on its own but pays a different price when noise increases.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> pocket-book.ml-workflows</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Logging setup for this chapter (see Logging chapter):</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   [pocket-book.logging]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Pocket API:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   [scicloj.pocket <span class="at">:as</span> pocket]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Annotating kinds of visualizations:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   [scicloj.kindly.v4.kind <span class="at">:as</span> kind]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Data processing:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   [tablecloth.api <span class="at">:as</span> tc]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   [tablecloth.column.api <span class="at">:as</span> tcc]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>   [tech.v3.dataset <span class="at">:as</span> ds]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>   [tech.v3.dataset.modelling <span class="at">:as</span> ds-mod]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Machine learning:</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml <span class="at">:as</span> ml]</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml.loss <span class="at">:as</span> loss]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>   [scicloj.ml.tribuo]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cache-dir </span><span class="st">"/tmp/pocket-regression"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>(pocket/set-base-cache-dir! cache-dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.409 INFO scicloj.pocket - Cache dir set to: /tmp/pocket-regression
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="st">"/tmp/pocket-regression"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.409 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-regression
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-regression"</span>, <span class="at">:existed</span> <span class="va">false</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="pipeline-functions" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-functions">Pipeline functions</h2>
<p>These are the steps of our ML pipeline ‚Äî plain Clojure functions that know nothing about caching. Pocket will wrap them later.</p>
<p><strong>Data generation</strong>: <code>make-regression-data</code> creates a synthetic dataset from a ground-truth function. We control the sample size, noise level, and random seed ‚Äî all of which become part of the cache key, so changing any parameter triggers recomputation.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-regression-data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Generate a synthetic regression dataset.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">  `f` is a function from x to y (the ground truth).</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="st">  Optional `outlier-fraction` (0‚Äì1) and `outlier-scale` inject</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">  corrupted x values to simulate sensor glitches."</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:keys</span> [f n noise-sd seed outlier-fraction outlier-scale]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">:or</span> {outlier-fraction <span class="dv">0</span> outlier-scale <span class="dv">10</span>}}]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [rng (java.util.Random. (<span class="kw">long</span> seed))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        xs (<span class="kw">vec</span> (<span class="kw">repeatedly</span> n #(<span class="kw">*</span> <span class="fl">10.0</span> (.nextDouble rng))))</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        xs-final (<span class="kw">if</span> (<span class="kw">pos?</span> outlier-fraction)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">let</span> [out-rng (java.util.Random. (<span class="kw">+</span> (<span class="kw">long</span> seed) <span class="dv">7919</span>))]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">mapv</span> (<span class="kw">fn</span> [x]</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">if</span> (<span class="kw">&lt;</span> (.nextDouble out-rng) outlier-fraction)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">+</span> x (<span class="kw">*</span> (<span class="kw">double</span> outlier-scale) (.nextGaussian out-rng)))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                               x))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>                           xs))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                   xs)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        ys (<span class="kw">mapv</span> (<span class="kw">fn</span> [x] (<span class="kw">+</span> (<span class="kw">double</span> (f x))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">*</span> (<span class="kw">double</span> noise-sd) (.nextGaussian rng))))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                 xs)]</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (tc/dataset {<span class="at">:x</span> xs-final <span class="at">:y</span> ys})</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Splitting</strong>: <code>split-dataset</code> divides data into training and test sets. This is a cached step so the full provenance chain ‚Äî from parameters through data generation to the split ‚Äî is captured in the DAG.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> split-dataset</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Split a dataset into train/test using holdout."</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  [ds {<span class="at">:keys</span> [seed]}]</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">first</span> (tc/split-&gt;seq ds <span class="at">:holdout</span> {<span class="at">:seed</span> seed})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Feature engineering</strong>: <code>prepare-features</code> transforms raw data by adding derived columns. The choice of feature set is a key hyperparameter ‚Äî a linear model with only <code>:raw</code> features can‚Äôt learn nonlinear patterns, but <code>:trig</code> or <code>:poly+trig</code> features give it the building blocks it needs.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> prepare-features</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Add derived columns to a dataset according to `feature-set`.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Supported feature sets:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="st">  - `:raw`       ‚Äî no extra columns</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="st">  - `:quadratic` ‚Äî add x¬≤</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">  - `:trig`      ‚Äî add sin(x) and cos(x)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="st">  - `:poly+trig` ‚Äî add x¬≤, sin(x), and cos(x)"</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  [ds feature-set]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [x (<span class="at">:x</span> ds)]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (<span class="kw">case</span> feature-set</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">:raw</span> ds</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">:quadratic</span> (tc/add-columns ds {<span class="at">:x2</span> (tcc/sq x)})</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">:trig</span> (tc/add-columns ds {<span class="at">:sin-x</span> (tcc/sin x)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">:cos-x</span> (tcc/cos x)})</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">:poly</span>+trig (tc/add-columns ds {<span class="at">:x2</span> (tcc/sq x)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:sin-x</span> (tcc/sin x)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:cos-x</span> (tcc/cos x)}))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>Training and evaluation</strong>: <code>train-model</code> fits a model to prepared data, and <code>predict-and-rmse</code> measures how well it generalizes to unseen test data. These are thin wrappers around metamorph.ml ‚Äî the caching value comes from avoiding redundant retraining when only downstream parameters change.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> train-model</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Train a model on a dataset."</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  [train-ds model-spec]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  (ml/train train-ds model-spec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> predict-and-rmse</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Predict on test data and return RMSE."</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  [test-ds model]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [pred (ml/predict test-ds model)]</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    (loss/rmse (<span class="at">:y</span> test-ds) (<span class="at">:y</span> pred))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="ground-truth" class="level2">
<h2 class="anchored" data-anchor-id="ground-truth">Ground truth</h2>
<p>We need a function to predict. In real problems you don‚Äôt know the true relationship ‚Äî that‚Äôs what you‚Äôre trying to learn. Here we define it explicitly so we can measure how well our models do.</p>
<p>Our target is <span class="math inline">\(y = \sin(x) \cdot x\)</span> ‚Äî a wavy curve that grows with <span class="math inline">\(x\)</span>. A straight line can‚Äôt fit this shape, so a simple linear model will struggle unless we help it with better features.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nonlinear-fn</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"y = sin(x) ¬∑ x"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  [x]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">*</span> (Math/sin x) x))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="model-specifications" class="level2">
<h2 class="anchored" data-anchor-id="model-specifications">Model specifications</h2>
<p>We‚Äôll compare two fundamentally different algorithms:</p>
<p><strong>Linear model</strong> (<a href="https://en.wikipedia.org/wiki/Stochastic_gradient_descent">gradient descent</a>): Finds the best straight-line (or hyperplane) relationship between inputs and output. Simple and fast, but can only learn linear patterns. Needs good features.</p>
<p><strong>Decision tree</strong> (<a href="https://en.wikipedia.org/wiki/Decision_tree_learning">CART</a>): Learns by splitting data into regions based on thresholds (‚Äúif x &gt; 5, go left‚Äù). Can capture complex patterns automatically, but may <a href="https://en.wikipedia.org/wiki/Overfitting">overfit</a> noisy data.</p>
<p>These algorithms respond differently to feature engineering ‚Äî that contrast is the heart of Part 1.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> linear-sgd-spec</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"squared"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.objectives.SquaredLoss"</span>}</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                       {<span class="at">:name</span> <span class="st">"linear-sgd"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.linear.LinearSGDTrainer"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:objective</span> <span class="st">"squared"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:epochs</span> <span class="st">"50"</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:loggingInterval</span> <span class="st">"10000"</span>}}]</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"linear-sgd"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cart-spec</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="part-1-feature-engineering-matters-for-some-models" class="level2">
<h2 class="anchored" data-anchor-id="part-1-feature-engineering-matters-for-some-models">Part 1 ‚Äî Feature engineering matters (for some models)</h2>
<p><em>Feature engineering</em> means transforming raw inputs into forms that help models learn. For example, if the true relationship involves <span class="math inline">\(x^2\)</span>, adding a squared column gives the model that pattern directly instead of forcing it to discover it.</p>
<p>We‚Äôll test four feature sets:</p>
<ul>
<li><code>:raw</code> ‚Äî just the original <span class="math inline">\(x\)</span> value</li>
<li><code>:quadratic</code> ‚Äî add <span class="math inline">\(x^2\)</span></li>
<li><code>:trig</code> ‚Äî add <span class="math inline">\(\sin(x)\)</span> and <span class="math inline">\(\cos(x)\)</span></li>
<li><code>:poly+trig</code> ‚Äî add all three</li>
</ul>
<p>Crossed with two model types, that‚Äôs eight combinations. Every step is cached, so re-running is instant.</p>
<section id="generate-data" class="level3">
<h3 class="anchored" data-anchor-id="generate-data">Generate data</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> data-c</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">500</span> <span class="at">:noise-sd</span> <span class="fl">0.5</span> <span class="at">:seed</span> <span class="dv">42</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(tc/head (<span class="kw">deref</span> data-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.418 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.421 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/b4/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42})
</code></pre>
</div>
</div>
</div>
<div class="clay-dataset">
<p>_unnamed [5 2]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">:x</th>
<th style="text-align: right;">:y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">7.27563680</td>
<td style="text-align: right;">6.74555252</td>
</tr>
<tr class="even">
<td style="text-align: right;">6.83223472</td>
<td style="text-align: right;">4.07224915</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.08719455</td>
<td style="text-align: right;">0.22904859</td>
</tr>
<tr class="even">
<td style="text-align: right;">2.77078490</td>
<td style="text-align: right;">0.47163659</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6.65548952</td>
<td style="text-align: right;">2.81816258</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="split-into-train-and-test" class="level3">
<h3 class="anchored" data-anchor-id="split-into-train-and-test">Split into train and test</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> split-c</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'split-dataset</span> data-c {<span class="at">:seed</span> <span class="dv">42</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Extract train and test sets ‚Äî using keywords as cached functions. The DAG now traces from numerical parameters through data generation to the split to each subset.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-c </span>(pocket/cached <span class="at">:train</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-c </span>(pocket/cached <span class="at">:test</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="feature-sets" class="level3">
<h3 class="anchored" data-anchor-id="feature-sets">Feature sets</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> feature-sets </span>[<span class="at">:raw</span> <span class="at">:quadratic</span> <span class="at">:trig</span> <span class="at">:poly</span>+trig])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="prepare-features-cached" class="level3">
<h3 class="anchored" data-anchor-id="prepare-features-cached">Prepare features (cached)</h3>
<p>Each feature set applied to each split half is a separate cached computation ‚Äî eight in total.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> prepared</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">into</span> {}</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">for</span> [fs feature-sets</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>              [role ds-c] [[<span class="at">:train</span> train-c] [<span class="at">:test</span> test-c]]]</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>          [[fs role]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>           (pocket/cached <span class="va">#'prepare-features</span> ds-c fs)])))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="train-models-cached" class="level3">
<h3 class="anchored" data-anchor-id="train-models-cached">Train models (cached)</h3>
<p>Two models per feature set ‚Äî eight cached training runs.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> models</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">into</span> {}</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">for</span> [fs feature-sets</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>              [model-name spec] [[<span class="at">:sgd</span> linear-sgd-spec]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>                                 [<span class="at">:cart</span> cart-spec]]]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>          [[fs model-name]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>           (pocket/cached <span class="va">#'train-model</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>                          (prepared [fs <span class="at">:train</span>])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>                          spec)])))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> feature-results</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vec</span> (<span class="kw">for</span> [fs feature-sets</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>             [model-name _] [[<span class="at">:sgd</span> linear-sgd-spec]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>                             [<span class="at">:cart</span> cart-spec]]]</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>         {<span class="at">:feature-set</span> fs</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">:model</span> (<span class="kw">name</span> model-name)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">:rmse</span> (predict-and-rmse @(prepared [fs <span class="at">:test</span>])</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                                  @(models [fs model-name]))})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.437 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.437 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.437 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.440 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/e3/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})
21:44:04.441 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/23/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42}))
21:44:04.441 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/05/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :raw)
21:44:04.442 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.442 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.442 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.442 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/04/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42}))
21:44:04.443 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/79/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :raw)
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.501972,mean=0.840206,variance=15.440717})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 7.061050130878382
21:44:04.455 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/c6/c60324b3a114e8d5646efe7ec8bc1d78e743001b
21:44:04.458 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.466 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/1e/1e01826f37666f143cccc6e1883455eb2562ed2e
21:44:04.471 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.472 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/6d/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :quadratic)
21:44:04.472 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.473 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.473 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/06/0644c627bd9ef15c830deb29e333d06403c26a4f
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.501972,mean=0.840206,variance=15.440717})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 7.746488252108407
21:44:04.478 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/2f/2fdc6bcd8e2009e923d805ad1f2fdc52fc57948e
21:44:04.479 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.485 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/cc/cc330e34b3221a68d7bb7649e629ad6b645e4f47
21:44:04.487 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.488 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/98/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :trig)
21:44:04.488 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.488 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.489 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/9b/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :trig)
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.501972,mean=0.840206,variance=15.440717})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 0.9717267353378612
21:44:04.495 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/31/31897de14a3f45f4aaf19d0981053c5fb21403cb
21:44:04.496 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.504 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/04/04527115901fc961e204e50922811c525652d96d
21:44:04.505 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.507 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/99/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.5, :seed 42}) {:seed 42})) :poly+trig)
21:44:04.507 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.507 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.508 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/d7/d737f05eb6b2fdcaf7508a2f74277ea684a788ac
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.501972,mean=0.840206,variance=15.440717})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 1.5031022528715852
21:44:04.513 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/9a/9af00491ae43878968b94538ab45619c1c58f0d9
21:44:04.514 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.523 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/d1/d168df4bc60ad63e27c35709a7e8e2c6b8036407
</code></pre>
</div>
</div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>feature-results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>[{<span class="at">:feature-set</span> <span class="at">:raw</span>, <span class="at">:model</span> <span class="st">"sgd"</span>, <span class="at">:rmse</span> <span class="fl">3.6917759873191685</span>}</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:raw</span>, <span class="at">:model</span> <span class="st">"cart"</span>, <span class="at">:rmse</span> <span class="fl">0.6334615055076024</span>}</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:quadratic</span>, <span class="at">:model</span> <span class="st">"sgd"</span>, <span class="at">:rmse</span> <span class="fl">3.576999082640806</span>}</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:quadratic</span>, <span class="at">:model</span> <span class="st">"cart"</span>, <span class="at">:rmse</span> <span class="fl">0.6334615055076024</span>}</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:trig</span>, <span class="at">:model</span> <span class="st">"sgd"</span>, <span class="at">:rmse</span> <span class="fl">1.4577701415666355</span>}</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:trig</span>, <span class="at">:model</span> <span class="st">"cart"</span>, <span class="at">:rmse</span> <span class="fl">0.6805569759436894</span>}</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:poly</span>+trig, <span class="at">:model</span> <span class="st">"sgd"</span>, <span class="at">:rmse</span> <span class="fl">1.3410184469297421</span>}</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a> {<span class="at">:feature-set</span> <span class="at">:poly</span>+trig, <span class="at">:model</span> <span class="st">"cart"</span>, <span class="at">:rmse</span> <span class="fl">0.6805569759436894</span>}]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>What the results show</strong>:</p>
<p>The linear model (SGD) has high error with raw features ‚Äî it‚Äôs trying to draw a straight line through a wavy curve. But give it <span class="math inline">\(\sin(x)\)</span> and <span class="math inline">\(\cos(x)\)</span> as features, and it can combine them to approximate the true shape. Feature engineering saved the day.</p>
<p>The decision tree (CART) doesn‚Äôt care. It discovers the wavy pattern by splitting the data into regions. Extra features don‚Äôt help because the tree already found the structure.</p>
<p><strong>Takeaway</strong>: Some models need feature engineering; others don‚Äôt. Caching lets you explore both without waiting.</p>
</section>
<section id="predictions-plot" class="level3">
<h3 class="anchored" data-anchor-id="predictions-plot">Predictions plot</h3>
<p>Best linear model (poly+trig) vs best tree (raw) vs actual values.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> [test-ds @(prepared [<span class="at">:raw</span> <span class="at">:test</span>])</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>      sgd-pred (<span class="at">:y</span> (ml/predict @(prepared [<span class="at">:poly</span>+trig <span class="at">:test</span>])</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                               @(models [<span class="at">:poly</span>+trig <span class="at">:sgd</span>])))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>      cart-pred (<span class="at">:y</span> (ml/predict test-ds</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                                @(models [<span class="at">:raw</span> <span class="at">:cart</span>])))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>      xs (<span class="kw">vec</span> (<span class="at">:x</span> test-ds))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      actuals (<span class="kw">vec</span> (<span class="at">:y</span> test-ds))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      sgd-vals (<span class="kw">vec</span> sgd-pred)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      cart-vals (<span class="kw">vec</span> cart-pred)]</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  (kind/plotly</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:data</span> [{<span class="at">:x</span> xs <span class="at">:y</span> actuals <span class="at">:mode</span> <span class="st">"markers"</span> <span class="at">:name</span> <span class="st">"actual"</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">:marker</span> {<span class="at">:opacity</span> <span class="fl">0.3</span> <span class="at">:color</span> <span class="st">"gray"</span>}}</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>           {<span class="at">:x</span> xs <span class="at">:y</span> sgd-vals <span class="at">:mode</span> <span class="st">"markers"</span> <span class="at">:name</span> <span class="st">"Linear SGD (poly+trig)"</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">:marker</span> {<span class="at">:opacity</span> <span class="fl">0.5</span> <span class="at">:color</span> <span class="st">"steelblue"</span>}}</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>           {<span class="at">:x</span> xs <span class="at">:y</span> cart-vals <span class="at">:mode</span> <span class="st">"markers"</span> <span class="at">:name</span> <span class="st">"CART (raw)"</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>            <span class="at">:marker</span> {<span class="at">:opacity</span> <span class="fl">0.5</span> <span class="at">:color</span> <span class="st">"tomato"</span>}}]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">:layout</span> {<span class="at">:xaxis</span> {<span class="at">:title</span> <span class="st">"x"</span>} <span class="at">:yaxis</span> {<span class="at">:title</span> <span class="st">"y"</span>}}}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="height:auto;width:100%;"><script>Plotly.newPlot(document.currentScript.parentElement, [{"x":[9.162937751675898,2.881901760839064,2.8029174071568863,3.036869679733477,5.625339573387319,1.2625782329876534,0.3141823882658079,0.5860358422562673,4.957693996774556,8.374034326981022,2.6064300860884746,5.734770092968069,0.1093489625584243,2.9676876439370483,7.792026912116196,8.93395046645043,8.966972151731754,4.3649097442328655,9.133144945237442,6.556523970243689,1.601307542881809,8.338662354441658,7.275636800328681,5.887273230114029,5.472075167262199,3.938351824714422,2.8989223547759444,9.201028440830354,3.957662801712422,3.3651035217630296,1.9686130088289333,9.974363230557561,4.8057451655643435,3.62495704090968,3.6948638035875394,8.35155555007701,5.451525556016723,1.9614707188185154,3.4616984005044884,6.141067547923854,1.7737847790937833,7.671216444241212,6.655489517945736,6.758508485827457,0.96450915880824,2.0976756886633208,5.601439765052083,3.4475127143085924,2.2197071696876955,4.1885841914666555,6.134693220012867,9.033722646721783,1.2473332045964203,0.4099640693903672,5.735347186765608,3.7435935608900426,6.140948241989225,8.56539414935103,5.6675606560724745,5.648011661650246,2.916564974118041,3.6878291341130565,8.502834502384514,5.943499108896841,3.9095644194007653,4.97332761330185,6.00866554883861,7.754099185924646,1.387953919689331,1.7322564807356011,3.3896250975681763,8.204918233863467,9.674953220085111,5.182172329394712,1.8925476861992896,8.474594867482883,1.7927344087491737,5.8947450865696815,7.0545458753287305,8.053907199213823,1.6616716052142333,1.5865482876736248,7.7046563777394095,0.27314166285965835,3.7101228968376088,3.323242783847485,5.085783849855245,1.6081777232382255,7.829017787900358,1.4459146368031894,2.16418653353231,6.1621368503517875,4.144095098620818,5.148834062231381,1.1041335972159616,5.886407433150332,4.346035045905808,3.691214939418974,1.157501237196259,3.285599644454902,0.14055818452733182,7.034515012832663,0.2702986688213338,5.719031789035535,8.398659092547522,8.718145959648387,9.750075836495604,6.565124808212711,3.614706128921814,0.0629961707988913,6.64921516675779,9.826343569374401,7.455289570035387,6.832234717598454,6.89649109462087,5.563822013190519,5.863145983289133,8.788096664827789,8.336996010963523,8.976338235309475,1.424057611385977,9.622362202497229,5.192654911846663,6.645615310744589,6.436811749976528,5.960541733652932,9.855057258481155,9.633371279771417,5.053441079707084,5.617009436673657,3.8461105379950045,6.152138700739788,8.488935564489962,8.754894014526169,4.946157081511062,1.7701350179026742,0.3370946135386954,6.462319787976428,8.51110551751301,9.32938256811512,3.4026304867449375,9.487981214932969,0.05525250238970103,6.328697913532791,8.295956500501514,7.499061812554475,1.8478953614642224,4.5731709444476945,3.5885662535669116,2.6400242201489443,8.61737213352584,5.260779686454226,5.5087560369206905,5.3040288118184975,7.751206959271756,4.633992710283451,6.998586450671721,0.8503590739546585,7.0926371759746845,5.767354193796422,5.387186886615622,5.373939277251666,3.0871945533265976,9.88548992413256,4.2320168209085365,5.8742738178629565,3.3974710859425796],"y":[2.2660213549185735,0.0719121079533469,0.9089250478396278,0.8933324522986665,-2.3078226486154305,0.5423817085759718,0.3758883372038434,0.33877661328056724,-4.611384189553573,7.738577998933917,0.9284331474668519,-3.6075680351601287,-0.663542680920231,-0.3125819401998935,6.9396563938731175,3.0784465488271215,3.998867689031954,-3.6705311141875923,2.421042020267086,1.0028765919456402,1.7852680667874594,7.02172936037786,6.745552518168166,-2.1728688503639093,-4.524914807180175,-3.5838639123146345,1.3342517301172128,3.0402910919233963,-2.351691147288271,-0.987650214173812,2.3583226730035762,-5.309437979071366,-4.077585983913426,-2.561732227439665,-0.9479740558767714,7.727173653515657,-4.710513305544686,2.0013411073872005,-1.9190996146671055,-1.177297789983929,2.2511105620645737,7.392527679954239,2.818162580004899,2.810483468742886,0.5797844541227521,2.808853985694596,-3.978122195099813,-0.3950200207309057,1.919791883361562,-2.723653369698063,-0.9678294033861969,3.3227008320957045,1.14952923269556,-0.04453481203802759,-3.6742794320668306,-2.4531900801085786,0.08347885493701424,7.356602385978313,-3.008030249975363,-3.060277050948853,0.3031316657045395,-1.9807882334399314,6.030369248309518,-1.6058432729398926,-2.6614031623034253,-4.67024929755079,-1.667633881744998,7.953738363846955,1.3331722179542893,1.50197471059655,-0.455079887736399,8.498491854942527,-2.1568405996442563,-5.052505437293004,1.7111228279856978,7.250860569661639,2.0760613885834385,-1.7794109899930937,4.26227235474898,7.772972307742455,1.5495858163301786,1.6470230915486432,7.586867493488973,0.21634405871113452,-1.9411710834457483,-0.15414129448738628,-4.739397781252117,1.604441372858207,7.320035419570819,0.8687274269214117,2.4947812955613884,-1.1665649888703613,-3.3488922466504274,-4.996600506707139,0.9481471248763733,-2.309072523570158,-4.214356050948241,-1.4621917634971997,-0.030136944689879375,-0.5213420029473248,-0.8021515321179097,4.826732758840118,0.9359096066235159,-2.2509915198061785,6.929814554080055,5.222074404092475,-3.401845840324249,0.7759635311381319,-1.620574047129373,0.534843344125941,2.948957797201813,-3.6981412771770668,7.358982972630106,4.072249153030343,3.484413479495364,-4.169130323062806,-3.042076213988539,4.694043827544608,6.683635329552645,4.447483517409353,1.8964931045300562,-2.198555448084182,-3.711652787294194,2.584967593598159,1.0802115397316976,-2.0093559146377697,-4.015373115008884,-2.3644748494555503,-4.970229712183912,-2.6996797336096017,-2.975580928906157,-0.6692355447629877,6.38223883395862,5.57642776549492,-5.914919334251763,2.407000187536423,0.40158719433522067,1.8005515911759606,6.584583492307075,0.8545369148769743,-1.360292425689122,-1.276419255539152,-0.30162036254098845,0.8946486889116698,6.4405477343447375,6.612581322050381,1.9150359533853594,-4.909848498596979,-1.9379255016445183,1.053622394115376,6.008716108789697,-5.347652163814444,-4.165008466179719,-4.1104372520106045,6.6773488013931015,-4.571719519846841,4.773704738213836,1.0780876224362355,5.78615070031057,-2.5641627859906357,-5.63900950824857,-4.236172244896853,0.22904859105864095,-4.336064458534759,-3.5830483049464648,-1.8467645020387997,-0.31987248865713447],"mode":"markers","name":"actual","marker":{"opacity":0.3,"color":"gray"}},{"x":[9.162937751675898,2.881901760839064,2.8029174071568863,3.036869679733477,5.625339573387319,1.2625782329876534,0.3141823882658079,0.5860358422562673,4.957693996774556,8.374034326981022,2.6064300860884746,5.734770092968069,0.1093489625584243,2.9676876439370483,7.792026912116196,8.93395046645043,8.966972151731754,4.3649097442328655,9.133144945237442,6.556523970243689,1.601307542881809,8.338662354441658,7.275636800328681,5.887273230114029,5.472075167262199,3.938351824714422,2.8989223547759444,9.201028440830354,3.957662801712422,3.3651035217630296,1.9686130088289333,9.974363230557561,4.8057451655643435,3.62495704090968,3.6948638035875394,8.35155555007701,5.451525556016723,1.9614707188185154,3.4616984005044884,6.141067547923854,1.7737847790937833,7.671216444241212,6.655489517945736,6.758508485827457,0.96450915880824,2.0976756886633208,5.601439765052083,3.4475127143085924,2.2197071696876955,4.1885841914666555,6.134693220012867,9.033722646721783,1.2473332045964203,0.4099640693903672,5.735347186765608,3.7435935608900426,6.140948241989225,8.56539414935103,5.6675606560724745,5.648011661650246,2.916564974118041,3.6878291341130565,8.502834502384514,5.943499108896841,3.9095644194007653,4.97332761330185,6.00866554883861,7.754099185924646,1.387953919689331,1.7322564807356011,3.3896250975681763,8.204918233863467,9.674953220085111,5.182172329394712,1.8925476861992896,8.474594867482883,1.7927344087491737,5.8947450865696815,7.0545458753287305,8.053907199213823,1.6616716052142333,1.5865482876736248,7.7046563777394095,0.27314166285965835,3.7101228968376088,3.323242783847485,5.085783849855245,1.6081777232382255,7.829017787900358,1.4459146368031894,2.16418653353231,6.1621368503517875,4.144095098620818,5.148834062231381,1.1041335972159616,5.886407433150332,4.346035045905808,3.691214939418974,1.157501237196259,3.285599644454902,0.14055818452733182,7.034515012832663,0.2702986688213338,5.719031789035535,8.398659092547522,8.718145959648387,9.750075836495604,6.565124808212711,3.614706128921814,0.0629961707988913,6.64921516675779,9.826343569374401,7.455289570035387,6.832234717598454,6.89649109462087,5.563822013190519,5.863145983289133,8.788096664827789,8.336996010963523,8.976338235309475,1.424057611385977,9.622362202497229,5.192654911846663,6.645615310744589,6.436811749976528,5.960541733652932,9.855057258481155,9.633371279771417,5.053441079707084,5.617009436673657,3.8461105379950045,6.152138700739788,8.488935564489962,8.754894014526169,4.946157081511062,1.7701350179026742,0.3370946135386954,6.462319787976428,8.51110551751301,9.32938256811512,3.4026304867449375,9.487981214932969,0.05525250238970103,6.328697913532791,8.295956500501514,7.499061812554475,1.8478953614642224,4.5731709444476945,3.5885662535669116,2.6400242201489443,8.61737213352584,5.260779686454226,5.5087560369206905,5.3040288118184975,7.751206959271756,4.633992710283451,6.998586450671721,0.8503590739546585,7.0926371759746845,5.767354193796422,5.387186886615622,5.373939277251666,3.0871945533265976,9.88548992413256,4.2320168209085365,5.8742738178629565,3.3974710859425796],"y":[2.6418483762505636,0.8131898556637047,1.1496488419427084,0.12270879245540289,-2.5987411478520452,2.6455419298252236,-2.241979471986519,-0.5132117567800236,-4.7250407181580325,6.053848700407769,1.9214334559748538,-2.0811327146776457,-3.631484883655976,0.43506526333088047,6.703937923267417,3.851440574037203,3.68522040267131,-4.7591355538525715,2.8059339288625917,2.4391380333689225,3.369986449959989,6.145681941081091,5.718264374033496,-1.3043197320498807,-3.255609683770914,-3.7252947392036675,0.7391198956802159,2.4297278121027324,-3.7881833326566596,-1.3926375606842143,3.4285930605543884,-1.9700315641271198,-4.909012771564857,-2.5406334412251317,-2.8283603157034136,6.112946487827853,-3.3369705224086803,3.4345223652717793,-1.8306828676580609,0.08870263935812961,3.4910738218701853,6.60148427810292,2.9765475055516832,3.5153681787409328,1.5036193845633665,3.275456801661587,-2.7066833899683997,-1.7670095429269344,3.0536348398142916,-4.427556496498211,0.052720808839085365,3.340059801679393,2.5981311472463204,-1.613487623124946,-2.0783075315341053,-3.0218173170692966,0.08802887735796716,5.450698356710425,-2.4034455570388795,-2.494587105127247,0.6618175980850483,-2.7999306951421774,5.6669990715613805,-1.0045625238318072,-3.6290865637372516,-4.699291535157197,-0.6499315689111462,6.680568098778367,2.987878823828166,3.477244953679568,-1.5047421559650513,6.434070636132158,-0.3109671018161686,-4.236879324598242,3.477670114704976,5.7586839636542555,3.4941769057899092,-1.2648519598653176,4.898241514763282,6.643546477636931,3.4314731776559055,3.3518136704448436,6.637995718083627,-2.516235858155637,-2.889601425501734,-1.2001887087727043,-4.477311056135065,3.3780248467503196,6.718924298705384,3.116944959444549,3.1635238727367065,0.20785880804223922,-4.321541215747252,-4.325163260924626,2.0936413873349267,-1.3088854220648911,-4.730662338130363,-2.8136292462049663,2.2939664257524868,-1.0262518620376726,-3.417076932493367,4.814038733864472,-2.5353291830367213,-2.1578116487400343,5.986184031881884,4.850725061019163,-0.7407260615451543,2.486481895629387,-2.4975170572481638,-3.9509019559144725,2.942997068422917,-1.16925430626877,6.219375859752209,3.8850358190193512,4.194630425354597,-2.8725975435655404,-1.4309455934837638,4.544707920485213,6.149850595840232,3.637510205060993,3.070468670477376,-0.006788275504775676,-4.208017582279361,2.9237131910304717,1.7705261055568213,-0.9125142030163755,-1.3280863171455577,-0.0706416314858247,-4.547706673511709,-2.6365823658924596,-3.4070732834931166,0.15127371130457234,5.712595220977396,4.692257355435175,-4.743233098244957,3.49024577786604,-2.0900683953091574,1.91428043550654,5.639435901923858,1.699355915156615,-1.5639749614649396,0.7769488360788186,-4.004344345825988,1.1564690601793641,6.247991431930296,6.316884592572248,3.491844928881279,-4.955345311852014,-2.386582279477299,1.7971579943383489,5.257626196319127,-4.007830517302736,-3.1062826623674247,-3.869639175629755,6.678454393596263,-4.970677744917518,4.659248083313936,0.9549049669546568,5.054081733700943,-1.9201577680291058,-3.5806483811158047,-3.62868535506208,-0.10756358173632652,-1.4947249447772206,-4.522594948232012,-1.3727017253998577,-1.5404962780681597],"mode":"markers","name":"Linear SGD (poly+trig)","marker":{"opacity":0.5,"color":"steelblue"}},{"x":[9.162937751675898,2.881901760839064,2.8029174071568863,3.036869679733477,5.625339573387319,1.2625782329876534,0.3141823882658079,0.5860358422562673,4.957693996774556,8.374034326981022,2.6064300860884746,5.734770092968069,0.1093489625584243,2.9676876439370483,7.792026912116196,8.93395046645043,8.966972151731754,4.3649097442328655,9.133144945237442,6.556523970243689,1.601307542881809,8.338662354441658,7.275636800328681,5.887273230114029,5.472075167262199,3.938351824714422,2.8989223547759444,9.201028440830354,3.957662801712422,3.3651035217630296,1.9686130088289333,9.974363230557561,4.8057451655643435,3.62495704090968,3.6948638035875394,8.35155555007701,5.451525556016723,1.9614707188185154,3.4616984005044884,6.141067547923854,1.7737847790937833,7.671216444241212,6.655489517945736,6.758508485827457,0.96450915880824,2.0976756886633208,5.601439765052083,3.4475127143085924,2.2197071696876955,4.1885841914666555,6.134693220012867,9.033722646721783,1.2473332045964203,0.4099640693903672,5.735347186765608,3.7435935608900426,6.140948241989225,8.56539414935103,5.6675606560724745,5.648011661650246,2.916564974118041,3.6878291341130565,8.502834502384514,5.943499108896841,3.9095644194007653,4.97332761330185,6.00866554883861,7.754099185924646,1.387953919689331,1.7322564807356011,3.3896250975681763,8.204918233863467,9.674953220085111,5.182172329394712,1.8925476861992896,8.474594867482883,1.7927344087491737,5.8947450865696815,7.0545458753287305,8.053907199213823,1.6616716052142333,1.5865482876736248,7.7046563777394095,0.27314166285965835,3.7101228968376088,3.323242783847485,5.085783849855245,1.6081777232382255,7.829017787900358,1.4459146368031894,2.16418653353231,6.1621368503517875,4.144095098620818,5.148834062231381,1.1041335972159616,5.886407433150332,4.346035045905808,3.691214939418974,1.157501237196259,3.285599644454902,0.14055818452733182,7.034515012832663,0.2702986688213338,5.719031789035535,8.398659092547522,8.718145959648387,9.750075836495604,6.565124808212711,3.614706128921814,0.0629961707988913,6.64921516675779,9.826343569374401,7.455289570035387,6.832234717598454,6.89649109462087,5.563822013190519,5.863145983289133,8.788096664827789,8.336996010963523,8.976338235309475,1.424057611385977,9.622362202497229,5.192654911846663,6.645615310744589,6.436811749976528,5.960541733652932,9.855057258481155,9.633371279771417,5.053441079707084,5.617009436673657,3.8461105379950045,6.152138700739788,8.488935564489962,8.754894014526169,4.946157081511062,1.7701350179026742,0.3370946135386954,6.462319787976428,8.51110551751301,9.32938256811512,3.4026304867449375,9.487981214932969,0.05525250238970103,6.328697913532791,8.295956500501514,7.499061812554475,1.8478953614642224,4.5731709444476945,3.5885662535669116,2.6400242201489443,8.61737213352584,5.260779686454226,5.5087560369206905,5.3040288118184975,7.751206959271756,4.633992710283451,6.998586450671721,0.8503590739546585,7.0926371759746845,5.767354193796422,5.387186886615622,5.373939277251666,3.0871945533265976,9.88548992413256,4.2320168209085365,5.8742738178629565,3.3974710859425796],"y":[2.0494627555211387,0.920036643743515,1.2817705869674683,-0.03710518404841423,-3.5514585177103677,1.076704098118676,-0.45550280809402466,-0.014642383903265,-4.545772535460336,7.450884461402892,1.537168187754495,-3.5394774675369263,-0.15743271040264517,0.920036643743515,7.893579938194968,4.465291500091553,3.9001137614250183,-4.545772535460336,2.0494627555211387,1.7209413647651672,1.856018982150338,7.450884461402892,5.816326300303142,-2.0323322415351868,-3.910042476654053,-2.6137142521994456,0.920036643743515,2.378809849421183,-2.6137142521994456,-0.32726822296778363,1.856018982150338,-5.029242833455403,-4.545772535460336,-1.8873282074928284,-1.8873282074928284,7.450884461402892,-3.910042476654053,1.856018982150338,-1.4506986141204834,-0.677547832330068,1.856018982150338,7.893579938194968,1.8940662542978923,3.2319266200065613,2.1714389324188232,1.856018982150338,-3.5514585177103677,-1.4506986141204834,1.856018982150338,-3.3673548221588137,-0.677547832330068,2.8883135318756104,1.076704098118676,0.7029594331979752,-3.5394774675369263,-2.8382390340169272,-0.677547832330068,5.884231431143624,-3.5514585177103677,-3.5514585177103677,0.920036643743515,-1.8873282074928284,6.301878452301025,-1.619015653928121,-2.6137142521994456,-4.545772535460336,-2.236023426055908,7.893579938194968,1.611088607992445,1.856018982150338,-0.32726822296778363,7.450884461402892,-3.0457497437795005,-4.545772535460336,1.856018982150338,6.301878452301025,1.856018982150338,-2.0323322415351868,4.459895610809326,7.893579938194968,1.856018982150338,1.856018982150338,7.893579938194968,0.13135595619678497,-1.8873282074928284,-0.1268192157149315,-4.545772535460336,1.856018982150338,7.893579938194968,1.611088607992445,1.856018982150338,-0.677547832330068,-3.3673548221588137,-4.545772535460336,1.076704098118676,-2.0323322415351868,-3.691183090209961,-1.8873282074928284,1.076704098118676,-0.1268192157149315,-0.15743271040264517,4.459895610809326,0.13135595619678497,-2.6570186614990234,7.450884461402892,5.884231431143624,-2.999164640903473,1.7209413647651672,-1.8873282074928284,0.06356617125372091,1.8940662542978923,-3.590810537338257,6.62187623977661,4.049823919932048,3.8282152811686196,-3.5514585177103677,-2.0323322415351868,5.884231431143624,7.450884461402892,3.9001137614250183,1.611088607992445,-1.5354740222295125,-4.545772535460336,1.8940662542978923,1.5193911790847778,-1.619015653928121,-3.590810537338257,-1.5354740222295125,-4.545772535460336,-3.5514585177103677,-2.058987617492676,-0.677547832330068,6.301878452301025,5.884231431143624,-4.545772535460336,1.856018982150338,0.7029594331979752,1.5193911790847778,5.884231431143624,0.8281522492567698,-0.32726822296778363,-0.2012165393680334,0.06356617125372091,0.9580957293510437,7.450884461402892,7.159455871582031,1.856018982150338,-4.545772535460336,-1.4506986141204834,1.537168187754495,5.884231431143624,-4.545772535460336,-3.5514585177103677,-4.545772535460336,7.893579938194968,-4.545772535460336,5.13687002658844,0.4476439654827118,5.4917826652526855,-2.681432843208313,-3.910042476654053,-5.45878791809082,-0.6944498121738434,-3.590810537338257,-3.039973258972168,-2.0323322415351868,-0.32726822296778363],"mode":"markers","name":"CART (raw)","marker":{"opacity":0.5,"color":"tomato"}}], {"xaxis":{"title":"x"},"yaxis":{"title":"y"}}, {});</script></div>
<hr>
</section>
</section>
<section id="part-2-how-models-handle-noisy-data" class="level2">
<h2 class="anchored" data-anchor-id="part-2-how-models-handle-noisy-data">Part 2 ‚Äî How models handle noisy data</h2>
<p>Real data is messy. Measurements have errors, inputs are approximate. <em>Noise</em> is the random variation that obscures the true pattern.</p>
<p>How do our models behave as noise increases? We‚Äôll test five levels, from nearly clean (0.1) to very noisy (5.0).</p>
<p>Notice: the noise=0.5 dataset reuses the cache from Part 1 ‚Äî Pocket recognizes the same function and arguments.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> noise-levels </span>[<span class="fl">0.1</span> <span class="fl">0.5</span> <span class="fl">1.0</span> <span class="fl">2.0</span> <span class="fl">5.0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> noise-results</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vec</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">for</span> [noise-sd noise-levels]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>     (<span class="kw">let</span> [data-c (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                                 {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">500</span> <span class="at">:noise-sd</span> noise-sd <span class="at">:seed</span> <span class="dv">42</span>})</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>           split-c (pocket/cached <span class="va">#'split-dataset</span> data-c {<span class="at">:seed</span> <span class="dv">42</span>})</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>           train-c (pocket/cached <span class="at">:train</span> split-c)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>           test-c (pocket/cached <span class="at">:test</span> split-c)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>           cart-train (pocket/cached <span class="va">#'prepare-features</span> train-c <span class="at">:raw</span>)</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>           cart-test (pocket/cached <span class="va">#'prepare-features</span> test-c <span class="at">:raw</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>           sgd-train (pocket/cached <span class="va">#'prepare-features</span> train-c <span class="at">:poly</span>+trig)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>           sgd-test (pocket/cached <span class="va">#'prepare-features</span> test-c <span class="at">:poly</span>+trig)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>           cart-model (pocket/cached <span class="va">#'train-model</span> cart-train cart-spec)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>           sgd-model (pocket/cached <span class="va">#'train-model</span> sgd-train linear-sgd-spec)]</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>       {<span class="at">:noise-sd</span> noise-sd</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">:cart-rmse</span> (predict-and-rmse <span class="at">@cart-test</span> <span class="at">@cart-model</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">:sgd-rmse</span> (predict-and-rmse <span class="at">@sgd-test</span> <span class="at">@sgd-model</span>)}))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.535 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.535 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.535 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.535 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.536 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/6a/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42})
21:44:04.538 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/3a/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42})
21:44:04.538 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/94/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42}))
21:44:04.539 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/96/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42})) :raw)
21:44:04.539 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.539 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.539 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.540 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/55/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42}))
21:44:04.540 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/08/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42})) :raw)
21:44:04.545 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/b8/b852ace3759232f1dec48d3e01572a918e9e31e6
21:44:04.546 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.548 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/dd/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 0.1, :seed 42}) {:seed 42})) :poly+trig)
21:44:04.548 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.548 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.549 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/bc/bcc1185d8c044fe468f72f058191a99f73c4ea91
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.106624,min=-5.332393,mean=0.805881,variance=15.304966})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 1.4235088958624642
21:44:04.554 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/82/82fcdba4291961e398a2dabf02049538d45de7ff
21:44:04.557 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.557 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.557 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.557 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.558 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/53/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42})
21:44:04.559 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/68/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42})
21:44:04.560 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/85/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42}))
21:44:04.560 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/d1/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42})) :raw)
21:44:04.560 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.560 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.560 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.561 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/62/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42}))
21:44:04.562 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/ac/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42})) :raw)
21:44:04.566 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/56/56b12a0b688bc09e6b02b1079e0b3db9e27780bb
21:44:04.567 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.568 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/3d/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 1.0, :seed 42}) {:seed 42})) :poly+trig)
21:44:04.569 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.569 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.570 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/21/2138858cf3d145d3b1dda31f1fbff57c42021903
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=9.816940,min=-6.625413,mean=0.883112,variance=15.979208})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 1.8153008504655874
21:44:04.577 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/af/afcc6439d95dc6b19a47d7bb13b405a6e3f7bf75
21:44:04.578 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.578 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.578 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.578 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.579 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/1f/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42})
21:44:04.581 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/ec/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42})
21:44:04.582 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/a2/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42}))
21:44:04.583 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/b0/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42})) :raw)
21:44:04.583 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.583 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.583 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.584 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/be/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42}))
21:44:04.585 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/d8/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42})) :raw)
21:44:04.592 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/42/4283017d384a0edb1360ed439ce2022cded0120a
21:44:04.593 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.595 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/9a/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 2.0, :seed 42}) {:seed 42})) :poly+trig)
21:44:04.595 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.595 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.596 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/c5/c596cf0eff32ed864e9956ede9b9f1a8ba604d8a
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=11.717291,min=-8.958664,mean=0.968924,variance=18.285525})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.123027977933463
21:44:04.604 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/e7/e73082ba807aa7585ee9bfe055500e1478428bfb
21:44:04.605 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.606 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.606 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.606 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.607 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/16/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42})
21:44:04.609 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/33/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42})
21:44:04.609 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/f6/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42}))
21:44:04.610 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/1d/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42})) :raw)
21:44:04.610 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.610 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.610 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.612 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/b2/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42}))
21:44:04.613 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/c0/(pocket-book.ml-workflows_prepare-features (:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42})) :raw)
21:44:04.619 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/41/4125ad81cf3bdb18d7b227f84c899e30d5692f27
21:44:04.620 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.621 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/2a/(pocket-book.ml-workflows_prepare-features (:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 500, :noise-sd 5.0, :seed 42}) {:seed 42})) :poly+trig)
21:44:04.621 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.622 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/prepare-features
21:44:04.622 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/2a/2ab54b2e292bd3cd5f65f72be9ddd1b0a17c3de8
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=17.418345,min=-15.958416,mean=1.226360,variance=35.039175})
Feb 08, 2026 9:44:04 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 12.1030268449752
21:44:04.629 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/53/533425c770f1d0b6600c387d76730e7b41036713
</code></pre>
</div>
</div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>noise-results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>[{<span class="at">:noise-sd</span> <span class="fl">0.1</span>,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">:cart-rmse</span> <span class="fl">0.18813079748027944</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">:sgd-rmse</span> <span class="fl">1.2744431229599325</span>}</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a> {<span class="at">:noise-sd</span> <span class="fl">0.5</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">:cart-rmse</span> <span class="fl">0.6334615055076024</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">:sgd-rmse</span> <span class="fl">1.3410184469297421</span>}</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a> {<span class="at">:noise-sd</span> <span class="fl">1.0</span>,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">:cart-rmse</span> <span class="fl">1.2499664669902657</span>,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">:sgd-rmse</span> <span class="fl">1.582298583473656</span>}</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a> {<span class="at">:noise-sd</span> <span class="fl">2.0</span>,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">:cart-rmse</span> <span class="fl">2.453719422103725</span>,</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">:sgd-rmse</span> <span class="fl">2.352662287937308</span>}</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a> {<span class="at">:noise-sd</span> <span class="fl">5.0</span>,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">:cart-rmse</span> <span class="fl">5.960858808406107</span>,</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">:sgd-rmse</span> <span class="fl">5.262029923696976</span>}]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong>What the results show</strong>:</p>
<p>At low noise, the tree wins ‚Äî it captures fine details the linear model smooths over. But as noise increases, the tree starts memorizing random wiggles (<em>overfitting</em>), and its error explodes.</p>
<p>The linear model degrades more gracefully. Its rigid structure (a weighted sum of features) acts as a built-in <a href="https://en.wikipedia.org/wiki/Regularization_(mathematics)">regularizer</a> ‚Äî it can‚Äôt chase noise even if it wanted to.</p>
<p><strong>Takeaway</strong>: Flexible models (trees) excel with clean data but suffer with noise. Simple models (linear) are more robust.</p>
<section id="rmse-vs.-noise" class="level3">
<h3 class="anchored" data-anchor-id="rmse-vs.-noise"><a href="https://en.wikipedia.org/wiki/Root_mean_square_deviation">RMSE</a> vs.&nbsp;noise</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> [noise-sds (<span class="kw">vec</span> (<span class="kw">map</span> <span class="at">:noise-sd</span> noise-results))</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>      cart-rmses (<span class="kw">vec</span> (<span class="kw">map</span> <span class="at">:cart-rmse</span> noise-results))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>      sgd-rmses (<span class="kw">vec</span> (<span class="kw">map</span> <span class="at">:sgd-rmse</span> noise-results))]</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  (kind/plotly</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:data</span> [{<span class="at">:x</span> noise-sds <span class="at">:y</span> cart-rmses <span class="at">:mode</span> <span class="st">"lines+markers"</span> <span class="at">:name</span> <span class="st">"CART"</span>}</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>           {<span class="at">:x</span> noise-sds <span class="at">:y</span> sgd-rmses <span class="at">:mode</span> <span class="st">"lines+markers"</span> <span class="at">:name</span> <span class="st">"Linear SGD"</span>}]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">:layout</span> {<span class="at">:xaxis</span> {<span class="at">:title</span> <span class="st">"noise-sd"</span>} <span class="at">:yaxis</span> {<span class="at">:title</span> <span class="st">"rmse"</span>}}}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="height:auto;width:100%;"><script>Plotly.newPlot(document.currentScript.parentElement, [{"x":[0.1,0.5,1.0,2.0,5.0],"y":[0.18813079748027944,0.6334615055076024,1.2499664669902657,2.453719422103725,5.960858808406107],"mode":"lines+markers","name":"CART"},{"x":[0.1,0.5,1.0,2.0,5.0],"y":[1.2744431229599325,1.3410184469297421,1.582298583473656,2.352662287937308,5.262029923696976],"mode":"lines+markers","name":"Linear SGD"}], {"xaxis":{"title":"noise-sd"},"yaxis":{"title":"rmse"}}, {});</script></div>
<hr>
</section>
</section>
<section id="part-3-what-got-cached" class="level2">
<h2 class="anchored" data-anchor-id="part-3-what-got-cached">Part 3 ‚Äî What got cached?</h2>
<p>We‚Äôve run many combinations of data, features, and models. Each <code>pocket/cached</code> call created an independent cache entry. Let‚Äôs see what we accumulated:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">:total-entries</span> (pocket/cache-stats))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="dv">60</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(<span class="at">:entries-per-fn</span> (pocket/cache-stats))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"pocket-book.ml-workflows/train-model"</span> <span class="dv">16</span>,</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a> <span class="st">"pocket-book.ml-workflows/prepare-features"</span> <span class="dv">24</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a> <span class="st">"pocket-book.ml-workflows/make-regression-data"</span> <span class="dv">5</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a> <span class="st">":test"</span> <span class="dv">5</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a> <span class="st">":train"</span> <span class="dv">5</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a> <span class="st">"pocket-book.ml-workflows/split-dataset"</span> <span class="dv">5</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With this small synthetic data, each step runs in milliseconds. But the <em>structure</em> is what matters. In real workflows ‚Äî large datasets, deep neural networks, hyperparameter searches ‚Äî the same cache graph saves hours or days.</p>
<p>Here‚Äôs what happens when you change something:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 54%">
<col style="width: 45%">
</colgroup>
<thead>
<tr class="header">
<th>Change</th>
<th>What recomputes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Edit a feature set</td>
<td>That feature prep + its models</td>
</tr>
<tr class="even">
<td>Change a model hyperparameter</td>
<td>Only that model</td>
</tr>
<tr class="odd">
<td>Change the noise level</td>
<td>That data + its features + its models</td>
</tr>
<tr class="even">
<td>Re-run the whole notebook</td>
<td>Nothing ‚Äî all cached</td>
</tr>
</tbody>
</table>
</section>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">Cleanup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.653 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-regression
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-regression"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="part-4-sharing-computations-across-branches" class="level2">
<h2 class="anchored" data-anchor-id="part-4-sharing-computations-across-branches">Part 4 ‚Äî Sharing computations across branches</h2>
<p>Real sensors glitch. A positioning system occasionally records a wildly wrong x value ‚Äî the physics (y) is unaffected, but the recorded input is corrupted. When we build polynomial features like x¬≤, these outlier x values get amplified: an errant x=50 gives x¬≤=2500 instead of the expected ~25 from a normal x‚âà5.</p>
<p>The fix is <em>feature outlier clipping</em>: compute what range of x is ‚Äúnormal‚Äù from training data, then clip both train and test inputs to those bounds ‚Äî <strong>before</strong> feature engineering.</p>
<p>The clipping threshold <strong>must</strong> come from training data alone. Using test data would leak future information.</p>
<p>This creates a <em>diamond dependency</em> ‚Äî one computation (the threshold) feeds into multiple downstream steps:</p>
<pre><code> make-regression-data (with x outliers)
         |
    split-dataset
         |
    +----+----+
    v         v
 (:train)  (:test)
    |         |
    v         |
fit-threshold |
    |         |
    +----+----+
    v         v
clip(train) clip(test)
    |         |
    v         v
features   features
    |         |
    v         |
train-model   |
    |         |
    +----+----+
    v
  evaluate</code></pre>
<p>Pocket handles this naturally. The threshold node is computed once and feeds both clipping steps. When you change the training data, the threshold recomputes, and both branches update.</p>
<section id="pipeline-functions-1" class="level3">
<h3 class="anchored" data-anchor-id="pipeline-functions-1">Pipeline functions</h3>
<p>These are plain functions. Each does one thing: fit a threshold, clip outliers, or evaluate. Pocket will wire them together.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> fit-outlier-threshold</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute IQR-based clipping bounds for :x from training data.</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Returns {:lower &lt;bound&gt; :upper &lt;bound&gt;}."</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  [train-ds]</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">println</span> <span class="st">"  Fitting outlier threshold from training data..."</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [xs (<span class="kw">sort</span> (<span class="kw">vec</span> (<span class="at">:x</span> train-ds)))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        n (<span class="kw">count</span> xs)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        q1 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.25</span> n)))</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        q3 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.75</span> n)))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        iqr (<span class="kw">-</span> q3 q1)]</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:lower</span> (<span class="kw">-</span> q1 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>     <span class="at">:upper</span> (<span class="kw">+</span> q3 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> clip-outliers</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Clip :x values using pre-computed threshold bounds."</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  [ds threshold]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">println</span> <span class="st">"  Clipping outliers with bounds:"</span> (<span class="kw">select-keys</span> threshold [<span class="at">:lower</span> <span class="at">:upper</span>]))</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [{<span class="at">:keys</span> [lower upper]} threshold]</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    (tc/add-column ds <span class="at">:x</span> (<span class="kw">-&gt;</span> (<span class="at">:x</span> ds) (tcc/max lower) (tcc/min upper)))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> evaluate-model</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Evaluate a model on test data."</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  [test-ds model]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">println</span> <span class="st">"  Evaluating model..."</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [pred (ml/predict test-ds model)]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:rmse</span> (loss/rmse (<span class="at">:y</span> test-ds) (<span class="at">:y</span> pred))}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="build-the-dag-with-mixed-storage-policies" class="level3">
<h3 class="anchored" data-anchor-id="build-the-dag-with-mixed-storage-policies">Build the DAG with mixed storage policies</h3>
<p>Not every step needs disk persistence. We use <code>caching-fn</code> with per-function storage policies:</p>
<ul>
<li><p><strong><code>:mem</code></strong> for cheap shared computations (threshold, clipping, feature engineering) ‚Äî no disk I/O, but in-memory dedup ensures each runs only once persists across JVM sessions</p></li>
<li><p><strong><code>:none</code></strong> for trivial steps (evaluation) ‚Äî just tracks identity in the DAG without any shared caching</p></li>
</ul>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-fit-threshold</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'fit-outlier-threshold</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-clip</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'clip-outliers</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-prepare</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'prepare-features</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-train</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'train-model</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-evaluate</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'evaluate-model</span> {<span class="at">:storage</span> <span class="at">:none</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Generate data <em>with outliers</em> for this demo ‚Äî 10% of the x values are corrupted by large random spikes, simulating sensor glitches. The y values (physics) are computed from the clean x, then noise is added normally ‚Äî so only the input is corrupted.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> dag-data-c</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">200</span> <span class="at">:noise-sd</span> <span class="fl">0.3</span> <span class="at">:seed</span> <span class="dv">99</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:outlier-fraction</span> <span class="fl">0.1</span> <span class="at">:outlier-scale</span> <span class="dv">15</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> dag-split-c</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'split-dataset</span> dag-data-c {<span class="at">:seed</span> <span class="dv">99</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> dag-train-c </span>(pocket/cached <span class="at">:train</span> dag-split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> dag-test-c </span>(pocket/cached <span class="at">:test</span> dag-split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now wire the pipeline. The threshold is fitted once from training data (in memory) and feeds both clipping steps ‚Äî a diamond dependency handled naturally.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> threshold-c</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  (c-fit-threshold dag-train-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-clipped-c</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  (c-clip dag-train-c threshold-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-clipped-c</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  (c-clip dag-test-c threshold-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-prepped-c</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  (c-prepare train-clipped-c <span class="at">:poly</span>+trig))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-prepped-c</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  (c-prepare test-clipped-c <span class="at">:poly</span>+trig))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> model-c</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  (c-train train-prepped-c cart-spec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> metrics-c</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  (c-evaluate test-prepped-c model-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="visualize-the-dag" class="level3">
<h3 class="anchored" data-anchor-id="visualize-the-dag">Visualize the DAG</h3>
<p>Pocket provides three functions for DAG introspection, each suited to different use cases.</p>
<p><strong><code>origin-story</code></strong> returns a nested tree structure. Each cached node has <code>:fn</code>, <code>:args</code>, and <code>:id</code>. The <code>:id</code> is unique; when the same <code>Cached</code> instance appears multiple times (diamond pattern), subsequent occurrences become <code>{:ref &lt;id&gt;}</code> pointers. This avoids infinite recursion and makes the diamond explicit:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story metrics-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/evaluate-model,</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a> <span class="at">:args</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a> [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/prepare-features,</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>   <span class="at">:args</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>   [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/clip-outliers,</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">:args</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>     [{<span class="at">:fn</span> <span class="at">:test</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">:args</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>       [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/split-dataset,</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">:args</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>         [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/make-regression-data,</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">:args</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>           [{<span class="at">:value</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>             {<span class="at">:f</span> <span class="va">#'pocket-book.ml-workflows/nonlinear-fn,</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>              <span class="at">:n</span> <span class="dv">200</span>,</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">:noise-sd</span> <span class="fl">0.3</span>,</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">:seed</span> <span class="dv">99</span>,</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>              <span class="at">:outlier-fraction</span> <span class="fl">0.1</span>,</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>              <span class="at">:outlier-scale</span> <span class="dv">15</span>}}],</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>           <span class="at">:id</span> <span class="st">"c6"</span>}</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>          {<span class="at">:value</span> {<span class="at">:seed</span> <span class="dv">99</span>}}],</span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">:id</span> <span class="st">"c5"</span>}],</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">:id</span> <span class="st">"c4"</span>}</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>      {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/fit-outlier-threshold,</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">:args</span> [{<span class="at">:fn</span> <span class="at">:train</span>, <span class="at">:args</span> [{<span class="at">:ref</span> <span class="st">"c5"</span>}], <span class="at">:id</span> <span class="st">"c8"</span>}],</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>       <span class="at">:id</span> <span class="st">"c7"</span>}],</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>     <span class="at">:id</span> <span class="st">"c3"</span>}</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:value</span> <span class="at">:poly</span>+trig}],</span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a>   <span class="at">:id</span> <span class="st">"c2"</span>}</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/train-model,</span></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>   <span class="at">:args</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>   [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/prepare-features,</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>     <span class="at">:args</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>     [{<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/clip-outliers,</span></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">:args</span> [{<span class="at">:ref</span> <span class="st">"c8"</span>} {<span class="at">:ref</span> <span class="st">"c7"</span>}],</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">:id</span> <span class="st">"c11"</span>}</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a>      {<span class="at">:value</span> <span class="at">:poly</span>+trig}],</span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a>     <span class="at">:id</span> <span class="st">"c10"</span>}</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:value</span></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a>     {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span>,</span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">:tribuo-components</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>      [{<span class="at">:name</span> <span class="st">"cart"</span>,</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span>,</span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}],</span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>}}],</span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>   <span class="at">:id</span> <span class="st">"c9"</span>}],</span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a> <span class="at">:id</span> <span class="st">"c1"</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Notice how the threshold node appears as a <code>:ref</code> in one branch ‚Äî it‚Äôs the same computation feeding both train and test clipping.</p>
<p><strong><code>origin-story-graph</code></strong> normalizes the tree into a flat <code>{:nodes ... :edges ...}</code> structure suitable for graph algorithms:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-graph metrics-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:nodes</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a> {<span class="st">"c9"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/fit-outlier-threshold</span>},</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c10"</span> {<span class="at">:fn</span> <span class="at">:train</span>},</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c13"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/prepare-features</span>},</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c14"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/clip-outliers</span>},</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"v15"</span> {<span class="at">:value</span> <span class="at">:poly</span>+trig},</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"v7"</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:value</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:f</span> <span class="va">#'pocket-book.ml-workflows/nonlinear-fn,</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">:n</span> <span class="dv">200</span>,</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">:noise-sd</span> <span class="fl">0.3</span>,</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">:seed</span> <span class="dv">99</span>,</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">:outlier-fraction</span> <span class="fl">0.1</span>,</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">:outlier-scale</span> <span class="dv">15</span>}},</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"v8"</span> {<span class="at">:value</span> {<span class="at">:seed</span> <span class="dv">99</span>}},</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c2"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/prepare-features</span>},</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"v11"</span> {<span class="at">:value</span> <span class="at">:poly</span>+trig},</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c12"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/train-model</span>},</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"v16"</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:value</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span>,</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">:tribuo-components</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>    [{<span class="at">:name</span> <span class="st">"cart"</span>,</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span>,</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}],</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>}},</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c3"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/clip-outliers</span>},</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c4"</span> {<span class="at">:fn</span> <span class="at">:test</span>},</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c5"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/split-dataset</span>},</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c6"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/make-regression-data</span>},</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"c1"</span> {<span class="at">:fn</span> <span class="va">#'pocket-book.ml-workflows/evaluate-model</span>}},</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a> <span class="at">:edges</span></span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a> [[<span class="st">"c1"</span> <span class="st">"c2"</span>]</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c2"</span> <span class="st">"c3"</span>]</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c3"</span> <span class="st">"c4"</span>]</span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c4"</span> <span class="st">"c5"</span>]</span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c5"</span> <span class="st">"c6"</span>]</span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c6"</span> <span class="st">"v7"</span>]</span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c5"</span> <span class="st">"v8"</span>]</span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c3"</span> <span class="st">"c9"</span>]</span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c9"</span> <span class="st">"c10"</span>]</span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c10"</span> <span class="st">"c5"</span>]</span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c2"</span> <span class="st">"v11"</span>]</span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c1"</span> <span class="st">"c12"</span>]</span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c12"</span> <span class="st">"c13"</span>]</span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c13"</span> <span class="st">"c14"</span>]</span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c14"</span> <span class="st">"c10"</span>]</span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c14"</span> <span class="st">"c9"</span>]</span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c13"</span> <span class="st">"v15"</span>]</span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a>  [<span class="st">"c12"</span> <span class="st">"v16"</span>]]}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><strong><code>origin-story-mermaid</code></strong> renders the DAG as a Mermaid flowchart, with arrows showing data flow direction (from inputs toward the final result). The diamond dependency is clearly visible ‚Äî the threshold feeds both clipping steps:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-mermaid metrics-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="mermaid">flowchart TD
  n0["evaluate-model"]
  n1["prepare-features"]
  n2["clip-outliers"]
  n3[":test"]
  n4["split-dataset"]
  n5["make-regression-data"]
  n6[/"{:f #'pocket-book.ml-workflows/nonlinear-fn,<br>:n 200,<br>:noise-sd 0.3,<br>:seed 99,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n6 --&gt; n5
  n5 --&gt; n4
  n7[/"{:seed 99}"/]
  n7 --&gt; n4
  n4 --&gt; n3
  n3 --&gt; n2
  n8["fit-outlier-threshold"]
  n9[":train"]
  n4 --&gt; n9
  n9 --&gt; n8
  n8 --&gt; n2
  n2 --&gt; n1
  n10[/":poly+trig"/]
  n10 --&gt; n1
  n1 --&gt; n0
  n11["train-model"]
  n12["prepare-features"]
  n13["clip-outliers"]
  n9 --&gt; n13
  n8 --&gt; n13
  n13 --&gt; n12
  n14[/":poly+trig"/]
  n14 --&gt; n12
  n12 --&gt; n11
  n15[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '8'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n15 --&gt; n11
  n11 --&gt; n0</div>
</section>
<section id="execute-the-pipeline" class="level3">
<h3 class="anchored" data-anchor-id="execute-the-pipeline">Execute the pipeline</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">deref</span> metrics-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.661 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.662 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/clip-outliers
21:44:04.662 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.662 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.662 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.664 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/19/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :outlier-fraction 0.1, :outlier-scale 15, :seed 99})
21:44:04.665 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/53/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :outlier-fraction 0.1, :outlier-scale 15, :seed 99}) {:seed 99})
21:44:04.666 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/fb/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :outlier-fraction 0.1, :outlier-scale 15, :seed 99}) {:seed 99}))
21:44:04.666 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/fit-outlier-threshold
21:44:04.666 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.667 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/09/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :outlier-fraction 0.1, :outlier-scale 15, :seed 99}) {:seed 99}))
  Fitting outlier threshold from training data...
  Clipping outliers with bounds: {:lower -5.499694170624462, :upper 15.994051959902624}
21:44:04.668 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.668 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.668 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/clip-outliers
  Clipping outliers with bounds: {:lower -5.499694170624462, :upper 15.994051959902624}
21:44:04.675 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/29/298735d4cc3dbde1964a5f86130dba60f3a9db43
  Evaluating model...
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:rmse</span> <span class="fl">1.601302555211606</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How much did clipping help? Let‚Äôs compare three scenarios using the same cached building blocks.</p>
<p>The no-clip and clean-baseline pipelines are local ‚Äî they exist only for this comparison. Each still builds a cached DAG that shares steps with the clipped pipeline above.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> [<span class="co">;; No-clip: skip clipping, go straight from raw splits to features</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>      noclip-train-c  (c-prepare dag-train-c <span class="at">:poly</span>+trig)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>      noclip-test-c   (c-prepare dag-test-c <span class="at">:poly</span>+trig)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>      noclip-model-c  (c-train noclip-train-c cart-spec)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>      noclip-metrics  @(c-evaluate noclip-test-c noclip-model-c)</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Clean baseline: same structure, data without outliers</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      clean-data-c    (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>                                     {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">200</span> <span class="at">:noise-sd</span> <span class="fl">0.3</span> <span class="at">:seed</span> <span class="dv">99</span>})</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>      clean-split-c   (pocket/cached <span class="va">#'split-dataset</span> clean-data-c {<span class="at">:seed</span> <span class="dv">99</span>})</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>      clean-train-c   (c-prepare (pocket/cached <span class="at">:train</span> clean-split-c) <span class="at">:poly</span>+trig)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>      clean-test-c    (c-prepare (pocket/cached <span class="at">:test</span> clean-split-c) <span class="at">:poly</span>+trig)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>      clean-model-c   (c-train clean-train-c cart-spec)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>      clean-metrics   @(c-evaluate clean-test-c clean-model-c)]</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:clean</span>            clean-metrics</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>   <span class="at">:outliers-no-clip</span> noclip-metrics</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>   <span class="at">:outliers-clipped</span> <span class="at">@metrics-c</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.680 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.690 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.690 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.697 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/81/81bd64358cce9b4ef112b6e4b16b04cb1cdfb14e
  Evaluating model...
21:44:04.698 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.698 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
21:44:04.698 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/split-dataset
21:44:04.699 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/make-regression-data
21:44:04.699 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/55/(pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :seed 99})
21:44:04.701 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/87/(pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :seed 99}) {:seed 99})
21:44:04.702 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/80/(:test (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :seed 99}) {:seed 99}))
21:44:04.702 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/train-model
21:44:04.702 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.ml-workflows/prepare-features
21:44:04.702 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:44:04.703 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/54/(:train (pocket-book.ml-workflows_split-dataset (pocket-book.ml-workflows_make-regression-data {:f #'pocket-book.ml-workflows_nonlinear-fn, :n 200, :noise-sd 0.3, :seed 99}) {:seed 99}))
21:44:04.708 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/a0/a076e329e7ab037718d99d2a664dfc9114879d46
  Evaluating model...
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:clean</span> {<span class="at">:rmse</span> <span class="fl">0.4263098047865239</span>},</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a> <span class="at">:outliers-no-clip</span> {<span class="at">:rmse</span> <span class="fl">2.552495499444297</span>},</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a> <span class="at">:outliers-clipped</span> {<span class="at">:rmse</span> <span class="fl">1.601302555211606</span>}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Clipping x before building polynomial features makes a visible difference ‚Äî the amplification through x¬≤ is tamed.</p>
<hr>
</section>
</section>
<section id="part-5-comparing-many-experiments-at-once" class="level2">
<h2 class="anchored" data-anchor-id="part-5-comparing-many-experiments-at-once">Part 5 ‚Äî Comparing many experiments at once</h2>
<p><em>Hyperparameters</em> are settings you choose before training: tree depth, learning rate, which features to use. Finding good values usually means trying many combinations ‚Äî a <em>hyperparameter sweep</em>.</p>
<p>Pocket‚Äôs <code>compare-experiments</code> helps here. You pass a collection of cached experiments, and it extracts the parameters that vary across them (ignoring ones that are constant).</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> run-pipeline</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Run a complete pipeline with given hyperparameters."</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:keys</span> [noise-sd feature-set max-depth]}]</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [ds (make-regression-data {<span class="at">:f</span> nonlinear-fn <span class="at">:n</span> <span class="dv">200</span> <span class="at">:noise-sd</span> noise-sd <span class="at">:seed</span> <span class="dv">42</span>})</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>        sp (split-dataset ds {<span class="at">:seed</span> <span class="dv">42</span>})</span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>        train-prep (prepare-features (<span class="at">:train</span> sp) feature-set)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>        test-prep (prepare-features (<span class="at">:test</span> sp) feature-set)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>        spec {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">:properties</span> {<span class="at">:maxDepth</span> (<span class="kw">str</span> max-depth)}}]</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>}</span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>        model (ml/train train-prep spec)</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        pred (ml/predict test-prep model)]</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:rmse</span> (loss/rmse (<span class="at">:y</span> test-prep) (<span class="at">:y</span> pred))}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Run experiments across a grid of hyperparameters:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb76"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> experiments</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">for</span> [noise-sd [<span class="fl">0.3</span> <span class="fl">0.5</span>]</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>        feature-set [<span class="at">:raw</span> <span class="at">:poly</span>+trig]</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>        max-depth [<span class="dv">4</span> <span class="dv">8</span>]]</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    (pocket/cached <span class="va">#'run-pipeline</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>                   {<span class="at">:noise-sd</span> noise-sd</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">:feature-set</span> feature-set</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">:max-depth</span> max-depth})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Compare all experiments ‚Äî only varying parameters are shown:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb77"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> comparison</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  (pocket/compare-experiments experiments))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.717 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.722 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/0f/(pocket-book.ml-workflows_run-pipeline {:feature-set :raw, :max-depth 4, :noise-sd 0.3})
21:44:04.722 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.726 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/23/(pocket-book.ml-workflows_run-pipeline {:feature-set :raw, :max-depth 8, :noise-sd 0.3})
21:44:04.726 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.731 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/3f/(pocket-book.ml-workflows_run-pipeline {:feature-set :poly+trig, :max-depth 4, :noise-sd 0.3})
21:44:04.731 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.736 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/40/(pocket-book.ml-workflows_run-pipeline {:feature-set :poly+trig, :max-depth 8, :noise-sd 0.3})
21:44:04.736 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.740 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/c8/(pocket-book.ml-workflows_run-pipeline {:feature-set :raw, :max-depth 4, :noise-sd 0.5})
21:44:04.740 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.744 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/01/(pocket-book.ml-workflows_run-pipeline {:feature-set :raw, :max-depth 8, :noise-sd 0.5})
21:44:04.744 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.749 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/b3/(pocket-book.ml-workflows_run-pipeline {:feature-set :poly+trig, :max-depth 4, :noise-sd 0.5})
21:44:04.749 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.ml-workflows/run-pipeline
21:44:04.755 DEBUG scicloj.pocket.impl.cache - Cache write: /tmp/pocket-regression/00/(pocket-book.ml-workflows_run-pipeline {:feature-set :poly+trig, :max-depth 8, :noise-sd 0.5})
</code></pre>
</div>
</div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb79"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>(tc/dataset comparison)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [8 4]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">:noise-sd</th>
<th>:feature-set</th>
<th style="text-align: right;">:max-depth</th>
<th>:result</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.3</td>
<td>:raw</td>
<td style="text-align: right;">4</td>
<td>{:rmse 0.7189521159338053}</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3</td>
<td>:raw</td>
<td style="text-align: right;">8</td>
<td>{:rmse 0.41024324994778005}</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.3</td>
<td>:poly+trig</td>
<td style="text-align: right;">4</td>
<td>{:rmse 0.5297031491020386}</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.3</td>
<td>:poly+trig</td>
<td style="text-align: right;">8</td>
<td>{:rmse 0.4530388384300822}</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.5</td>
<td>:raw</td>
<td style="text-align: right;">4</td>
<td>{:rmse 0.8815492449083825}</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.5</td>
<td>:raw</td>
<td style="text-align: right;">8</td>
<td>{:rmse 0.6467985374993637}</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.5</td>
<td>:poly+trig</td>
<td style="text-align: right;">4</td>
<td>{:rmse 0.7728233864192875}</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.5</td>
<td>:poly+trig</td>
<td style="text-align: right;">8</td>
<td>{:rmse 0.6785270538736407}</td>
</tr>
</tbody>
</table>
</div>
<p>Each row shows the varying parameters plus the result. Parameters that were constant (like seed=42) are excluded automatically ‚Äî you see only what differs.</p>
<section id="results-visualization" class="level3">
<h3 class="anchored" data-anchor-id="results-visualization">Results visualization</h3>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb80"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">let</span> [rows (<span class="kw">map</span> (<span class="kw">fn</span> [exp]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>                  (<span class="kw">merge</span> (<span class="kw">select-keys</span> exp [<span class="at">:noise-sd</span> <span class="at">:feature-set</span> <span class="at">:max-depth</span>])</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>                         (<span class="at">:result</span> exp)))</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>                comparison)</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">;; Group by both feature-set and noise-sd for legend entries</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>      grouped (<span class="kw">group-by</span> (<span class="kw">juxt</span> <span class="at">:feature-set</span> <span class="at">:noise-sd</span>) rows)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>      feature-colors {<span class="at">:raw</span> <span class="st">"steelblue"</span> <span class="at">:poly</span> <span class="st">"tomato"</span> <span class="at">:poly</span>+trig <span class="st">"green"</span>}]</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  (kind/plotly</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:data</span> (<span class="kw">vec</span> (<span class="kw">for</span> [[[feature-set noise-sd] pts] (<span class="kw">sort-by</span> <span class="kw">first</span> grouped)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">:let</span> [max-depths (<span class="kw">mapv</span> <span class="at">:max-depth</span> pts)</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>                           rmses (<span class="kw">mapv</span> <span class="at">:rmse</span> pts)]]</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:x</span> max-depths</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:y</span> rmses</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:mode</span> <span class="st">"markers"</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:name</span> (<span class="kw">str</span> (<span class="kw">name</span> feature-set) <span class="st">" (noise="</span> noise-sd <span class="st">")"</span>)</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:legendgroup</span> (<span class="kw">name</span> feature-set)</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:marker</span> {<span class="at">:size</span> (<span class="kw">+</span> <span class="dv">8</span> (<span class="kw">*</span> <span class="dv">15</span> noise-sd))</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>                           <span class="at">:color</span> (feature-colors feature-set)}}))</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">:layout</span> {<span class="at">:xaxis</span> {<span class="at">:title</span> <span class="st">"max-depth"</span>} <span class="at">:yaxis</span> {<span class="at">:title</span> <span class="st">"rmse"</span>}}}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="height:auto;width:100%;"><script>Plotly.newPlot(document.currentScript.parentElement, [{"x":[4,8],"y":[0.5297031491020386,0.4530388384300822],"mode":"markers","name":"poly+trig (noise=0.3)","legendgroup":"poly+trig","marker":{"size":12.5,"color":"green"}},{"x":[4,8],"y":[0.7728233864192875,0.6785270538736407],"mode":"markers","name":"poly+trig (noise=0.5)","legendgroup":"poly+trig","marker":{"size":15.5,"color":"green"}},{"x":[4,8],"y":[0.7189521159338053,0.41024324994778005],"mode":"markers","name":"raw (noise=0.3)","legendgroup":"raw","marker":{"size":12.5,"color":"steelblue"}},{"x":[4,8],"y":[0.8815492449083825,0.6467985374993637],"mode":"markers","name":"raw (noise=0.5)","legendgroup":"raw","marker":{"size":15.5,"color":"steelblue"}}], {"xaxis":{"title":"max-depth"},"yaxis":{"title":"rmse"}}, {});</script></div>
</section>
</section>
<section id="what-we-learned" class="level2">
<h2 class="anchored" data-anchor-id="what-we-learned">What we learned</h2>
<p>This experiment revealed a clear story about the interplay between models, features, and noise:</p>
<ul>
<li><p><strong>Feature engineering is decisive for linear models.</strong> With raw features, the linear model couldn‚Äôt capture the nonlinear target at all. Adding trigonometric features (sin, cos) ‚Äî which match the structure of the true function ‚Äî dramatically improved it. The model didn‚Äôt get smarter; we gave it the right vocabulary.</p></li>
<li><p><strong>Decision trees are self-sufficient but fragile.</strong> The CART model achieved low error regardless of feature set, because it can learn nonlinear splits on its own. But as noise increased, it began fitting the noise rather than the signal ‚Äî a classic overfitting pattern.</p></li>
<li><p><strong>The crossover point matters.</strong> At low noise, the tree wins. At high noise, the well-featured linear model degrades more gracefully. Knowing where this crossover happens is exactly the kind of insight you get from systematic experimentation.</p></li>
<li><p><strong>Caching structures the workflow.</strong> In this small example, each step runs in milliseconds ‚Äî caching isn‚Äôt needed for speed. But the pattern scales: with real datasets and expensive training, the same pipeline structure ensures that only changed steps recompute. Meanwhile, <code>compare-experiments</code> extracted the varying parameters automatically, turning cached results into a comparison table ‚Äî useful at any scale.</p></li>
<li><p><strong>Preprocessing order matters.</strong> Outlier x values get amplified by polynomial features (x¬≤), so clipping must come <em>before</em> feature engineering. The diamond dependency ‚Äî one threshold feeding both train and test clipping ‚Äî is handled naturally by Pocket‚Äôs DAG.</p></li>
</ul>
</section>
<section id="cleanup-1" class="level2">
<h2 class="anchored" data-anchor-id="cleanup-1">Cleanup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:44:04.764 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-regression
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb83"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-regression"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="background-color:grey;height:2px;width:100%;"></div>
<div><pre><small><small>source: <a href="https://github.com/scicloj/pocket/blob/master/notebooks/pocket_book/ml_workflows.clj">notebooks/pocket_book/ml_workflows.clj</a></small></small></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pocket_book.extending_pocket.html" class="pagination-link" aria-label="Extending Pocket">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extending Pocket</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./pocket_book.pocket_model.html" class="pagination-link" aria-label="üöß Draft: `pocket-model` ‚Äî drop-in caching for metamorph.ml">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">üöß Draft: <code>pocket-model</code> ‚Äî drop-in caching for metamorph.ml</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>