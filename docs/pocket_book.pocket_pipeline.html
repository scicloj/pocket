<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; ðŸš§ Draft: Full Pocket integration for ML pipelines â€“ Pocket</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./pocket_book.cache_keys.html" rel="next">
<link href="./pocket_book.pocket_model.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4c01329f4fc381cbb6082899e66f51f8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pocket_book.pocket_pipeline.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: Full Pocket integration for ML pipelines</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Pocket</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Configuration</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.logging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.recursive_caching_in_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recursive Caching in Pipelines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.usage_practices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Usage Practices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.real_world_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Real-World Walkthrough: Weather Analysis Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.concurrency.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Concurrency</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.extending_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extending Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.ml_workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example: Machine Learning Workflows</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.pocket_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-model</code> â€” drop-in caching for metamorph.ml</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.pocket_pipeline.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: Full Pocket integration for ML pipelines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.cache_keys.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Under the hood: cache keys</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.developing_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Developing Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.api_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">API Reference</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#how-this-chapter-relates-to-others" id="toc-how-this-chapter-relates-to-others" class="nav-link" data-scroll-target="#how-this-chapter-relates-to-others">How this chapter relates to others</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#pipeline-functions" id="toc-pipeline-functions" class="nav-link" data-scroll-target="#pipeline-functions">Pipeline functions</a></li>
  <li><a href="#model-specifications" id="toc-model-specifications" class="nav-link" data-scroll-target="#model-specifications">Model specifications</a></li>
  <li><a href="#caching-fn-wrappers" id="toc-caching-fn-wrappers" class="nav-link" data-scroll-target="#caching-fn-wrappers">Caching-fn wrappers</a></li>
  <li><a href="#custom-pipeline-steps" id="toc-custom-pipeline-steps" class="nav-link" data-scroll-target="#custom-pipeline-steps">Custom pipeline steps</a>
  <ul>
  <li><a href="#pocket-fitted" id="toc-pocket-fitted" class="nav-link" data-scroll-target="#pocket-fitted"><code>pocket-fitted</code></a></li>
  <li><a href="#pocket-model" id="toc-pocket-model" class="nav-link" data-scroll-target="#pocket-model"><code>pocket-model</code></a></li>
  </ul></li>
  <li><a href="#composing-a-pipeline" id="toc-composing-a-pipeline" class="nav-link" data-scroll-target="#composing-a-pipeline">Composing a pipeline</a>
  <ul>
  <li><a href="#train-and-test-loss" id="toc-train-and-test-loss" class="nav-link" data-scroll-target="#train-and-test-loss">Train and test loss</a></li>
  </ul></li>
  <li><a href="#splits-as-cached-references" id="toc-splits-as-cached-references" class="nav-link" data-scroll-target="#splits-as-cached-references">Splits as Cached references</a></li>
  <li><a href="#evaluation-loop" id="toc-evaluation-loop" class="nav-link" data-scroll-target="#evaluation-loop">Evaluation loop</a></li>
  <li><a href="#demo-cross-validation" id="toc-demo-cross-validation" class="nav-link" data-scroll-target="#demo-cross-validation">Demo: cross-validation</a></li>
  <li><a href="#demo-hyperparameter-sweep" id="toc-demo-hyperparameter-sweep" class="nav-link" data-scroll-target="#demo-hyperparameter-sweep">Demo: hyperparameter sweep</a></li>
  <li><a href="#provenance" id="toc-provenance" class="nav-link" data-scroll-target="#provenance">Provenance</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: Full Pocket integration for ML pipelines</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<style></style>
<style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style>
<style>.clay-limit-image-width .clay-image {max-width: 100%}
.clay-side-by-side .sourceCode {margin: 0}
.clay-side-by-side {margin: 1em 0}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js" type="text/javascript"></script>
<p><strong>Last modified: 2026-02-08</strong></p>
<p>The previous chapter (<code>pocket-model</code>) showed how to cache model training in a <a href="https://github.com/scicloj/metamorph.ml">metamorph.ml</a> pipeline by swapping one step. That approach is simple â€” just replace <code>ml/model</code> with <code>pocket-model</code> â€” but only the training step is cached through Pocket.</p>
<p>This chapter explores a deeper integration: building the <strong>entire pipeline</strong> as a chain of <code>pocket/caching-fn</code> calls. Every step â€” data splitting, feature engineering, outlier clipping, training, evaluation â€” becomes a cached node in a DAG, giving us:</p>
<ul>
<li><p><strong>Per-step storage control</strong> â€” choose <code>:mem</code>, <code>:mem+disk</code>, or <code>:none</code> for each step independently</p></li>
<li><p><strong>Full provenance</strong> â€” <code>origin-story</code> traces any result back to the scalar parameters that produced it</p></li>
<li><p><strong>Disk persistence</strong> â€” cached models and intermediate results survive JVM restarts</p></li>
<li><p><strong>Concurrent dedup</strong> â€” same computation runs once across threads</p></li>
</ul>
<p>We then add a thin evaluation loop on top â€” <code>pocket-evaluate-pipelines</code> â€” that provides cross-validation and model comparison, similar to metamorph.mlâ€™s <code>evaluate-pipelines</code> but built on Pocketâ€™s DAG.</p>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p><a href="https://github.com/scicloj/metamorph.ml">metamorph.ml</a> is the Scicloj library for machine learning pipelines. It builds on <a href="https://github.com/scicloj/metamorph">metamorph</a>, a data-transformation framework where each step is a function that takes a context map and returns an updated one. Metamorph distinguishes two modes â€” <code>:fit</code> (learn from training data) and <code>:transform</code> (apply to new data) â€” so a pipeline can be trained once and reused for prediction.</p>
<p>On top of this, metamorph.ml adds model training/prediction, <a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> (<code>evaluate-pipelines</code>), <a href="https://en.wikipedia.org/wiki/Loss_function">loss functions</a>, and <a href="https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)">hyperparameter</a> search.</p>
</section>
<section id="how-this-chapter-relates-to-others" class="level2">
<h2 class="anchored" data-anchor-id="how-this-chapter-relates-to-others">How this chapter relates to others</h2>
<p>The <a href="ml_workflows.html">ML Workflows</a> chapter demonstrates Pocket caching with plain functions â€” <code>pocket/cached</code> calls wired into a DAG. This chapter uses the same pipeline functions and the same DAG approach, but adds <strong>cross-validation and model comparison</strong> on top, providing functionality similar to metamorph.mlâ€™s <code>evaluate-pipelines</code>.</p>
<p>The <a href="pocket_model.html">pocket-model</a> chapter takes the opposite approach: it plugs into metamorph.mlâ€™s existing pipeline machinery with a single drop-in replacement. Simpler to adopt, but only the training step is cached through Pocket.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 7%">
<col style="width: 46%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>pocket-model</th>
<th>This chapter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Integration effort</td>
<td>One-line change</td>
<td>Build pipeline as DAG</td>
</tr>
<tr class="even">
<td>Whatâ€™s cached</td>
<td>Training only</td>
<td>Every step</td>
</tr>
<tr class="odd">
<td>Provenance</td>
<td>Training step only</td>
<td>Full DAG</td>
</tr>
<tr class="even">
<td>Storage control</td>
<td>Global</td>
<td>Per-step</td>
</tr>
<tr class="odd">
<td>Evaluation</td>
<td>metamorph.mlâ€™s <code>evaluate-pipelines</code></td>
<td><code>pocket-evaluate-pipelines</code> (loops over <code>Cached</code> references)</td>
</tr>
</tbody>
</table>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> pocket-book.pocket-pipeline</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Logging setup for this chapter (see Logging chapter):</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   [pocket-book.logging]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Pocket API:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   [scicloj.pocket <span class="at">:as</span> pocket]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Annotating kinds of visualizations:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   [scicloj.kindly.v4.kind <span class="at">:as</span> kind]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Metamorph pipeline tools:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.core <span class="at">:as</span> mm]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Data processing:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>   [tablecloth.api <span class="at">:as</span> tc]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>   [tablecloth.column.api <span class="at">:as</span> tcc]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>   [tech.v3.dataset.modelling <span class="at">:as</span> ds-mod]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Machine learning:</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml <span class="at">:as</span> ml]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml.loss <span class="at">:as</span> loss]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>   [scicloj.ml.tribuo]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Override the default log level from debug to info. This notebook has many cached steps and debug output (cache hits, writes) would overwhelm the rendered output. Info level shows cache misses, invalidation, and cleanup â€” enough to see when computation happens.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(pocket-book.logging/set-slf4j-level! <span class="at">:info</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">nil</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cache-dir </span><span class="st">"/tmp/pocket-metamorph"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(pocket/set-base-cache-dir! cache-dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.867 INFO scicloj.pocket - Cache dir set to: /tmp/pocket-metamorph
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="st">"/tmp/pocket-metamorph"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.868 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">false</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="pipeline-functions" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-functions">Pipeline functions</h2>
<p>These are plain Clojure functions â€” each takes data in and returns data out. They know nothing about caching or about metamorphâ€™s context maps and fit/transform modes. Pocket will wrap them with <code>caching-fn</code> later to add caching; the evaluation loop will call them across folds to add cross-validation.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-regression-data</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Generate synthetic regression data: y = f(x) + noise.</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Optional outlier injection on x values."</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:keys</span> [f n noise-sd seed outlier-fraction outlier-scale]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">:or</span> {outlier-fraction <span class="dv">0</span> outlier-scale <span class="dv">10</span>}}]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [rng (java.util.Random. (<span class="kw">long</span> seed))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        xs (<span class="kw">vec</span> (<span class="kw">repeatedly</span> n #(<span class="kw">*</span> <span class="fl">10.0</span> (.nextDouble rng))))</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        xs-final (<span class="kw">if</span> (<span class="kw">pos?</span> outlier-fraction)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">let</span> [out-rng (java.util.Random. (<span class="kw">+</span> (<span class="kw">long</span> seed) <span class="dv">7919</span>))]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">mapv</span> (<span class="kw">fn</span> [x]</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">if</span> (<span class="kw">&lt;</span> (.nextDouble out-rng) outlier-fraction)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                               (<span class="kw">+</span> x (<span class="kw">*</span> (<span class="kw">double</span> outlier-scale) (.nextGaussian out-rng)))</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                               x))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                           xs))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                   xs)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        ys (<span class="kw">mapv</span> (<span class="kw">fn</span> [x] (<span class="kw">+</span> (<span class="kw">double</span> (f x))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">*</span> (<span class="kw">double</span> noise-sd) (.nextGaussian rng))))</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                 xs)]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (tc/dataset {<span class="at">:x</span> xs-final <span class="at">:y</span> ys})</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nonlinear-fn </span>[x] (<span class="kw">*</span> (Math/sin x) x))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> split-dataset</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Split into train/test using holdout."</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  [ds {<span class="at">:keys</span> [seed]}]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">first</span> (tc/split-&gt;seq ds <span class="at">:holdout</span> {<span class="at">:seed</span> seed})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> prepare-features</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Add derived columns: :raw (none), :poly+trig (xÂ², sin, cos)."</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  [ds feature-set]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [x (<span class="at">:x</span> ds)]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (<span class="kw">case</span> feature-set</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">:raw</span> ds</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">:poly</span>+trig (tc/add-columns ds {<span class="at">:x2</span> (tcc/sq x)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:sin-x</span> (tcc/sin x)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:cos-x</span> (tcc/cos x)}))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> fit-outlier-threshold</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute IQR-based clipping bounds for :x from training data."</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  [train-ds]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [xs (<span class="kw">sort</span> (<span class="kw">vec</span> (<span class="at">:x</span> train-ds)))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        n (<span class="kw">count</span> xs)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        q1 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.25</span> n)))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        q3 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.75</span> n)))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        iqr (<span class="kw">-</span> q3 q1)]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:lower</span> (<span class="kw">-</span> q1 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">:upper</span> (<span class="kw">+</span> q3 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> clip-outliers</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Clip :x values using pre-computed threshold bounds."</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  [ds threshold]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [{<span class="at">:keys</span> [lower upper]} threshold]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    (tc/add-column ds <span class="at">:x</span> (<span class="kw">-&gt;</span> (<span class="at">:x</span> ds) (tcc/max lower) (tcc/min upper)))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> train-model</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Train a model on a prepared dataset."</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  [train-ds model-spec]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  (ml/train train-ds model-spec))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> predict-model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Predict on test data using a trained model."</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  [test-ds model]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  (ml/predict test-ds model))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="model-specifications" class="level2">
<h2 class="anchored" data-anchor-id="model-specifications">Model specifications</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cart-spec</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> linear-sgd-spec</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"squared"</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.objectives.SquaredLoss"</span>}</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                       {<span class="at">:name</span> <span class="st">"linear-sgd"</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.linear.LinearSGDTrainer"</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:objective</span> <span class="st">"squared"</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:epochs</span> <span class="st">"50"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:loggingInterval</span> <span class="st">"10000"</span>}}]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"linear-sgd"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="caching-fn-wrappers" class="level2">
<h2 class="anchored" data-anchor-id="caching-fn-wrappers">Caching-fn wrappers</h2>
<p>Each pipeline function gets a <code>caching-fn</code> wrapper with an appropriate storage policy:</p>
<ul>
<li><p><strong><code>:mem</code></strong> for cheap shared steps (threshold, clipping, features, prediction) â€” no disk I/O, but in-memory dedup ensures each runs once</p></li>
<li><p><strong><code>:mem+disk</code></strong> (default) for expensive steps (model training) â€” persists to disk, survives JVM restarts</p></li>
<li><p><strong><code>:none</code></strong> for steps where we only want DAG tracking without any shared caching</p></li>
</ul>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-fit-outlier-threshold</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'fit-outlier-threshold</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-clip-outliers</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'clip-outliers</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-prepare-features</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'prepare-features</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-train-model</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'train-model</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-predict-model</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'predict-model</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="custom-pipeline-steps" class="level2">
<h2 class="anchored" data-anchor-id="custom-pipeline-steps">Custom pipeline steps</h2>
<p>metamorph provides the pipeline machinery we need: <code>mm/pipeline</code> composes steps, <code>mm/lift</code> wraps stateless functions, <code>mm/fit-pipe</code> and <code>mm/transform-pipe</code> run pipelines in each mode. These work with <code>Cached</code> references in <code>:metamorph/data</code> â€” they pass the context through without inspecting the data.</p>
<p>We only need two custom step types that metamorph does not provide:</p>
<section id="pocket-fitted" class="level3">
<h3 class="anchored" data-anchor-id="pocket-fitted"><code>pocket-fitted</code></h3>
<p>Creates a stateful pipeline step from two functions: one that fits parameters on training data, and one that applies those parameters to any dataset. In <code>:fit</code> mode, both are called. In <code>:transform</code> mode, only the apply function runs, using the parameters saved during <code>:fit</code>.</p>
<p>This has no direct metamorph equivalent â€” in metamorph, each stateful step must implement <code>(case mode :fit ... :transform ...)</code> manually. <code>pocket-fitted</code> eliminates that boilerplate.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-fitted</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Create a stateful pipeline step from fit and apply functions.</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="st">  In :fit mode, fits parameters from data and applies them.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="st">  In :transform mode, applies previously fitted parameters."</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  [fit-caching-fn apply-caching-fn]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> [{<span class="at">:metamorph/keys</span> [data mode id] <span class="at">:as</span> ctx}]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> mode</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">:fit</span> (<span class="kw">let</span> [fitted (fit-caching-fn data)]</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">-&gt;</span> ctx (<span class="kw">assoc</span> id fitted) (<span class="kw">assoc</span> <span class="at">:metamorph/data</span> (apply-caching-fn data fitted))))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">:transform</span> (<span class="kw">assoc</span> ctx <span class="at">:metamorph/data</span> (apply-caching-fn data (<span class="kw">get</span> ctx id))))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="pocket-model" class="level3">
<h3 class="anchored" data-anchor-id="pocket-model"><code>pocket-model</code></h3>
<p>The model step â€” like <code>ml/model</code>. Trains in <code>:fit</code> mode (cached via Pocket) and stores the model under its step ID. In <code>:transform</code> mode, predicts using the stored model and saves the preprocessed test data as <code>:target</code> (needed for metric computation in <code>pocket-evaluate-pipelines</code>).</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-model</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Create a model pipeline step. Trains in :fit mode,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="st">  predicts in :transform mode. Like ml/model."</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  [model-spec]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> [{<span class="at">:metamorph/keys</span> [data mode id] <span class="at">:as</span> ctx}]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> mode</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">:fit</span> (<span class="kw">assoc</span> ctx id (c-train-model data model-spec))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">:transform</span> (<span class="kw">let</span> [model (<span class="kw">get</span> ctx id)]</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">assoc</span> ctx <span class="at">:target</span> data</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">:metamorph/data</span> (c-predict-model data model))))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="composing-a-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="composing-a-pipeline">Composing a pipeline</h2>
<p>With these tools, we can build a specific pipeline by composing steps â€” the same way weâ€™d use <code>mm/pipeline</code> in metamorph:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> data-c</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">500</span> <span class="at">:noise-sd</span> <span class="fl">0.5</span> <span class="at">:seed</span> <span class="dv">42</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:outlier-fraction</span> <span class="fl">0.1</span> <span class="at">:outlier-scale</span> <span class="dv">15</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> split-c </span>(pocket/cached <span class="va">#'split-dataset</span> data-c {<span class="at">:seed</span> <span class="dv">42</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-c </span>(pocket/cached <span class="at">:train</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-c </span>(pocket/cached <span class="at">:test</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> pipe-cart</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  (mm/pipeline</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:clip</span>} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:prep</span>} (mm/lift c-prepare-features <span class="at">:poly</span>+trig)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:model</span>} (pocket-model cart-spec)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Fit on training data:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> fit-ctx </span>(mm/fit-pipe train-c pipe-cart))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Transform on test data (using fitted params from training):</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> transform-ctx </span>(mm/transform-pipe test-c pipe-cart fit-ctx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The fitted context carries the model and threshold as <code>Cached</code> references:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">-&gt;</span> fit-ctx</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">:model</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">deref</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">update</span> <span class="at">:model-data</span> <span class="kw">dissoc</span> <span class="at">:model-as-bytes</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    kind/pprint)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.882 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.882 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/split-dataset
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:31.888 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:model-data</span> {<span class="at">:target-ds</span> Group: <span class="dv">0</span> [<span class="dv">333</span> <span class="dv">1</span>]:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>|          <span class="at">:y</span> |</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>|------------:|</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.86298957</span> |</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">3.31824591</span> |</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.84502797</span> |</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.49792721</span> |</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">5.11365711</span> |</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.91894727</span> |</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">2.39650543</span> |</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.85326554</span> |</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.51279144</span> |</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">8.37327886</span> |</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>|         ... |</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.65944882</span> |</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.65420254</span> |</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">3.56240281</span> |</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.51681909</span> |</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.22642959</span> |</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.37170016</span> |</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.88234307</span> |</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.58490962</span> |</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">8.15404050</span> |</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.08785620</span> |</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.65671909</span> |</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>, <span class="at">:feature-ds</span> Group: <span class="dv">0</span> [<span class="dv">333</span> <span class="dv">4</span>]:</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>|          <span class="at">:x</span> |         <span class="at">:x2</span> |      <span class="at">:sin-x</span> |      <span class="at">:cos-x</span> |</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>|------------:|------------:|------------:|------------:|</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.62212252</span> |  <span class="fl">0.38703643</span> |  <span class="fl">0.58276133</span> |  <span class="fl">0.81264336</span> |</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.63922880</span> | <span class="fl">31.80090150</span> | -<span class="fl">0.60036425</span> |  <span class="fl">0.79972668</span> |</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.24912415</span> |  <span class="fl">1.56031114</span> |  <span class="fl">0.94870808</span> |  <span class="fl">0.31615341</span> |</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.52711743</span> |  <span class="fl">2.33208765</span> |  <span class="fl">0.99904623</span> |  <span class="fl">0.04366501</span> |</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">4.82231721</span> | <span class="fl">23.25474331</span> | -<span class="fl">0.99396397</span> |  <span class="fl">0.10970697</span> |</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.37550437</span> | <span class="fl">19.14503845</span> |  <span class="fl">0.94378903</span> | -<span class="fl">0.33054843</span> |</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.47898709</span> |  <span class="fl">2.18740283</span> |  <span class="fl">0.99578849</span> |  <span class="fl">0.09168031</span> |</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.20124675</span> | <span class="fl">51.85795481</span> |  <span class="fl">0.79442571</span> |  <span class="fl">0.60736133</span> |</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.34521076</span> |  <span class="fl">0.11917047</span> |  <span class="fl">0.33839501</span> |  <span class="fl">0.94100415</span> |</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.94559627</span> | <span class="fl">63.13250002</span> |  <span class="fl">0.99580631</span> | -<span class="fl">0.09148653</span> |</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>|         ... |         ... |         ... |         ... |</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.37550437</span> | <span class="fl">19.14503845</span> |  <span class="fl">0.94378903</span> | -<span class="fl">0.33054843</span> |</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.36484517</span> |  <span class="fl">0.13311200</span> |  <span class="fl">0.35680466</span> |  <span class="fl">0.93417902</span> |</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.49169112</span> | <span class="fl">30.15867130</span> | -<span class="fl">0.71140416</span> |  <span class="fl">0.70278313</span> |</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.27903869</span> | <span class="fl">27.86824953</span> | -<span class="fl">0.84370417</span> |  <span class="fl">0.53680842</span> |</span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.64151660</span> | <span class="fl">58.39277600</span> |  <span class="fl">0.97751408</span> |  <span class="fl">0.21087014</span> |</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.37550437</span> | <span class="fl">19.14503845</span> |  <span class="fl">0.94378903</span> | -<span class="fl">0.33054843</span> |</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">9.76876450</span> | <span class="fl">95.42875978</span> | -<span class="fl">0.33724276</span> | -<span class="fl">0.94141772</span> |</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.67942172</span> | <span class="fl">32.25583106</span> | -<span class="fl">0.56774469</span> |  <span class="fl">0.82320469</span> |</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">8.09594125</span> | <span class="fl">65.54426469</span> |  <span class="fl">0.97087030</span> | -<span class="fl">0.23960562</span> |</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">4.36540394</span> | <span class="fl">19.05675156</span> | -<span class="fl">0.94040226</span> | -<span class="fl">0.34006408</span> |</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.52754849</span> |  <span class="fl">2.33340440</span> |  <span class="fl">0.99906496</span> |  <span class="fl">0.04323435</span> |</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>},</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a> <span class="at">:options</span></span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a> {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span>,</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">:tribuo-components</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:name</span> <span class="st">"cart"</span>,</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span>,</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}],</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>},</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a> <span class="at">:train-input-hash</span> <span class="va">nil</span>,</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a> <span class="at">:id</span> #uuid <span class="st">"af4751a0-2f7d-43dd-bf8c-a2dd67c5f16f"</span>,</span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a> <span class="at">:feature-columns</span> [<span class="at">:x</span> <span class="at">:x2</span> <span class="at">:sin-x</span> <span class="at">:cos-x</span>],</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a> <span class="at">:target-columns</span> [<span class="at">:y</span>],</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a> <span class="at">:target-datatypes</span> {<span class="at">:y</span> <span class="at">:float64</span>}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Predictions:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>(tc/head (<span class="kw">deref</span> (<span class="at">:metamorph/data</span> transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-4-contents" aria-controls="callout-4" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-4" class="callout-4-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test
</code></pre>
</div>
</div>
</div>
<div class="clay-dataset">
<p>_unnamed [5 1]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">:y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1.88005320</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.87019231</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.87019231</td>
</tr>
<tr class="even">
<td style="text-align: right;">0.87019231</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-3.10429723</td>
</tr>
</tbody>
</table>
</div>
<p>Compute <a href="https://en.wikipedia.org/wiki/Root_mean_square_deviation">RMSE</a> from the target (preprocessed test data) and predictions:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(loss/rmse (<span class="at">:y</span> @(<span class="at">:target</span> transform-ctx))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>           (<span class="at">:y</span> @(<span class="at">:metamorph/data</span> transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.9830584588944564</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="train-and-test-loss" class="level3">
<h3 class="anchored" data-anchor-id="train-and-test-loss">Train and test loss</h3>
<p>A single metric on test data tells us how well the model generalizes, but comparing train and test <a href="https://en.wikipedia.org/wiki/Loss_function">loss</a> reveals whether the model is <a href="https://en.wikipedia.org/wiki/Overfitting">overfitting</a>. We compute the loss separately for each, then gather both into a summary.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> compute-loss</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute RMSE between actual and predicted :y columns."</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  [actual-ds predicted-ds]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  (loss/rmse (<span class="at">:y</span> actual-ds) (<span class="at">:y</span> predicted-ds)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-compute-loss </span>(pocket/caching-fn <span class="va">#'compute-loss</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We already have the test predictions from <code>transform-ctx</code>. For training loss, we also transform the training data through the fitted pipeline:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-transform-ctx </span>(mm/transform-pipe train-c pipe-cart fit-ctx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we compute loss on each split independently:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-loss-c</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  (c-compute-loss (<span class="at">:target</span> train-transform-ctx)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                  (<span class="at">:metamorph/data</span> train-transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-loss-c</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  (c-compute-loss (<span class="at">:target</span> transform-ctx)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                  (<span class="at">:metamorph/data</span> transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>A report function gathers both into one summary:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> report</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gather train and test loss into a summary map."</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  [train-loss test-loss]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:train-rmse</span> train-loss</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">:test-rmse</span> test-loss})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-report </span>(pocket/caching-fn <span class="va">#'report</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> summary-c </span>(c-report train-loss-c test-loss-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">deref</span> summary-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/report
21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/compute-loss
21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.912 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/compute-loss
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:train-rmse</span> <span class="fl">0.908876032851451</span>, <span class="at">:test-rmse</span> <span class="fl">1.9830584588944564</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The summary reference carries full provenance. The DAG branches into train and test paths that share the same model node â€” a diamond dependency that Pocket traces naturally:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-mermaid summary-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="mermaid">flowchart TD
  n0["report"]
  n1["compute-loss"]
  n2["prepare-features"]
  n3["clip-outliers"]
  n4[":train"]
  n5["split-dataset"]
  n6["make-regression-data"]
  n7[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n7 --&gt; n6
  n6 --&gt; n5
  n8[/"{:seed 42}"/]
  n8 --&gt; n5
  n5 --&gt; n4
  n4 --&gt; n3
  n9["fit-outlier-threshold"]
  n4 --&gt; n9
  n9 --&gt; n3
  n3 --&gt; n2
  n10[/":poly+trig"/]
  n10 --&gt; n2
  n2 --&gt; n1
  n11["predict-model"]
  n2 --&gt; n11
  n12["train-model"]
  n13["prepare-features"]
  n14["clip-outliers"]
  n4 --&gt; n14
  n9 --&gt; n14
  n14 --&gt; n13
  n15[/":poly+trig"/]
  n15 --&gt; n13
  n13 --&gt; n12
  n16[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '8'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n16 --&gt; n12
  n12 --&gt; n11
  n11 --&gt; n1
  n1 --&gt; n0
  n17["compute-loss"]
  n18["prepare-features"]
  n19["clip-outliers"]
  n20[":test"]
  n5 --&gt; n20
  n20 --&gt; n19
  n9 --&gt; n19
  n19 --&gt; n18
  n21[/":poly+trig"/]
  n21 --&gt; n18
  n18 --&gt; n17
  n22["predict-model"]
  n18 --&gt; n22
  n12 --&gt; n22
  n22 --&gt; n17
  n17 --&gt; n0</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.917 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="splits-as-cached-references" class="level2">
<h2 class="anchored" data-anchor-id="splits-as-cached-references">Splits as Cached references</h2>
<p>For cross-validation, we need k train/test splits â€” each as a <code>Cached</code> reference so the full provenance chain is maintained.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nth-split-train</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extract the train set of the nth split."</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  [ds split-method split-params idx]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:train</span> (<span class="kw">nth</span> (tc/split-&gt;seq ds split-method split-params) idx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nth-split-test</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extract the test set of the nth split."</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  [ds split-method split-params idx]</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:test</span> (<span class="kw">nth</span> (tc/split-&gt;seq ds split-method split-params) idx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn-</span><span class="fu"> n-splits</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Derive the number of splits from the method and params,</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="st">  without materializing the dataset."</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  [split-method split-params]</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> split-method</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">:kfold</span> (<span class="at">:k</span> split-params <span class="dv">5</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">:holdout</span> <span class="dv">1</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">:bootstrap</span> (<span class="at">:repeats</span> split-params <span class="dv">1</span>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">:loo</span> (<span class="kw">throw</span> (ex-info <span class="st">"pocket-splits does not support :loo (needs dataset size)"</span> {}))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="va">#'pocket-book.pocket-pipeline/n-splits</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-splits</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Create k-fold splits as Cached references.</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Returns [{:train Cached, :test Cached, :idx int} ...]."</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  [data-c split-method split-params]</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vec</span> (<span class="kw">for</span> [idx (<span class="kw">range</span> (n-splits split-method split-params))]</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>         {<span class="at">:train</span> (pocket/cached <span class="va">#'nth-split-train</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                                data-c split-method split-params idx)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>          <span class="at">:test</span> (pocket/cached <span class="va">#'nth-split-test</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                               data-c split-method split-params idx)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">:idx</span> idx})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="evaluation-loop" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-loop">Evaluation loop</h2>
<p><code>pocket-evaluate-pipelines</code> runs pipelines across splits â€” like metamorph.mlâ€™s <code>evaluate-pipelines</code>. For each pipeline Ã— each fold, it fits on train, transforms on test, and computes a metric.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-evaluate-pipelines</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Evaluate pipelines across k-fold splits.</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Like ml/evaluate-pipelines, but built on Cached references.</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="st">  </span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="st">  `pipelines` is a seq of pipeline functions (from mm/pipeline).</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="st">  `metric-fn` takes (test-ds, prediction-ds) and returns a number."</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>  [data-c split-method split-params pipelines metric-fn]</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [splits (pocket-splits data-c split-method split-params)]</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">vec</span> (<span class="kw">for</span> [pipe-fn pipelines</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>               {<span class="at">:keys</span> [train <span class="kw">test</span> idx]} splits]</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>           (<span class="kw">let</span> [fit-ctx (mm/fit-pipe train pipe-fn)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                 transform-ctx (mm/transform-pipe <span class="kw">test</span> pipe-fn fit-ctx)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>                 metric (metric-fn @(<span class="at">:target</span> transform-ctx)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>                                   @(<span class="at">:metamorph/data</span> transform-ctx))]</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>             {<span class="at">:split-idx</span> idx</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>              <span class="at">:metric</span> metric</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">:model</span> (<span class="at">:model</span> fit-ctx)})))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="demo-cross-validation" class="level2">
<h2 class="anchored" data-anchor-id="demo-cross-validation">Demo: cross-validation</h2>
<p>3-fold CV with three pipeline configurations:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> rmse-metric</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute RMSE between actual and predicted :y columns."</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  [test-ds pred-ds]</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  (loss/rmse (<span class="at">:y</span> test-ds) (<span class="at">:y</span> pred-ds)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-pipe </span>[{<span class="at">:keys</span> [feature-set model-spec]}]</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  (mm/pipeline</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:clip</span>} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:prep</span>} (mm/lift c-prepare-features feature-set)</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:model</span>} (pocket-model model-spec)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> configs</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:feature-set</span> <span class="at">:poly</span>+trig <span class="at">:model-spec</span> cart-spec}</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:feature-set</span> <span class="at">:raw</span> <span class="at">:model-spec</span> cart-spec}</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:feature-set</span> <span class="at">:poly</span>+trig <span class="at">:model-spec</span> linear-sgd-spec}])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> results</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  (pocket-evaluate-pipelines data-c <span class="at">:kfold</span> {<span class="at">:k</span> <span class="dv">3</span> <span class="at">:seed</span> <span class="dv">42</span>}</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">mapv</span> make-pipe configs)</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                             rmse-metric))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:31.936 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.936 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.954 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.954 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.970 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.970 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.985 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.004 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.004 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.914919,mean=0.701788,variance=15.193172})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.7525222314159787
21:50:32.011 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.011 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.498492,min=-5.914919,mean=0.583017,variance=14.288227})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.695109774152164
21:50:32.018 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.018 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 334 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=334,max=8.866764,min=-5.501972,mean=0.844474,variance=15.400435})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.510884525077099
</code></pre>
</div>
</div>
</div>
<p>3 configs Ã— 3 folds = 9 evaluations:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">count</span> results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dv">9</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Aggregate mean RMSE per config:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> summary</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [grouped (<span class="kw">partition</span> <span class="dv">3</span> results)]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">mapv</span> (<span class="kw">fn</span> [config rs]</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>            {<span class="at">:feature-set</span> (<span class="at">:feature-set</span> config)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">:model-type</span> (<span class="kw">-&gt;</span> config <span class="at">:model-spec</span> <span class="at">:tribuo-trainer-name</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">:mean-rmse</span> (tcc/mean (<span class="kw">map</span> <span class="at">:metric</span> rs))})</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>          configs grouped)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>(tc/dataset summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [3 3]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>:feature-set</th>
<th>:model-type</th>
<th style="text-align: right;">:mean-rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>:poly+trig</td>
<td>cart</td>
<td style="text-align: right;">1.97410371</td>
</tr>
<tr class="even">
<td>:raw</td>
<td>cart</td>
<td style="text-align: right;">1.79975941</td>
</tr>
<tr class="odd">
<td>:poly+trig</td>
<td>linear-sgd</td>
<td style="text-align: right;">2.00500709</td>
</tr>
</tbody>
</table>
</div>
<p>Second run â€” all training hits cache:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> results-2</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  (pocket-evaluate-pipelines data-c <span class="at">:kfold</span> {<span class="at">:k</span> <span class="dv">3</span> <span class="at">:seed</span> <span class="dv">42</span>}</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">mapv</span> make-pipe configs)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>                             rmse-metric))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">=</span> (<span class="kw">mapv</span> <span class="at">:metric</span> results) (<span class="kw">mapv</span> <span class="at">:metric</span> results<span class="dv">-2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="va">true</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="demo-hyperparameter-sweep" class="level2">
<h2 class="anchored" data-anchor-id="demo-hyperparameter-sweep">Demo: hyperparameter sweep</h2>
<p>Vary tree depth Ã— feature set. Each unique combination trains once and is cached. Re-running adds only new combinations.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb75"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-8-contents" aria-controls="callout-8" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-8" class="callout-8-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:32.049 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb77"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb78"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-configs</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">vec</span> (<span class="kw">for</span> [depth [<span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span> <span class="dv">12</span>]</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>             fs [<span class="at">:raw</span> <span class="at">:poly</span>+trig]]</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>         {<span class="at">:feature-set</span> fs</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">:model-spec</span> {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>                                            <span class="at">:properties</span> {<span class="at">:maxDepth</span> (<span class="kw">str</span> depth)}}]</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>}})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb79"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-results</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  (pocket-evaluate-pipelines data-c <span class="at">:kfold</span> {<span class="at">:k</span> <span class="dv">3</span> <span class="at">:seed</span> <span class="dv">42</span>}</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>                             (<span class="kw">mapv</span> make-pipe sweep-configs)</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                             rmse-metric))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-9-contents" aria-controls="callout-9" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-9" class="callout-9-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:32.058 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.058 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.066 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.067 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.067 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.069 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.069 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.079 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.079 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.088 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.088 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.089 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.089 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.110 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.122 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.122 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.128 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.128 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.135 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.135 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.141 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.141 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.151 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.151 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.161 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.161 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.171 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.171 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.178 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.178 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.188 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.188 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.196 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.196 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.211 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.212 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.223 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.223 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.235 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.236 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.244 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.244 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.253 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.253 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.260 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.260 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.271 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.271 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.284 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.285 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
</code></pre>
</div>
</div>
</div>
<p>8 configs Ã— 3 folds = 24 evaluations:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">count</span> sweep-results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb82"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="dv">24</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Results by depth and feature set:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb83"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-summary</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [grouped (<span class="kw">partition</span> <span class="dv">3</span> sweep-results)]</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;&gt;</span> (<span class="kw">mapv</span> (<span class="kw">fn</span> [config rs]</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:depth</span> (<span class="kw">-&gt;</span> config <span class="at">:model-spec</span> <span class="at">:tribuo-components</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>                             <span class="kw">first</span> <span class="at">:properties</span> <span class="at">:maxDepth</span>)</span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:feature-set</span> (<span class="at">:feature-set</span> config)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:mean-rmse</span> (tcc/mean (<span class="kw">map</span> <span class="at">:metric</span> rs))})</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>               sweep-configs grouped)</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>         (<span class="kw">sort-by</span> <span class="at">:mean-rmse</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb84"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>(tc/dataset sweep-summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [8 3]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>:depth</th>
<th>:feature-set</th>
<th style="text-align: right;">:mean-rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>4</td>
<td>:raw</td>
<td style="text-align: right;">1.56523718</td>
</tr>
<tr class="even">
<td>6</td>
<td>:raw</td>
<td style="text-align: right;">1.78120543</td>
</tr>
<tr class="odd">
<td>4</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.79514560</td>
</tr>
<tr class="even">
<td>8</td>
<td>:raw</td>
<td style="text-align: right;">1.79975941</td>
</tr>
<tr class="odd">
<td>12</td>
<td>:raw</td>
<td style="text-align: right;">1.80992021</td>
</tr>
<tr class="even">
<td>8</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.97410371</td>
</tr>
<tr class="odd">
<td>12</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.98328222</td>
</tr>
<tr class="even">
<td>6</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.98966980</td>
</tr>
</tbody>
</table>
</div>
<p>On this synthetic data, the shallow tree (depth 4) with raw features outperforms deeper trees and engineered features â€” a reminder that more complexity does not always help.</p>
<hr>
</section>
<section id="provenance" class="level2">
<h2 class="anchored" data-anchor-id="provenance">Provenance</h2>
<p>Pick one result and trace its full provenance. The DAG goes from the trained model back to the original scalar parameters (seed, noise-sd, outlier-fraction, etc.).</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb85"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-mermaid (<span class="at">:model</span> (<span class="kw">first</span> sweep-results)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="mermaid">flowchart TD
  n0["train-model"]
  n1["prepare-features"]
  n2["clip-outliers"]
  n3["nth-split-train"]
  n4["make-regression-data"]
  n5[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n5 --&gt; n4
  n4 --&gt; n3
  n6[/":kfold"/]
  n6 --&gt; n3
  n7[/"{:k 3,<br>:seed 42}"/]
  n7 --&gt; n3
  n8[/"0"/]
  n8 --&gt; n3
  n3 --&gt; n2
  n9["fit-outlier-threshold"]
  n3 --&gt; n9
  n9 --&gt; n2
  n2 --&gt; n1
  n10[/":raw"/]
  n10 --&gt; n1
  n1 --&gt; n0
  n11[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '4'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n11 --&gt; n0</div>
<hr>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p><strong>What the Pocket DAG approach brings to an ML workflow:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 68%">
</colgroup>
<thead>
<tr class="header">
<th>Aspect</th>
<th>What Pocket adds</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Caching</td>
<td>Per-step, configurable â€” each step chooses <code>:mem</code>, <code>:mem+disk</code>, or <code>:none</code></td>
</tr>
<tr class="even">
<td>Provenance</td>
<td>Full DAG via <code>origin-story</code> â€” trace any result to its parameters</td>
</tr>
<tr class="odd">
<td>Disk persistence</td>
<td>Cached models and intermediates survive JVM restarts</td>
</tr>
<tr class="even">
<td>Concurrent dedup</td>
<td><code>ConcurrentHashMap</code> ensures each computation runs once across threads</td>
</tr>
</tbody>
</table>
<p><strong>Reusing metamorph:</strong></p>
<p>We use <code>mm/pipeline</code>, <code>mm/lift</code>, <code>mm/fit-pipe</code>, and <code>mm/transform-pipe</code> directly â€” they pass <code>Cached</code> references through <code>:metamorph/data</code> without inspecting them. Pocket only adds two custom step types:</p>
<ul>
<li><p><strong><code>pocket-model</code></strong> â€” like <code>ml/model</code>, but caches training via <code>pocket/cached</code> so models persist to disk</p></li>
<li><p><strong><code>pocket-fitted</code></strong> â€” a new pattern for stateful steps</p></li>
</ul>
<p>In metamorph, every stateful step must dispatch on mode manually:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb86"><pre class="sourceCode clj code-with-copy"><code class="sourceCode clojure"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; metamorph style â€” manual mode dispatch</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>(<span class="kw">fn</span> [{<span class="at">:metamorph/keys</span> [data mode id] <span class="at">:as</span> ctx}]</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> mode</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">:fit</span>       (<span class="kw">let</span> [bounds (fit-threshold data)]</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">assoc</span> ctx id bounds</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:metamorph/data</span> (clip data bounds)))</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">:transform</span> (<span class="kw">let</span> [bounds (<span class="kw">get</span> ctx id)]</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">assoc</span> ctx <span class="at">:metamorph/data</span> (clip data bounds)))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><code>pocket-fitted</code> eliminates that boilerplate â€” we just provide the fit function and the apply function:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb87"><pre class="sourceCode clj code-with-copy"><code class="sourceCode clojure"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">;; Pocket style â€” same behavior, less ceremony</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>(pocket-fitted c-fit-outlier-threshold c-clip-outliers)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>On top of this, <code>pocket-evaluate-pipelines</code> and <code>pocket-splits</code> wrap cross-validation in <code>Cached</code> references for provenance. Everything else is standard metamorph.</p>
<p><strong>What we write:</strong></p>
<ol type="1">
<li>Plain pipeline functions (data in, data out)</li>
<li><code>caching-fn</code> wrappers with storage policies (one line each)</li>
<li>Pipeline composition via <code>mm/pipeline</code> with our custom steps</li>
<li><code>pocket-evaluate-pipelines</code> for cross-validation across <code>Cached</code> splits</li>
</ol>
<p><strong>Open question: where should the custom steps live?</strong> <code>pocket-fitted</code>, <code>pocket-model</code>, <code>pocket-splits</code>, and <code>pocket-evaluate-pipelines</code> are currently defined in this notebook. A future <code>scicloj.pocket.ml</code> namespace could provide them â€” but only if the pattern proves stable across different use cases.</p>
</section>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">Cleanup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb88"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center collapsed" data-bs-toggle="collapse" data-bs-target=".callout-10-contents" aria-controls="callout-10" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>OUT
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-10" class="callout-10-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<pre><code>21:50:32.310 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph
</code></pre>
</div>
</div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb90"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="background-color:grey;height:2px;width:100%;"></div>
<div><pre><small><small>source: <a href="https://github.com/scicloj/pocket/blob/master/notebooks/pocket_book/pocket_pipeline.clj">notebooks/pocket_book/pocket_pipeline.clj</a></small></small></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pocket_book.pocket_model.html" class="pagination-link" aria-label="ðŸš§ Draft: `pocket-model` â€” drop-in caching for metamorph.ml">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-model</code> â€” drop-in caching for metamorph.ml</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./pocket_book.cache_keys.html" class="pagination-link" aria-label="Under the hood: cache keys">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Under the hood: cache keys</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>