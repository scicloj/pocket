<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; ðŸš§ Draft: pocket-pipeline â€” cached ML pipelines with evaluate-pipelines â€“ Pocket</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./pocket_book.cache_keys.html" rel="next">
<link href="./pocket_book.pocket_model.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4c01329f4fc381cbb6082899e66f51f8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./pocket_book.pocket_pipeline.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-pipeline</code> â€” cached ML pipelines with <code>evaluate-pipelines</code></span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Pocket</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.getting_started.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Getting Started</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.configuration.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Configuration</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.logging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Logging</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.recursive_caching_in_pipelines.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Recursive Caching in Pipelines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.usage_practices.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Usage Practices</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.real_world_walkthrough.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Real-World Walkthrough: Weather Analysis Pipeline</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.concurrency.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Concurrency</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.extending_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Extending Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.ml_workflows.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Example: Machine Learning Workflows</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.pocket_model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-model</code> â€” drop-in caching for metamorph.ml</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.pocket_pipeline.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-pipeline</code> â€” cached ML pipelines with <code>evaluate-pipelines</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.cache_keys.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Under the hood: cache keys</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.developing_pocket.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Developing Pocket</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./pocket_book.api_reference.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">API Reference</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#how-this-chapter-relates-to-others" id="toc-how-this-chapter-relates-to-others" class="nav-link" data-scroll-target="#how-this-chapter-relates-to-others">How this chapter relates to others</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#pipeline-functions" id="toc-pipeline-functions" class="nav-link" data-scroll-target="#pipeline-functions">Pipeline functions</a></li>
  <li><a href="#model-specifications" id="toc-model-specifications" class="nav-link" data-scroll-target="#model-specifications">Model specifications</a></li>
  <li><a href="#caching-fn-wrappers" id="toc-caching-fn-wrappers" class="nav-link" data-scroll-target="#caching-fn-wrappers">Caching-fn wrappers</a></li>
  <li><a href="#custom-pipeline-steps" id="toc-custom-pipeline-steps" class="nav-link" data-scroll-target="#custom-pipeline-steps">Custom pipeline steps</a>
  <ul>
  <li><a href="#pocket-fitted" id="toc-pocket-fitted" class="nav-link" data-scroll-target="#pocket-fitted"><code>pocket-fitted</code></a></li>
  <li><a href="#pocket-model" id="toc-pocket-model" class="nav-link" data-scroll-target="#pocket-model"><code>pocket-model</code></a></li>
  </ul></li>
  <li><a href="#composing-a-pipeline" id="toc-composing-a-pipeline" class="nav-link" data-scroll-target="#composing-a-pipeline">Composing a pipeline</a>
  <ul>
  <li><a href="#train-and-test-loss" id="toc-train-and-test-loss" class="nav-link" data-scroll-target="#train-and-test-loss">Train and test loss</a></li>
  <li><a href="#provenance" id="toc-provenance" class="nav-link" data-scroll-target="#provenance">Provenance</a></li>
  </ul></li>
  <li><a href="#splits-as-cached-references" id="toc-splits-as-cached-references" class="nav-link" data-scroll-target="#splits-as-cached-references">Splits as <code>Cached</code> references</a></li>
  <li><a href="#cross-validation-with-mlevaluate-pipelines" id="toc-cross-validation-with-mlevaluate-pipelines" class="nav-link" data-scroll-target="#cross-validation-with-mlevaluate-pipelines">Cross-validation with <code>ml/evaluate-pipelines</code></a></li>
  <li><a href="#hyperparameter-sweep" id="toc-hyperparameter-sweep" class="nav-link" data-scroll-target="#hyperparameter-sweep">Hyperparameter sweep</a>
  <ul>
  <li><a href="#sweep-provenance" id="toc-sweep-provenance" class="nav-link" data-scroll-target="#sweep-provenance">Sweep provenance</a></li>
  </ul></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">Discussion</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-pipeline</code> â€” cached ML pipelines with <code>evaluate-pipelines</code></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<style></style>
<style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style>
<style>.clay-limit-image-width .clay-image {max-width: 100%}
.clay-side-by-side .sourceCode {margin: 0}
.clay-side-by-side {margin: 1em 0}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js" type="text/javascript"></script>
<p>The previous chapter (<a href="pocket_model.html">pocket-model</a>) showed how to cache model training in a <a href="https://github.com/scicloj/metamorph.ml">metamorph.ml</a> pipeline by swapping one step. That approach is simple â€” just replace <code>ml/model</code> with <code>pocket-model</code> â€” but only the training step is cached through Pocket.</p>
<p>This chapter explores a deeper integration: building the <strong>entire pipeline</strong> as a chain of <code>pocket/caching-fn</code> calls, where every step â€” data splitting, feature engineering, outlier clipping, training â€” becomes a cached node. This gives us:</p>
<ul>
<li><p><strong>Per-step storage control</strong> â€” choose <code>:mem</code>, <code>:mem+disk</code>, or <code>:none</code> for each step independently</p></li>
<li><p><strong>Full provenance</strong> â€” <code>origin-story</code> traces any result back to the scalar parameters that produced it</p></li>
<li><p><strong>Disk persistence</strong> â€” cached models and intermediate results survive JVM restarts</p></li>
<li><p><strong>Concurrent dedup</strong> â€” same computation runs once across threads</p></li>
</ul>
<p>The key ingredient is Pocketâ€™s <a href="cache_keys.html#origin-registry-derefed-values-keep-their-identity">origin registry</a>: when a <code>Cached</code> value is derefed, the real result keeps its lightweight identity. This lets us deref at each pipeline step â€” so real datasets flow through <a href="https://github.com/scicloj/metamorph">metamorph</a>â€™s context â€” while cache keys stay efficient. Because the data is always a real dataset, we can use metamorph.mlâ€™s <a href="https://scicloj.github.io/metamorph.ml/scicloj.metamorph.ml.html#var-evaluate-pipelines"><code>evaluate-pipelines</code></a> directly for <a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> and model comparison.</p>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p><a href="https://github.com/scicloj/metamorph.ml">metamorph.ml</a> is the Scicloj library for machine learning pipelines. It builds on <a href="https://github.com/scicloj/metamorph">metamorph</a>, a data-transformation framework where each step is a function that takes a context map and returns an updated one. Metamorph distinguishes two modes â€” <code>:fit</code> (learn from training data) and <code>:transform</code> (apply to new data) â€” so a pipeline can be trained once and reused for prediction.</p>
<p>On top of this, metamorph.ml adds model training/prediction, <a href="https://en.wikipedia.org/wiki/Cross-validation_(statistics)">cross-validation</a> (<code>evaluate-pipelines</code>), <a href="https://en.wikipedia.org/wiki/Loss_function">loss functions</a>, and <a href="https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)">hyperparameter</a> search.</p>
</section>
<section id="how-this-chapter-relates-to-others" class="level2">
<h2 class="anchored" data-anchor-id="how-this-chapter-relates-to-others">How this chapter relates to others</h2>
<p>The <a href="ml_workflows.html">ML Workflows</a> chapter demonstrates Pocket caching with plain functions â€” <code>pocket/cached</code> calls wired into a DAG. This chapter uses the same pipeline functions and the same DAG approach, but adds <strong>cross-validation and model comparison</strong> on top, reusing metamorph.mlâ€™s <code>evaluate-pipelines</code>.</p>
<p>The <a href="pocket_model.html">pocket-model</a> chapter takes the opposite approach: it plugs into metamorph.mlâ€™s existing pipeline machinery with a single drop-in replacement. Simpler to adopt, but only the training step is cached through Pocket.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 7%">
<col style="width: 46%">
<col style="width: 46%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>pocket-model</th>
<th>This chapter</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Integration effort</td>
<td>One-line change</td>
<td>Build pipeline with <code>caching-fn</code> wrappers</td>
</tr>
<tr class="even">
<td>Whatâ€™s cached</td>
<td>Training only</td>
<td>Every step</td>
</tr>
<tr class="odd">
<td>Provenance</td>
<td>Training step only</td>
<td>Full DAG â€” any result to its parameters</td>
</tr>
<tr class="even">
<td>Storage control</td>
<td>Global</td>
<td>Per-step</td>
</tr>
<tr class="odd">
<td>Evaluation</td>
<td><code>ml/evaluate-pipelines</code></td>
<td><code>ml/evaluate-pipelines</code> (same)</td>
</tr>
</tbody>
</table>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">ns</span> pocket-book.pocket-pipeline</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:require</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Logging setup for this chapter (see Logging chapter):</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   [pocket-book.logging]</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Pocket API:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   [scicloj.pocket <span class="at">:as</span> pocket]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Annotating kinds of visualizations:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   [scicloj.kindly.v4.kind <span class="at">:as</span> kind]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Metamorph pipeline tools:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.core <span class="at">:as</span> mm]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Data processing:</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>   [tablecloth.api <span class="at">:as</span> tc]</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>   [tablecloth.column.api <span class="at">:as</span> tcc]</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>   [tech.v3.dataset.modelling <span class="at">:as</span> ds-mod]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Column role filters (feature, target, prediction):</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>   [tech.v3.dataset.column-filters <span class="at">:as</span> cf]</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>   <span class="co">;; Machine learning:</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml <span class="at">:as</span> ml]</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>   [scicloj.metamorph.ml.loss <span class="at">:as</span> loss]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>   [scicloj.ml.tribuo]))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Override the default log level from debug to info. This notebook has many cached steps and debug output (cache hits, writes) would overwhelm the rendered output. Info level shows cache misses, invalidation, and cleanup â€” enough to see when computation happens.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>(pocket-book.logging/set-slf4j-level! <span class="at">:info</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">nil</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cache-dir </span><span class="st">"/tmp/pocket-metamorph"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(pocket/set-base-cache-dir! cache-dir)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="st">"/tmp/pocket-metamorph"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">false</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="pipeline-functions" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-functions">Pipeline functions</h2>
<p>These are plain Clojure functions â€” each takes data in and returns data out. They know nothing about caching or about metamorphâ€™s context maps and fit/transform modes. Pocket will wrap them with <code>caching-fn</code> later to add caching; the evaluation loop will call them across folds to add cross-validation.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-regression-data</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Generate synthetic regression data: y = f(x) + noise.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Optional outlier injection on x values."</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:keys</span> [f n noise-sd seed outlier-fraction outlier-scale]</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">:or</span> {outlier-fraction <span class="dv">0</span> outlier-scale <span class="dv">10</span>}}]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [rng (java.util.Random. (<span class="kw">long</span> seed))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        xs (<span class="kw">repeatedly</span> n #(<span class="kw">*</span> <span class="fl">10.0</span> (.nextDouble rng)))</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        xs-final (<span class="kw">if</span> (<span class="kw">pos?</span> outlier-fraction)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                   (<span class="kw">let</span> [out-rng (java.util.Random. (<span class="kw">+</span> (<span class="kw">long</span> seed) <span class="dv">7919</span>))]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                     (<span class="kw">map</span> (<span class="kw">fn</span> [x]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                            (<span class="kw">if</span> (<span class="kw">&lt;</span> (.nextDouble out-rng) outlier-fraction)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                              (<span class="kw">+</span> x (<span class="kw">*</span> (<span class="kw">double</span> outlier-scale) (.nextGaussian out-rng)))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                              x))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                          xs))</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                   xs)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        ys (<span class="kw">map</span> (<span class="kw">fn</span> [x] (<span class="kw">+</span> (<span class="kw">double</span> (f x))</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                           (<span class="kw">*</span> (<span class="kw">double</span> noise-sd) (.nextGaussian rng))))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                xs)]</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (tc/dataset {<span class="at">:x</span> xs-final <span class="at">:y</span> ys})</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nonlinear-fn </span>[x] (<span class="kw">*</span> (Math/sin x) x))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> split-dataset</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Split into train/test using holdout."</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  [ds {<span class="at">:keys</span> [seed]}]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">first</span> (tc/split-&gt;seq ds <span class="at">:holdout</span> {<span class="at">:seed</span> seed})))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> prepare-features</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Add derived columns: :raw (none), :poly+trig (xÂ², sin, cos)."</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  [ds feature-set]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [x (<span class="at">:x</span> ds)]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">-&gt;</span> (<span class="kw">case</span> feature-set</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>          <span class="at">:raw</span> ds</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>          <span class="at">:poly</span>+trig (tc/add-columns ds {<span class="at">:x2</span> (tcc/sq x)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:sin-x</span> (tcc/sin x)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">:cos-x</span> (tcc/cos x)}))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        (ds-mod/set-inference-target <span class="at">:y</span>))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> fit-outlier-threshold</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute IQR-based clipping bounds for :x from training data."</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  [train-ds]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [xs (<span class="kw">sort</span> (<span class="at">:x</span> train-ds))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        n (<span class="kw">count</span> xs)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        q1 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.25</span> n)))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        q3 (<span class="kw">nth</span> xs (<span class="kw">int</span> (<span class="kw">*</span> <span class="fl">0.75</span> n)))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        iqr (<span class="kw">-</span> q3 q1)]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:lower</span> (<span class="kw">-</span> q1 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">:upper</span> (<span class="kw">+</span> q3 (<span class="kw">*</span> <span class="fl">1.5</span> iqr))}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> clip-outliers</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Clip :x values using pre-computed threshold bounds."</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  [ds threshold]</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">let</span> [{<span class="at">:keys</span> [lower upper]} threshold]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    (tc/add-column ds <span class="at">:x</span> (<span class="kw">-&gt;</span> (<span class="at">:x</span> ds) (tcc/max lower) (tcc/min upper)))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> predict-model</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Predict on test data using a trained model."</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  [test-ds model]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  (ml/predict test-ds model))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="model-specifications" class="level2">
<h2 class="anchored" data-anchor-id="model-specifications">Model specifications</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cart-spec</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> linear-sgd-spec</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"squared"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.objectives.SquaredLoss"</span>}</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                       {<span class="at">:name</span> <span class="st">"linear-sgd"</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:type</span> <span class="st">"org.tribuo.regression.sgd.linear.LinearSGDTrainer"</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">:properties</span> {<span class="at">:objective</span> <span class="st">"squared"</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:epochs</span> <span class="st">"50"</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">:loggingInterval</span> <span class="st">"10000"</span>}}]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">:tribuo-trainer-name</span> <span class="st">"linear-sgd"</span>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="caching-fn-wrappers" class="level2">
<h2 class="anchored" data-anchor-id="caching-fn-wrappers">Caching-fn wrappers</h2>
<p>Each pipeline function gets a <code>caching-fn</code> wrapper with an appropriate storage policy:</p>
<ul>
<li><p><strong><code>:mem</code></strong> for cheap shared steps (threshold, clipping, features, prediction) â€” no disk I/O, but in-memory dedup ensures each runs once</p></li>
<li><p><strong><code>:mem+disk</code></strong> (default) for expensive steps (model training) â€” persists to disk, survives JVM restarts</p></li>
</ul>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-fit-outlier-threshold</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'fit-outlier-threshold</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-clip-outliers</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'clip-outliers</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-prepare-features</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'prepare-features</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-predict-model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  (pocket/caching-fn <span class="va">#'predict-model</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="custom-pipeline-steps" class="level2">
<h2 class="anchored" data-anchor-id="custom-pipeline-steps">Custom pipeline steps</h2>
<p>metamorph provides the pipeline machinery we need: <code>mm/pipeline</code> composes steps, <code>mm/lift</code> wraps stateless functions, <code>mm/fit-pipe</code> and <code>mm/transform-pipe</code> run pipelines in each mode.</p>
<p>We build on this with two custom step types. Each step uses <code>caching-fn</code> wrappers internally and <strong>derefs</strong> the <code>Cached</code> result, so <code>:metamorph/data</code> always holds a real dataset. The <a href="cache_keys.html#origin-registry-derefed-values-keep-their-identity">origin registry</a> ensures these derefed datasets carry their lightweight identity, so the next stepâ€™s cache key stays efficient.</p>
<section id="pocket-fitted" class="level3">
<h3 class="anchored" data-anchor-id="pocket-fitted"><code>pocket-fitted</code></h3>
<p>Creates a stateful pipeline step from two functions: one that fits parameters on training data, and one that applies those parameters to any dataset. In <code>:fit</code> mode, both are called. In <code>:transform</code> mode, only the apply function runs, using the parameters saved during <code>:fit</code>.</p>
<p>Both functions should be <code>caching-fn</code> wrappers. Their <code>Cached</code> results are derefed before being stored in the context or in <code>:metamorph/data</code>.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-fitted</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Create a stateful pipeline step from fit and apply caching-fns.</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="st">  In :fit mode, fits parameters from data and applies them.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="st">  In :transform mode, applies previously fitted parameters.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="st">  Results are derefed so real datasets flow through the pipeline."</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  [fit-caching-fn apply-caching-fn]</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> [{<span class="at">:metamorph/keys</span> [data mode id] <span class="at">:as</span> ctx}]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> mode</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">:fit</span> (<span class="kw">let</span> [fitted (<span class="kw">deref</span> (fit-caching-fn data))]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>             (<span class="kw">-&gt;</span> ctx</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">assoc</span> id fitted)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>                 (<span class="kw">assoc</span> <span class="at">:metamorph/data</span> (<span class="kw">deref</span> (apply-caching-fn data fitted)))))</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">:transform</span> (<span class="kw">assoc</span> ctx <span class="at">:metamorph/data</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                        (<span class="kw">deref</span> (apply-caching-fn data (<span class="kw">get</span> ctx id)))))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="pocket-model" class="level3">
<h3 class="anchored" data-anchor-id="pocket-model"><code>pocket-model</code></h3>
<p>The model step â€” compatible with <code>ml/evaluate-pipelines</code>. Trains in <code>:fit</code> mode (cached via Pocket) and stores the model map under its step ID. In <code>:transform</code> mode, predicts using the stored model (also cached) and saves the preprocessed test data as <code>:target</code> (for our loss computation) and as <code>:scicloj.metamorph.ml/target-ds</code> (for <code>evaluate-pipelines</code>).</p>
<p>The <code>Cached</code> reference from training is also stored (under <code>:pocket/model-cached</code>) so we can trace provenance later.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-model</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cached model step compatible with ml/evaluate-pipelines.</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Caches training and prediction via pocket/cached. Stores the</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="st">  training Cached reference at :pocket/model-cached for provenance."</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  [model-spec]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">fn</span> [{<span class="at">:metamorph/keys</span> [data mode id] <span class="at">:as</span> ctx}]</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">case</span> mode</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">:fit</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> [model-c (pocket/cached <span class="va">#'ml/train</span> data model-spec)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            model (<span class="kw">deref</span> model-c)]</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">assoc</span> ctx id model</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">:pocket/model-cached</span> model-c))</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">:transform</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>      (<span class="kw">let</span> [model (<span class="kw">get</span> ctx id)]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">-&gt;</span> ctx</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">update</span> id <span class="kw">assoc</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                    <span class="at">:scicloj.metamorph.ml/feature-ds</span> (cf/feature data)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>                    <span class="at">:scicloj.metamorph.ml/target-ds</span> (cf/target data))</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">assoc</span> <span class="at">:metamorph/data</span> (<span class="kw">deref</span> (c-predict-model data model))</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">:target</span> data))))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="composing-a-pipeline" class="level2">
<h2 class="anchored" data-anchor-id="composing-a-pipeline">Composing a pipeline</h2>
<p>With these tools, we can build a pipeline by composing steps. The <code>pocket-fitted</code> step handles stateful outlier clipping, <code>mm/lift</code> with <code>(comp deref c-fn)</code> handles stateless cached feature preparation, and <code>pocket-model</code> handles training.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> data-c</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  (pocket/cached <span class="va">#'make-regression-data</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>                 {<span class="at">:f</span> <span class="va">#'nonlinear-fn</span> <span class="at">:n</span> <span class="dv">500</span> <span class="at">:noise-sd</span> <span class="fl">0.5</span> <span class="at">:seed</span> <span class="dv">42</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:outlier-fraction</span> <span class="fl">0.1</span> <span class="at">:outlier-scale</span> <span class="dv">15</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> split-c </span>(pocket/cached <span class="va">#'split-dataset</span> data-c {<span class="at">:seed</span> <span class="dv">42</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-c </span>(pocket/cached <span class="at">:train</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-c </span>(pocket/cached <span class="at">:test</span> split-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> pipe-cart</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  (mm/pipeline</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:clip</span>} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:prep</span>} (mm/lift (<span class="kw">comp</span> <span class="kw">deref</span> c-prepare-features) <span class="at">:poly</span>+trig)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:model</span>} (pocket-model cart-spec)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Fit on training data. We deref the <code>Cached</code> split to get a real dataset â€” the origin registry ensures our caching-fn wrappers still see a lightweight cache key:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> fit-ctx </span>(mm/fit-pipe (<span class="kw">deref</span> train-c) pipe-cart))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Transform on test data (using fitted params from training):</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> transform-ctx </span>(mm/transform-pipe (<span class="kw">deref</span> test-c) pipe-cart fit-ctx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The fitted context carries the model:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">-&gt;</span> fit-ctx</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">get</span> <span class="at">:model</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    (<span class="kw">update</span> <span class="at">:model-data</span> <span class="kw">dissoc</span> <span class="at">:model-as-bytes</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    kind/pprint)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:model-data</span> {<span class="at">:target-ds</span> Group: <span class="dv">0</span> [<span class="dv">333</span> <span class="dv">1</span>]:</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>|          <span class="at">:y</span> |</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>|------------:|</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.03959829</span> |</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.97631359</span> |</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">1.13244613</span> |</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">0.28466023</span> |</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">3.51203007</span> |</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.56378543</span> |</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">0.34817318</span> |</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">3.95058332</span> |</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.75833936</span> |</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.90883052</span> |</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>|         ... |</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.94841143</span> |</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.76281763</span> |</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.72108056</span> |</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">2.61412072</span> |</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">0.47687264</span> |</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.90381607</span> |</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.37372487</span> |</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.57928612</span> |</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.72187253</span> |</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">1.30560162</span> |</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.86963826</span> |</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>, <span class="at">:feature-ds</span> Group: <span class="dv">0</span> [<span class="dv">333</span> <span class="dv">4</span>]:</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>|          <span class="at">:x</span> |         <span class="at">:x2</span> |      <span class="at">:sin-x</span> |      <span class="at">:cos-x</span> |</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>|------------:|------------:|------------:|------------:|</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">3.56214010</span> | <span class="fl">12.68884212</span> | -<span class="fl">0.40826026</span> | -<span class="fl">0.91286557</span> |</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">2.64156573</span> |  <span class="fl">6.97786948</span> |  <span class="fl">0.47944917</span> | -<span class="fl">0.87756965</span> |</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">9.51947133</span> | <span class="fl">90.62033446</span> | -<span class="fl">0.09455192</span> | -<span class="fl">0.99551993</span> |</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.27079557</span> | <span class="fl">39.32287712</span> | -<span class="fl">0.01238942</span> |  <span class="fl">0.99992325</span> |</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">5.62533957</span> | <span class="fl">31.64444532</span> | -<span class="fl">0.61141358</span> |  <span class="fl">0.79131121</span> |</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.85326548</span> | <span class="fl">23.55418581</span> |  <span class="fl">0.99009331</span> |  <span class="fl">0.14041098</span> |</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.28305731</span> |  <span class="fl">0.08012144</span> |  <span class="fl">0.27929260</span> |  <span class="fl">0.96020604</span> |</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.94559974</span> | <span class="fl">48.24135581</span> |  <span class="fl">0.61502245</span> |  <span class="fl">0.78850960</span> |</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">6.46688990</span> | <span class="fl">41.82066494</span> |  <span class="fl">0.18267307</span> |  <span class="fl">0.98317371</span> |</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.51301426</span> | <span class="fl">56.44538329</span> |  <span class="fl">0.94243162</span> |  <span class="fl">0.33439893</span> |</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>|         ... |         ... |         ... |         ... |</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.85326548</span> | <span class="fl">23.55418581</span> |  <span class="fl">0.99009331</span> |  <span class="fl">0.14041098</span> |</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">1.03856897</span> |  <span class="fl">1.07862551</span> |  <span class="fl">0.86167893</span> |  <span class="fl">0.50745386</span> |</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.39090954</span> | <span class="fl">54.62554378</span> |  <span class="fl">0.89468442</span> |  <span class="fl">0.44669877</span> |</span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">3.90381073</span> | <span class="fl">15.23973824</span> | -<span class="fl">0.69052749</span> | -<span class="fl">0.72330615</span> |</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">0.22759616</span> |  <span class="fl">0.05180001</span> |  <span class="fl">0.22563633</span> |  <span class="fl">0.97421160</span> |</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>| -<span class="fl">4.85326548</span> | <span class="fl">23.55418581</span> |  <span class="fl">0.99009331</span> |  <span class="fl">0.14041098</span> |</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">7.38225379</span> | <span class="fl">54.49767101</span> |  <span class="fl">0.89078444</span> |  <span class="fl">0.45442610</span> |</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">4.66158402</span> | <span class="fl">21.73036562</span> | -<span class="fl">0.99870971</span> | -<span class="fl">0.05078310</span> |</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">2.67983090</span> |  <span class="fl">7.18149367</span> |  <span class="fl">0.44552604</span> | -<span class="fl">0.89526898</span> |</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">3.47865983</span> | <span class="fl">12.10107420</span> | -<span class="fl">0.33072073</span> | -<span class="fl">0.94372867</span> |</span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>|  <span class="fl">2.13681411</span> |  <span class="fl">4.56597455</span> |  <span class="fl">0.84404323</span> | -<span class="fl">0.53627515</span> |</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>},</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a> <span class="at">:options</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a> {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span>,</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">:tribuo-components</span></span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:name</span> <span class="st">"cart"</span>,</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span>,</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">:properties</span> {<span class="at">:maxDepth</span> <span class="st">"8"</span>}}],</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>},</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a> <span class="at">:train-input-hash</span> <span class="va">nil</span>,</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a> <span class="at">:id</span> #uuid <span class="st">"3c8f2d88-26ed-4193-add7-d4d312d9a4fb"</span>,</span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a> <span class="at">:feature-columns</span> [<span class="at">:x</span> <span class="at">:x2</span> <span class="at">:sin-x</span> <span class="at">:cos-x</span>],</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a> <span class="at">:target-columns</span> [<span class="at">:y</span>],</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a> <span class="at">:target-datatypes</span> {<span class="at">:y</span> <span class="at">:float64</span>}}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Predictions:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>(tc/head (<span class="at">:metamorph/data</span> transform-ctx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [5 1]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th style="text-align: right;">:y</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">7.49226834</td>
</tr>
<tr class="even">
<td style="text-align: right;">-1.63699192</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-4.08775473</td>
</tr>
<tr class="even">
<td style="text-align: right;">-3.85731359</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2.39153284</td>
</tr>
</tbody>
</table>
</div>
<p>Compute <a href="https://en.wikipedia.org/wiki/Root_mean_square_deviation">RMSE</a> from the target and predictions:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>(loss/rmse (<span class="at">:y</span> (<span class="kw">get-in</span> transform-ctx [<span class="at">:model</span> <span class="at">:scicloj.metamorph.ml/target-ds</span>]))</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>           (<span class="at">:y</span> (<span class="at">:metamorph/data</span> transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fl">1.6810603338440813</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="train-and-test-loss" class="level3">
<h3 class="anchored" data-anchor-id="train-and-test-loss">Train and test loss</h3>
<p>A single metric on test data tells us how well the model generalizes, but comparing train and test <a href="https://en.wikipedia.org/wiki/Loss_function">loss</a> reveals whether the model is <a href="https://en.wikipedia.org/wiki/Overfitting">overfitting</a>. We compute the loss separately for each, then gather both into a summary.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> compute-loss</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Compute RMSE between actual and predicted :y columns."</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  [actual-ds predicted-ds]</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  (loss/rmse (<span class="at">:y</span> actual-ds) (<span class="at">:y</span> predicted-ds)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-compute-loss </span>(pocket/caching-fn <span class="va">#'compute-loss</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We already have the test predictions from <code>transform-ctx</code>. For training loss, we also transform the training data through the fitted pipeline:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-transform-ctx </span>(mm/transform-pipe (<span class="kw">deref</span> train-c) pipe-cart fit-ctx))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we compute loss on each split independently:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> train-loss-c</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  (c-compute-loss (<span class="at">:target</span> train-transform-ctx)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                  (<span class="at">:metamorph/data</span> train-transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> test-loss-c</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  (c-compute-loss (<span class="at">:target</span> transform-ctx)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                  (<span class="at">:metamorph/data</span> transform-ctx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>A report function gathers both into one summary:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> report</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Gather train and test loss into a summary map."</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  [train-loss test-loss]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  {<span class="at">:train-rmse</span> train-loss</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">:test-rmse</span> test-loss})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> c-report </span>(pocket/caching-fn <span class="va">#'report</span> {<span class="at">:storage</span> <span class="at">:mem</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> summary-c </span>(c-report train-loss-c test-loss-c))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">deref</span> summary-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:train-rmse</span> <span class="fl">0.9236365142505957</span>, <span class="at">:test-rmse</span> <span class="fl">1.6810603338440813</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="provenance" class="level3">
<h3 class="anchored" data-anchor-id="provenance">Provenance</h3>
<p>The summary reference carries full provenance. The origin registry lets <code>origin-story</code> follow derefed values back through the caching chain â€” so the DAG branches into train and test paths that share the same model node. This diamond dependency is traced naturally:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-mermaid summary-c)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="mermaid">flowchart TD
  n0["report"]
  n1["compute-loss"]
  n2["prepare-features"]
  n3["clip-outliers"]
  n4[":train"]
  n5["split-dataset"]
  n6["make-regression-data"]
  n7[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n7 --&gt; n6
  n6 --&gt; n5
  n8[/"{:seed 42}"/]
  n8 --&gt; n5
  n5 --&gt; n4
  n4 --&gt; n3
  n9["fit-outlier-threshold"]
  n4 --&gt; n9
  n9 --&gt; n3
  n3 --&gt; n2
  n10[/":poly+trig"/]
  n10 --&gt; n2
  n2 --&gt; n1
  n11["predict-model"]
  n2 --&gt; n11
  n12["train"]
  n2 --&gt; n12
  n13[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '8'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n13 --&gt; n12
  n12 --&gt; n11
  n11 --&gt; n1
  n1 --&gt; n0
  n14["compute-loss"]
  n15["prepare-features"]
  n16["clip-outliers"]
  n17[":test"]
  n5 --&gt; n17
  n17 --&gt; n16
  n9 --&gt; n16
  n16 --&gt; n15
  n18[/":poly+trig"/]
  n18 --&gt; n15
  n15 --&gt; n14
  n19["predict-model"]
  n15 --&gt; n19
  n12 --&gt; n19
  n19 --&gt; n14
  n14 --&gt; n0</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb48"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="splits-as-cached-references" class="level2">
<h2 class="anchored" data-anchor-id="splits-as-cached-references">Splits as <code>Cached</code> references</h2>
<p>For cross-validation, we need k train/test splits. We create them as <code>Cached</code> references â€” preserving provenance â€” and then deref them to get real datasets for <code>ml/evaluate-pipelines</code>. The origin registry ensures the derefed datasets carry their lightweight identity.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nth-split-train</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extract the train set of the nth split."</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  [ds split-method split-params idx]</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:train</span> (<span class="kw">nth</span> (tc/split-&gt;seq ds split-method split-params) idx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> nth-split-test</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Extract the test set of the nth split."</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  [ds split-method split-params idx]</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  (<span class="at">:test</span> (<span class="kw">nth</span> (tc/split-&gt;seq ds split-method split-params) idx)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn-</span><span class="fu"> n-splits</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Derive the number of splits from the method and params.</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="st">  For :loo, derefs the dataset to get its row count."</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  [data-c split-method split-params]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">case</span> split-method</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">:kfold</span> (<span class="at">:k</span> split-params <span class="dv">5</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">:holdout</span> <span class="dv">1</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">:bootstrap</span> (<span class="at">:repeats</span> split-params <span class="dv">1</span>)</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">:loo</span> (tc/row-count (<span class="kw">deref</span> data-c))))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb52"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="va">#'pocket-book.pocket-pipeline/n-splits</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> pocket-splits</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Create k-fold splits as Cached references.</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="st">  Returns [{:train Cached, :test Cached, :idx int} ...]."</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  [data-c split-method split-params]</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">for</span> [idx (<span class="kw">range</span> (n-splits data-c split-method split-params))]</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:train</span> (pocket/cached <span class="va">#'nth-split-train</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>                           data-c split-method split-params idx)</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">:test</span> (pocket/cached <span class="va">#'nth-split-test</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>                          data-c split-method split-params idx)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">:idx</span> idx}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Create <code>Cached</code> splits and deref them for <code>ml/evaluate-pipelines</code>. The derefed datasets are real (passing malli validation) while carrying their origin identity (for efficient cache keys):</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> cached-splits </span>(pocket-splits data-c <span class="at">:kfold</span> {<span class="at">:k</span> <span class="dv">3</span> <span class="at">:seed</span> <span class="dv">42</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> splits</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">map</span> (<span class="kw">fn</span> [{<span class="at">:keys</span> [train <span class="kw">test</span>]}]</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>         {<span class="at">:train</span> (<span class="kw">deref</span> train) <span class="at">:test</span> (<span class="kw">deref</span> <span class="kw">test</span>)})</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>       cached-splits))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="cross-validation-with-mlevaluate-pipelines" class="level2">
<h2 class="anchored" data-anchor-id="cross-validation-with-mlevaluate-pipelines">Cross-validation with <code>ml/evaluate-pipelines</code></h2>
<p>Because our pipeline steps deref their outputs, real datasets flow through <code>:metamorph/data</code> at every point. This makes our pipeline fully compatible with <a href="https://scicloj.github.io/metamorph.ml/scicloj.metamorph.ml.html#var-evaluate-pipelines"><code>evaluate-pipelines</code></a>, which needs real datasets for metric computation.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">defn</span><span class="fu"> make-pipe </span>[{<span class="at">:keys</span> [feature-set model-spec]}]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  (mm/pipeline</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:clip</span>} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:prep</span>} (mm/lift (<span class="kw">comp</span> <span class="kw">deref</span> c-prepare-features) feature-set)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:metamorph/id</span> <span class="at">:model</span>} (pocket-model model-spec)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> configs</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  [{<span class="at">:feature-set</span> <span class="at">:poly</span>+trig <span class="at">:model-spec</span> cart-spec}</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:feature-set</span> <span class="at">:raw</span> <span class="at">:model-spec</span> cart-spec}</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:feature-set</span> <span class="at">:poly</span>+trig <span class="at">:model-spec</span> linear-sgd-spec}])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb58"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> results</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  (ml/evaluate-pipelines</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">map</span> make-pipe configs)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>   splits</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>   loss/rmse</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:loss</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:return-best-crossvalidation-only</span> <span class="va">false</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">:return-best-pipeline-only</span> <span class="va">false</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>3 configs Ã— 3 folds â€” aggregate mean RMSE per config:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> summary</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">map</span> (<span class="kw">fn</span> [config pipeline-results]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>         {<span class="at">:feature-set</span> (<span class="at">:feature-set</span> config)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>          <span class="at">:model-type</span> (<span class="kw">-&gt;</span> config <span class="at">:model-spec</span> <span class="at">:tribuo-trainer-name</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>          <span class="at">:mean-rmse</span> (tcc/mean (<span class="kw">map</span> #(<span class="kw">-&gt;</span> <span class="va">%</span> <span class="at">:test-transform</span> <span class="at">:metric</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                    pipeline-results))})</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>       configs results))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>(tc/dataset summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [3 3]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>:feature-set</th>
<th>:model-type</th>
<th style="text-align: right;">:mean-rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>:poly+trig</td>
<td>cart</td>
<td style="text-align: right;">1.65064791</td>
</tr>
<tr class="even">
<td>:raw</td>
<td>cart</td>
<td style="text-align: right;">1.63217429</td>
</tr>
<tr class="odd">
<td>:poly+trig</td>
<td>linear-sgd</td>
<td style="text-align: right;">2.13019778</td>
</tr>
</tbody>
</table>
</div>
<p>Second run â€” all training hits cache, same metrics:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb61"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> results-2</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  (ml/evaluate-pipelines</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">map</span> make-pipe configs)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>   splits</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>   loss/rmse</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:loss</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:return-best-crossvalidation-only</span> <span class="va">false</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">:return-best-pipeline-only</span> <span class="va">false</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>(<span class="kw">=</span> (<span class="kw">map</span> #(<span class="kw">-&gt;</span> <span class="va">%</span> <span class="kw">first</span> <span class="at">:test-transform</span> <span class="at">:metric</span>) results)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">map</span> #(<span class="kw">-&gt;</span> <span class="va">%</span> <span class="kw">first</span> <span class="at">:test-transform</span> <span class="at">:metric</span>) results<span class="dv">-2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="va">true</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
<section id="hyperparameter-sweep" class="level2">
<h2 class="anchored" data-anchor-id="hyperparameter-sweep">Hyperparameter sweep</h2>
<p>Vary tree depth Ã— feature set. Each unique combination trains once and is cached. Re-running adds only new combinations.</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb64"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-configs</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">for</span> [depth [<span class="dv">4</span> <span class="dv">6</span> <span class="dv">8</span> <span class="dv">12</span>]</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>        fs [<span class="at">:raw</span> <span class="at">:poly</span>+trig]]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    {<span class="at">:feature-set</span> fs</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">:model-spec</span> {<span class="at">:model-type</span> <span class="at">:scicloj.ml.tribuo/regression</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:tribuo-components</span> [{<span class="at">:name</span> <span class="st">"cart"</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">:type</span> <span class="st">"org.tribuo.regression.rtree.CARTRegressionTrainer"</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">:properties</span> {<span class="at">:maxDepth</span> (<span class="kw">str</span> depth)}}]</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">:tribuo-trainer-name</span> <span class="st">"cart"</span>}}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-results</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  (ml/evaluate-pipelines</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>   (<span class="kw">map</span> make-pipe sweep-configs)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>   splits</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>   loss/rmse</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">:loss</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>   {<span class="at">:return-best-crossvalidation-only</span> <span class="va">false</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">:return-best-pipeline-only</span> <span class="va">false</span>}))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Results by depth and feature set:</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>(<span class="bu">def</span><span class="fu"> sweep-summary</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">-&gt;&gt;</span> (<span class="kw">map</span> (<span class="kw">fn</span> [config pipeline-results]</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>              {<span class="at">:depth</span> (<span class="kw">-&gt;</span> config <span class="at">:model-spec</span> <span class="at">:tribuo-components</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>                          <span class="kw">first</span> <span class="at">:properties</span> <span class="at">:maxDepth</span>)</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">:feature-set</span> (<span class="at">:feature-set</span> config)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">:mean-rmse</span> (tcc/mean (<span class="kw">map</span> #(<span class="kw">-&gt;</span> <span class="va">%</span> <span class="at">:test-transform</span> <span class="at">:metric</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>                                         pipeline-results))})</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>            sweep-configs sweep-results)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>       (<span class="kw">sort-by</span> <span class="at">:mean-rmse</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>(tc/dataset sweep-summary)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="clay-dataset">
<p>_unnamed [8 3]:</p>
<table class="caption-top table">
<thead>
<tr class="header">
<th>:depth</th>
<th>:feature-set</th>
<th style="text-align: right;">:mean-rmse</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>12</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.52866093</td>
</tr>
<tr class="even">
<td>6</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.63217429</td>
</tr>
<tr class="odd">
<td>8</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.64435595</td>
</tr>
<tr class="even">
<td>6</td>
<td>:raw</td>
<td style="text-align: right;">1.65064791</td>
</tr>
<tr class="odd">
<td>4</td>
<td>:poly+trig</td>
<td style="text-align: right;">1.65350222</td>
</tr>
<tr class="even">
<td>4</td>
<td>:raw</td>
<td style="text-align: right;">1.66164890</td>
</tr>
<tr class="odd">
<td>8</td>
<td>:raw</td>
<td style="text-align: right;">1.66262333</td>
</tr>
<tr class="even">
<td>12</td>
<td>:raw</td>
<td style="text-align: right;">1.71514296</td>
</tr>
</tbody>
</table>
</div>
<p>On this synthetic data, deeper trees with engineered features (<code>poly+trig</code>) perform best, while shallower trees show similar results regardless of feature set.</p>
<section id="sweep-provenance" class="level3">
<h3 class="anchored" data-anchor-id="sweep-provenance">Sweep provenance</h3>
<p>Pick the best result and trace its full provenance. The DAG goes from the trained model back to the original scalar parameters (seed, noise-sd, outlier-fraction, etc.):</p>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>(pocket/origin-story-mermaid</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a> (<span class="at">:pocket/model-cached</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">-&gt;</span> sweep-results <span class="kw">first</span> <span class="kw">first</span> <span class="at">:fit-ctx</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="mermaid">flowchart TD
  n0["train"]
  n1["prepare-features"]
  n2["clip-outliers"]
  n3["nth-split-train"]
  n4["make-regression-data"]
  n5[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n5 --&gt; n4
  n4 --&gt; n3
  n6[/":kfold"/]
  n6 --&gt; n3
  n7[/"{:k 3,<br>:seed 42}"/]
  n7 --&gt; n3
  n8[/"0"/]
  n8 --&gt; n3
  n3 --&gt; n2
  n9["fit-outlier-threshold"]
  n3 --&gt; n9
  n9 --&gt; n2
  n2 --&gt; n1
  n10[/":poly+trig"/]
  n10 --&gt; n1
  n1 --&gt; n0
  n11[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '12'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n11 --&gt; n0</div>
<hr>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p><strong>What the Pocket DAG approach brings to an ML workflow:</strong></p>
<table class="caption-top table">
<colgroup>
<col style="width: 32%">
<col style="width: 68%">
</colgroup>
<thead>
<tr class="header">
<th>Aspect</th>
<th>What Pocket adds</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Caching</td>
<td>Per-step, configurable â€” each step chooses <code>:mem</code>, <code>:mem+disk</code>, or <code>:none</code></td>
</tr>
<tr class="even">
<td>Provenance</td>
<td>Full DAG via <code>origin-story</code> â€” trace any result to its parameters</td>
</tr>
<tr class="odd">
<td>Disk persistence</td>
<td>Cached models and intermediates survive JVM restarts</td>
</tr>
<tr class="even">
<td>Concurrent dedup</td>
<td><code>ConcurrentHashMap</code> ensures each computation runs once across threads</td>
</tr>
</tbody>
</table>
<p><strong>Reusing metamorph:</strong></p>
<p>We use <code>mm/pipeline</code>, <code>mm/lift</code>, <code>mm/fit-pipe</code>, and <code>mm/transform-pipe</code> directly â€” and now also <code>ml/evaluate-pipelines</code> for cross-validation and model comparison. Pocket only adds two custom step types:</p>
<ul>
<li><p><strong><code>pocket-model</code></strong> â€” like <code>ml/model</code>, but caches training via <code>pocket/cached</code> so models persist to disk</p></li>
<li><p><strong><code>pocket-fitted</code></strong> â€” a general pattern for stateful steps</p></li>
</ul>
<p><strong>The deref-through pattern:</strong></p>
<p>Each pipeline step wraps a <code>caching-fn</code> and immediately derefs the <code>Cached</code> result. This means real datasets (not <code>Cached</code> references) flow through <code>:metamorph/data</code> at every point. The <a href="cache_keys.html#origin-registry-derefed-values-keep-their-identity">origin registry</a> provides two benefits:</p>
<ol type="1">
<li><strong>Efficient cache keys</strong> â€” each derefed dataset carries its lightweight identity, so the next stepâ€™s <code>caching-fn</code> avoids hashing full dataset content</li>
<li><strong>Full provenance</strong> â€” <code>origin-story</code> follows derefed values back through the registry to their <code>Cached</code> origin, preserving the complete DAG (as seen in the diamond dependency above)</li>
</ol>
<p>Because <code>:metamorph/data</code> is always a real dataset, <code>ml/evaluate-pipelines</code> can call <code>cf/target</code>, <code>cf/prediction</code>, and malli validation â€” things that require concrete dataset types.</p>
<p><strong>What we write:</strong></p>
<ol type="1">
<li>Plain pipeline functions (data in, data out)</li>
<li><code>caching-fn</code> wrappers with storage policies (one line each)</li>
<li>Pipeline composition via <code>mm/pipeline</code> with our custom steps</li>
<li><code>ml/evaluate-pipelines</code> for cross-validation</li>
</ol>
<p><strong>Open question: where should the custom steps live?</strong> <code>pocket-fitted</code> and <code>pocket-model</code> are currently defined in this notebook. A future <code>scicloj.pocket.ml</code> namespace could provide them â€” but only if the pattern proves stable across different use cases.</p>
</section>
<section id="cleanup" class="level2">
<h2 class="anchored" data-anchor-id="cleanup">Cleanup</h2>
<div class="sourceClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>(pocket/cleanup!)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="printedClojure">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="sourceCode clojure code-with-copy"><code class="sourceCode clojure"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>{<span class="at">:dir</span> <span class="st">"/tmp/pocket-metamorph"</span>, <span class="at">:existed</span> <span class="va">true</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div style="background-color:grey;height:2px;width:100%;"></div>
<div><pre><small><small>source: <a href="https://github.com/scicloj/pocket/blob/master/notebooks/pocket_book/pocket_pipeline.clj">notebooks/pocket_book/pocket_pipeline.clj</a></small></small></pre></div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./pocket_book.pocket_model.html" class="pagination-link" aria-label="ðŸš§ Draft: `pocket-model` â€” drop-in caching for metamorph.ml">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">ðŸš§ Draft: <code>pocket-model</code> â€” drop-in caching for metamorph.ml</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./pocket_book.cache_keys.html" class="pagination-link" aria-label="Under the hood: cache keys">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Under the hood: cache keys</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>