---
format:
  html:
    toc: true
    toc-depth: 4
    theme: [cosmo, notebooks/custom.scss]
    toc-expand: 2
    number-depth: 1
    filters: [notebooks/collapse-callouts.lua]

---
<style></style><style>.printedClojure .sourceCode {
  background-color: transparent;
  border-style: none;
}
</style><style>.clay-limit-image-width .clay-image {max-width: 100%}
.clay-side-by-side .sourceCode {margin: 0}
.clay-side-by-side {margin: 1em 0}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js" type="text/javascript"></script><script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js" type="text/javascript"></script><script src="https://cdn.jsdelivr.net/npm/mermaid@11.10.1/dist/mermaid.min.js" type="text/javascript"></script>

# ðŸš§ Draft: Full Pocket integration for ML pipelines

**Last modified: 2026-02-08**

The previous chapter (`pocket-model`) showed how to cache model
training in a [metamorph.ml](https://github.com/scicloj/metamorph.ml)
pipeline by swapping one step. That approach is simple â€” just
replace `ml/model` with `pocket-model` â€” but only the training
step is cached through Pocket.

This chapter explores a deeper integration: building the **entire
pipeline** as a chain of `pocket/caching-fn` calls. Every step â€”
data splitting, feature engineering, outlier clipping, training,
evaluation â€” becomes a cached node in a DAG, giving us:


- **Per-step storage control** â€” choose `:mem`, `:mem+disk`, or
  `:none` for each step independently

- **Full provenance** â€” `origin-story` traces any result back to
  the scalar parameters that produced it

- **Disk persistence** â€” cached models and intermediate results
  survive JVM restarts

- **Concurrent dedup** â€” same computation runs once across threads

We then add a thin evaluation loop on top â€” `pocket-evaluate-pipelines`
â€” that provides cross-validation and model comparison, similar to
metamorph.ml's `evaluate-pipelines` but built on Pocket's DAG.


## Background

[metamorph.ml](https://github.com/scicloj/metamorph.ml) is the
Scicloj library for machine learning pipelines. It builds on
[metamorph](https://github.com/scicloj/metamorph), a
data-transformation framework where each step is a function that
takes a context map and returns an updated one. Metamorph
distinguishes two modes â€” `:fit` (learn from training data) and
`:transform` (apply to new data) â€” so a pipeline can be trained
once and reused for prediction.

On top of this, metamorph.ml adds model training/prediction,
[cross-validation](https://en.wikipedia.org/wiki/Cross-validation_(statistics)) (`evaluate-pipelines`), [loss functions](https://en.wikipedia.org/wiki/Loss_function), and
[hyperparameter](https://en.wikipedia.org/wiki/Hyperparameter_(machine_learning)) search.


## How this chapter relates to others

The [ML Workflows](ml_workflows.html) chapter demonstrates Pocket
caching with plain functions â€” `pocket/cached` calls wired into a
DAG. This chapter uses the same pipeline functions and the same
DAG approach, but adds **cross-validation and model comparison**
on top, providing functionality similar to metamorph.ml's
`evaluate-pipelines`.

The [pocket-model](pocket_model.html) chapter takes the opposite
approach: it plugs into metamorph.ml's existing pipeline machinery
with a single drop-in replacement. Simpler to adopt, but only the
training step is cached through Pocket.

| | pocket-model | This chapter |
|--|-------------|-------------|
| Integration effort | One-line change | Build pipeline as DAG |
| What's cached | Training only | Every step |
| Provenance | Training step only | Full DAG |
| Storage control | Global | Per-step |
| Evaluation | metamorph.ml's `evaluate-pipelines` | `pocket-evaluate-pipelines` (loops over `Cached` references) |


## Setup


::: {.sourceClojure}
```clojure
(ns pocket-book.pocket-pipeline
  (:require
   ;; Logging setup for this chapter (see Logging chapter):
   [pocket-book.logging]
   ;; Pocket API:
   [scicloj.pocket :as pocket]
   ;; Annotating kinds of visualizations:
   [scicloj.kindly.v4.kind :as kind]
   ;; Metamorph pipeline tools:
   [scicloj.metamorph.core :as mm]
   ;; Data processing:
   [tablecloth.api :as tc]
   [tablecloth.column.api :as tcc]
   [tech.v3.dataset.modelling :as ds-mod]
   ;; Machine learning:
   [scicloj.metamorph.ml :as ml]
   [scicloj.metamorph.ml.loss :as loss]
   [scicloj.ml.tribuo]))
```
:::


Override the default log level from debug to info. This notebook
has many cached steps and debug output (cache hits, writes) would
overwhelm the rendered output. Info level shows cache misses,
invalidation, and cleanup â€” enough to see when computation happens.


::: {.sourceClojure}
```clojure
(pocket-book.logging/set-slf4j-level! :info)
```
:::



::: {.printedClojure}
```clojure
nil

```
:::



::: {.sourceClojure}
```clojure
(def cache-dir "/tmp/pocket-metamorph")
```
:::



::: {.sourceClojure}
```clojure
(pocket/set-base-cache-dir! cache-dir)
```
:::



::: {.callout-note}
## OUT
```
21:50:31.867 INFO scicloj.pocket - Cache dir set to: /tmp/pocket-metamorph

```
:::



::: {.printedClojure}
```clojure
"/tmp/pocket-metamorph"

```
:::



::: {.sourceClojure}
```clojure
(pocket/cleanup!)
```
:::



::: {.callout-note}
## OUT
```
21:50:31.868 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph

```
:::



::: {.printedClojure}
```clojure
{:dir "/tmp/pocket-metamorph", :existed false}

```
:::


---


## Pipeline functions

These are plain Clojure functions â€” each takes data in and returns
data out. They know nothing about caching or about metamorph's
context maps and fit/transform modes. Pocket will wrap them with
`caching-fn` later to add caching; the evaluation loop will call
them across folds to add cross-validation.


::: {.sourceClojure}
```clojure
(defn make-regression-data
  "Generate synthetic regression data: y = f(x) + noise.
  Optional outlier injection on x values."
  [{:keys [f n noise-sd seed outlier-fraction outlier-scale]
    :or {outlier-fraction 0 outlier-scale 10}}]
  (let [rng (java.util.Random. (long seed))
        xs (vec (repeatedly n #(* 10.0 (.nextDouble rng))))
        xs-final (if (pos? outlier-fraction)
                   (let [out-rng (java.util.Random. (+ (long seed) 7919))]
                     (mapv (fn [x]
                             (if (< (.nextDouble out-rng) outlier-fraction)
                               (+ x (* (double outlier-scale) (.nextGaussian out-rng)))
                               x))
                           xs))
                   xs)
        ys (mapv (fn [x] (+ (double (f x))
                            (* (double noise-sd) (.nextGaussian rng))))
                 xs)]
    (-> (tc/dataset {:x xs-final :y ys})
        (ds-mod/set-inference-target :y))))
```
:::



::: {.sourceClojure}
```clojure
(defn nonlinear-fn [x] (* (Math/sin x) x))
```
:::



::: {.sourceClojure}
```clojure
(defn split-dataset
  "Split into train/test using holdout."
  [ds {:keys [seed]}]
  (first (tc/split->seq ds :holdout {:seed seed})))
```
:::



::: {.sourceClojure}
```clojure
(defn prepare-features
  "Add derived columns: :raw (none), :poly+trig (xÂ², sin, cos)."
  [ds feature-set]
  (let [x (:x ds)]
    (-> (case feature-set
          :raw ds
          :poly+trig (tc/add-columns ds {:x2 (tcc/sq x)
                                         :sin-x (tcc/sin x)
                                         :cos-x (tcc/cos x)}))
        (ds-mod/set-inference-target :y))))
```
:::



::: {.sourceClojure}
```clojure
(defn fit-outlier-threshold
  "Compute IQR-based clipping bounds for :x from training data."
  [train-ds]
  (let [xs (sort (vec (:x train-ds)))
        n (count xs)
        q1 (nth xs (int (* 0.25 n)))
        q3 (nth xs (int (* 0.75 n)))
        iqr (- q3 q1)]
    {:lower (- q1 (* 1.5 iqr))
     :upper (+ q3 (* 1.5 iqr))}))
```
:::



::: {.sourceClojure}
```clojure
(defn clip-outliers
  "Clip :x values using pre-computed threshold bounds."
  [ds threshold]
  (let [{:keys [lower upper]} threshold]
    (tc/add-column ds :x (-> (:x ds) (tcc/max lower) (tcc/min upper)))))
```
:::



::: {.sourceClojure}
```clojure
(defn train-model
  "Train a model on a prepared dataset."
  [train-ds model-spec]
  (ml/train train-ds model-spec))
```
:::



::: {.sourceClojure}
```clojure
(defn predict-model
  "Predict on test data using a trained model."
  [test-ds model]
  (ml/predict test-ds model))
```
:::



## Model specifications


::: {.sourceClojure}
```clojure
(def cart-spec
  {:model-type :scicloj.ml.tribuo/regression
   :tribuo-components [{:name "cart"
                        :type "org.tribuo.regression.rtree.CARTRegressionTrainer"
                        :properties {:maxDepth "8"}}]
   :tribuo-trainer-name "cart"})
```
:::



::: {.sourceClojure}
```clojure
(def linear-sgd-spec
  {:model-type :scicloj.ml.tribuo/regression
   :tribuo-components [{:name "squared"
                        :type "org.tribuo.regression.sgd.objectives.SquaredLoss"}
                       {:name "linear-sgd"
                        :type "org.tribuo.regression.sgd.linear.LinearSGDTrainer"
                        :properties {:objective "squared"
                                     :epochs "50"
                                     :loggingInterval "10000"}}]
   :tribuo-trainer-name "linear-sgd"})
```
:::


---


## Caching-fn wrappers

Each pipeline function gets a `caching-fn` wrapper with an
appropriate storage policy:


- **`:mem`** for cheap shared steps (threshold, clipping, features,
  prediction) â€” no disk I/O, but in-memory dedup ensures each
  runs once

- **`:mem+disk`** (default) for expensive steps (model training)
  â€” persists to disk, survives JVM restarts

- **`:none`** for steps where we only want DAG tracking without
  any shared caching


::: {.sourceClojure}
```clojure
(def c-fit-outlier-threshold
  (pocket/caching-fn #'fit-outlier-threshold {:storage :mem}))
```
:::



::: {.sourceClojure}
```clojure
(def c-clip-outliers
  (pocket/caching-fn #'clip-outliers {:storage :mem}))
```
:::



::: {.sourceClojure}
```clojure
(def c-prepare-features
  (pocket/caching-fn #'prepare-features {:storage :mem}))
```
:::



::: {.sourceClojure}
```clojure
(def c-train-model
  (pocket/caching-fn #'train-model))
```
:::



::: {.sourceClojure}
```clojure
(def c-predict-model
  (pocket/caching-fn #'predict-model {:storage :mem}))
```
:::


---


## Custom pipeline steps

metamorph provides the pipeline machinery we need:
`mm/pipeline` composes steps, `mm/lift` wraps stateless functions,
`mm/fit-pipe` and `mm/transform-pipe` run pipelines in each mode.
These work with `Cached` references in `:metamorph/data` â€” they pass the
context through without inspecting the data.

We only need two custom step types that metamorph does not provide:


### `pocket-fitted`

Creates a stateful pipeline step from two functions: one that fits
parameters on training data, and one that applies those parameters
to any dataset. In `:fit` mode, both are called. In `:transform`
mode, only the apply function runs, using the parameters saved
during `:fit`.

This has no direct metamorph equivalent â€” in metamorph, each
stateful step must implement `(case mode :fit ... :transform ...)`
manually. `pocket-fitted` eliminates that boilerplate.


::: {.sourceClojure}
```clojure
(defn pocket-fitted
  "Create a stateful pipeline step from fit and apply functions.
  In :fit mode, fits parameters from data and applies them.
  In :transform mode, applies previously fitted parameters."
  [fit-caching-fn apply-caching-fn]
  (fn [{:metamorph/keys [data mode id] :as ctx}]
    (case mode
      :fit (let [fitted (fit-caching-fn data)]
             (-> ctx (assoc id fitted) (assoc :metamorph/data (apply-caching-fn data fitted))))
      :transform (assoc ctx :metamorph/data (apply-caching-fn data (get ctx id))))))
```
:::



### `pocket-model`

The model step â€” like `ml/model`. Trains in `:fit` mode (cached via
Pocket) and stores the model under its step ID. In `:transform`
mode, predicts using the stored model and saves the preprocessed
test data as `:target` (needed for metric computation in
`pocket-evaluate-pipelines`).


::: {.sourceClojure}
```clojure
(defn pocket-model
  "Create a model pipeline step. Trains in :fit mode,
  predicts in :transform mode. Like ml/model."
  [model-spec]
  (fn [{:metamorph/keys [data mode id] :as ctx}]
    (case mode
      :fit (assoc ctx id (c-train-model data model-spec))
      :transform (let [model (get ctx id)]
                   (assoc ctx :target data
                          :metamorph/data (c-predict-model data model))))))
```
:::


---


## Composing a pipeline

With these tools, we can build a specific pipeline by composing
steps â€” the same way we'd use `mm/pipeline` in metamorph:


::: {.sourceClojure}
```clojure
(def data-c
  (pocket/cached #'make-regression-data
                 {:f #'nonlinear-fn :n 500 :noise-sd 0.5 :seed 42
                  :outlier-fraction 0.1 :outlier-scale 15}))
```
:::



::: {.sourceClojure}
```clojure
(def split-c (pocket/cached #'split-dataset data-c {:seed 42}))
```
:::



::: {.sourceClojure}
```clojure
(def train-c (pocket/cached :train split-c))
```
:::



::: {.sourceClojure}
```clojure
(def test-c (pocket/cached :test split-c))
```
:::



::: {.sourceClojure}
```clojure
(def pipe-cart
  (mm/pipeline
   {:metamorph/id :clip} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)
   {:metamorph/id :prep} (mm/lift c-prepare-features :poly+trig)
   {:metamorph/id :model} (pocket-model cart-spec)))
```
:::


Fit on training data:


::: {.sourceClojure}
```clojure
(def fit-ctx (mm/fit-pipe train-c pipe-cart))
```
:::


Transform on test data (using fitted params from training):


::: {.sourceClojure}
```clojure
(def transform-ctx (mm/transform-pipe test-c pipe-cart fit-ctx))
```
:::


The fitted context carries the model and threshold as `Cached` references:


::: {.sourceClojure}
```clojure
(-> fit-ctx
    :model
    deref
    (update :model-data dissoc :model-as-bytes)
    kind/pprint)
```
:::



::: {.callout-note}
## OUT
```
21:50:31.882 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.882 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: :train
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/split-dataset
21:50:31.883 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:31.888 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold

```
:::



::: {.printedClojure}
```clojure
{:model-data {:target-ds Group: 0 [333 1]:

|          :y |
|------------:|
|  0.86298957 |
| -3.31824591 |
|  0.84502797 |
|  1.49792721 |
| -5.11365711 |
| -4.91894727 |
|  2.39650543 |
|  5.85326554 |
|  0.51279144 |
|  8.37327886 |
|         ... |
| -2.65944882 |
|  0.65420254 |
| -3.56240281 |
| -4.51681909 |
|  7.22642959 |
| -2.37170016 |
| -2.88234307 |
| -2.58490962 |
|  8.15404050 |
| -4.08785620 |
|  1.65671909 |
, :feature-ds Group: 0 [333 4]:

|          :x |         :x2 |      :sin-x |      :cos-x |
|------------:|------------:|------------:|------------:|
|  0.62212252 |  0.38703643 |  0.58276133 |  0.81264336 |
|  5.63922880 | 31.80090150 | -0.60036425 |  0.79972668 |
|  1.24912415 |  1.56031114 |  0.94870808 |  0.31615341 |
|  1.52711743 |  2.33208765 |  0.99904623 |  0.04366501 |
|  4.82231721 | 23.25474331 | -0.99396397 |  0.10970697 |
| -4.37550437 | 19.14503845 |  0.94378903 | -0.33054843 |
|  1.47898709 |  2.18740283 |  0.99578849 |  0.09168031 |
|  7.20124675 | 51.85795481 |  0.79442571 |  0.60736133 |
|  0.34521076 |  0.11917047 |  0.33839501 |  0.94100415 |
|  7.94559627 | 63.13250002 |  0.99580631 | -0.09148653 |
|         ... |         ... |         ... |         ... |
| -4.37550437 | 19.14503845 |  0.94378903 | -0.33054843 |
|  0.36484517 |  0.13311200 |  0.35680466 |  0.93417902 |
|  5.49169112 | 30.15867130 | -0.71140416 |  0.70278313 |
|  5.27903869 | 27.86824953 | -0.84370417 |  0.53680842 |
|  7.64151660 | 58.39277600 |  0.97751408 |  0.21087014 |
| -4.37550437 | 19.14503845 |  0.94378903 | -0.33054843 |
|  9.76876450 | 95.42875978 | -0.33724276 | -0.94141772 |
|  5.67942172 | 32.25583106 | -0.56774469 |  0.82320469 |
|  8.09594125 | 65.54426469 |  0.97087030 | -0.23960562 |
|  4.36540394 | 19.05675156 | -0.94040226 | -0.34006408 |
|  1.52754849 |  2.33340440 |  0.99906496 |  0.04323435 |
},
 :options
 {:model-type :scicloj.ml.tribuo/regression,
  :tribuo-components
  [{:name "cart",
    :type "org.tribuo.regression.rtree.CARTRegressionTrainer",
    :properties {:maxDepth "8"}}],
  :tribuo-trainer-name "cart"},
 :train-input-hash nil,
 :id #uuid "af4751a0-2f7d-43dd-bf8c-a2dd67c5f16f",
 :feature-columns [:x :x2 :sin-x :cos-x],
 :target-columns [:y],
 :target-datatypes {:y :float64}}

```
:::


Predictions:


::: {.sourceClojure}
```clojure
(tc/head (deref (:metamorph/data transform-ctx)))
```
:::



::: {.callout-note}
## OUT
```
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.902 INFO scicloj.pocket.impl.cache - Cache miss, computing: :test

```
:::


::: {.clay-dataset}
_unnamed [5 1]:

|          :y |
|------------:|
|  1.88005320 |
|  0.87019231 |
|  0.87019231 |
|  0.87019231 |
| -3.10429723 |


:::


Compute [RMSE](https://en.wikipedia.org/wiki/Root_mean_square_deviation) from the target (preprocessed test data) and predictions:


::: {.sourceClojure}
```clojure
(loss/rmse (:y @(:target transform-ctx))
           (:y @(:metamorph/data transform-ctx)))
```
:::



::: {.printedClojure}
```clojure
1.9830584588944564

```
:::



### Train and test loss

A single metric on test data tells us how well the model generalizes,
but comparing train and test [loss](https://en.wikipedia.org/wiki/Loss_function) reveals whether the model is
[overfitting](https://en.wikipedia.org/wiki/Overfitting). We compute the loss separately for each, then gather
both into a summary.


::: {.sourceClojure}
```clojure
(defn compute-loss
  "Compute RMSE between actual and predicted :y columns."
  [actual-ds predicted-ds]
  (loss/rmse (:y actual-ds) (:y predicted-ds)))
```
:::



::: {.sourceClojure}
```clojure
(def c-compute-loss (pocket/caching-fn #'compute-loss {:storage :mem}))
```
:::


We already have the test predictions from `transform-ctx`. For
training loss, we also transform the training data through the
fitted pipeline:


::: {.sourceClojure}
```clojure
(def train-transform-ctx (mm/transform-pipe train-c pipe-cart fit-ctx))
```
:::


Now we compute loss on each split independently:


::: {.sourceClojure}
```clojure
(def train-loss-c
  (c-compute-loss (:target train-transform-ctx)
                  (:metamorph/data train-transform-ctx)))
```
:::



::: {.sourceClojure}
```clojure
(def test-loss-c
  (c-compute-loss (:target transform-ctx)
                  (:metamorph/data transform-ctx)))
```
:::


A report function gathers both into one summary:


::: {.sourceClojure}
```clojure
(defn report
  "Gather train and test loss into a summary map."
  [train-loss test-loss]
  {:train-rmse train-loss
   :test-rmse test-loss})
```
:::



::: {.sourceClojure}
```clojure
(def c-report (pocket/caching-fn #'report {:storage :mem}))
```
:::



::: {.sourceClojure}
```clojure
(def summary-c (c-report train-loss-c test-loss-c))
```
:::



::: {.sourceClojure}
```clojure
(deref summary-c)
```
:::



::: {.callout-note}
## OUT
```
21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/report
21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/compute-loss
21:50:31.910 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.912 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/compute-loss

```
:::



::: {.printedClojure}
```clojure
{:train-rmse 0.908876032851451, :test-rmse 1.9830584588944564}

```
:::


The summary reference carries full provenance. The DAG branches
into train and test paths that share the same model node â€” a
diamond dependency that Pocket traces naturally:


::: {.sourceClojure}
```clojure
(pocket/origin-story-mermaid summary-c)
```
:::



```{=html}
<div class="mermaid">flowchart TD
  n0["report"]
  n1["compute-loss"]
  n2["prepare-features"]
  n3["clip-outliers"]
  n4[":train"]
  n5["split-dataset"]
  n6["make-regression-data"]
  n7[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n7 --> n6
  n6 --> n5
  n8[/"{:seed 42}"/]
  n8 --> n5
  n5 --> n4
  n4 --> n3
  n9["fit-outlier-threshold"]
  n4 --> n9
  n9 --> n3
  n3 --> n2
  n10[/":poly+trig"/]
  n10 --> n2
  n2 --> n1
  n11["predict-model"]
  n2 --> n11
  n12["train-model"]
  n13["prepare-features"]
  n14["clip-outliers"]
  n4 --> n14
  n9 --> n14
  n14 --> n13
  n15[/":poly+trig"/]
  n15 --> n13
  n13 --> n12
  n16[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '8'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n16 --> n12
  n12 --> n11
  n11 --> n1
  n1 --> n0
  n17["compute-loss"]
  n18["prepare-features"]
  n19["clip-outliers"]
  n20[":test"]
  n5 --> n20
  n20 --> n19
  n9 --> n19
  n19 --> n18
  n21[/":poly+trig"/]
  n21 --> n18
  n18 --> n17
  n22["predict-model"]
  n18 --> n22
  n12 --> n22
  n22 --> n17
  n17 --> n0</div>
```



::: {.sourceClojure}
```clojure
(pocket/cleanup!)
```
:::



::: {.callout-note}
## OUT
```
21:50:31.917 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph

```
:::



::: {.printedClojure}
```clojure
{:dir "/tmp/pocket-metamorph", :existed true}

```
:::


---


## Splits as Cached references

For cross-validation, we need k train/test splits â€” each as a
`Cached` reference so the full provenance chain is maintained.


::: {.sourceClojure}
```clojure
(defn nth-split-train
  "Extract the train set of the nth split."
  [ds split-method split-params idx]
  (:train (nth (tc/split->seq ds split-method split-params) idx)))
```
:::



::: {.sourceClojure}
```clojure
(defn nth-split-test
  "Extract the test set of the nth split."
  [ds split-method split-params idx]
  (:test (nth (tc/split->seq ds split-method split-params) idx)))
```
:::



::: {.sourceClojure}
```clojure
(defn- n-splits
  "Derive the number of splits from the method and params,
  without materializing the dataset."
  [split-method split-params]
  (case split-method
    :kfold (:k split-params 5)
    :holdout 1
    :bootstrap (:repeats split-params 1)
    :loo (throw (ex-info "pocket-splits does not support :loo (needs dataset size)" {}))))
```
:::



::: {.printedClojure}
```clojure
#'pocket-book.pocket-pipeline/n-splits

```
:::



::: {.sourceClojure}
```clojure
(defn pocket-splits
  "Create k-fold splits as Cached references.
  Returns [{:train Cached, :test Cached, :idx int} ...]."
  [data-c split-method split-params]
  (vec (for [idx (range (n-splits split-method split-params))]
         {:train (pocket/cached #'nth-split-train
                                data-c split-method split-params idx)
          :test (pocket/cached #'nth-split-test
                               data-c split-method split-params idx)
          :idx idx})))
```
:::


---


## Evaluation loop

`pocket-evaluate-pipelines` runs pipelines across splits â€” like
metamorph.ml's `evaluate-pipelines`. For each pipeline Ã— each
fold, it fits on train, transforms on test, and computes a metric.


::: {.sourceClojure}
```clojure
(defn pocket-evaluate-pipelines
  "Evaluate pipelines across k-fold splits.
  Like ml/evaluate-pipelines, but built on Cached references.
  
  `pipelines` is a seq of pipeline functions (from mm/pipeline).
  `metric-fn` takes (test-ds, prediction-ds) and returns a number."
  [data-c split-method split-params pipelines metric-fn]
  (let [splits (pocket-splits data-c split-method split-params)]
    (vec (for [pipe-fn pipelines
               {:keys [train test idx]} splits]
           (let [fit-ctx (mm/fit-pipe train pipe-fn)
                 transform-ctx (mm/transform-pipe test pipe-fn fit-ctx)
                 metric (metric-fn @(:target transform-ctx)
                                   @(:metamorph/data transform-ctx))]
             {:split-idx idx
              :metric metric
              :model (:model fit-ctx)})))))
```
:::


---


## Demo: cross-validation

3-fold CV with three pipeline configurations:


::: {.sourceClojure}
```clojure
(defn rmse-metric
  "Compute RMSE between actual and predicted :y columns."
  [test-ds pred-ds]
  (loss/rmse (:y test-ds) (:y pred-ds)))
```
:::



::: {.sourceClojure}
```clojure
(defn make-pipe [{:keys [feature-set model-spec]}]
  (mm/pipeline
   {:metamorph/id :clip} (pocket-fitted c-fit-outlier-threshold c-clip-outliers)
   {:metamorph/id :prep} (mm/lift c-prepare-features feature-set)
   {:metamorph/id :model} (pocket-model model-spec)))
```
:::



::: {.sourceClojure}
```clojure
(def configs
  [{:feature-set :poly+trig :model-spec cart-spec}
   {:feature-set :raw :model-spec cart-spec}
   {:feature-set :poly+trig :model-spec linear-sgd-spec}])
```
:::



::: {.sourceClojure}
```clojure
(def results
  (pocket-evaluate-pipelines data-c :kfold {:k 3 :seed 42}
                             (mapv make-pipe configs)
                             rmse-metric))
```
:::



::: {.callout-note}
## OUT
```
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.931 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:31.936 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.936 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.939 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.952 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.954 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.954 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.956 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.968 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:31.970 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:31.970 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.973 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:31.985 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.986 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.992 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:31.998 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.004 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.004 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.866764,min=-5.914919,mean=0.701788,variance=15.193172})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.7525222314159787
21:50:32.011 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.011 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 333 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=333,max=8.498492,min=-5.914919,mean=0.583017,variance=14.288227})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.695109774152164
21:50:32.018 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.018 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Training SGD model with 334 examples
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: Outputs - RegressionInfo({name=y,id=0,count=334,max=8.866764,min=-5.501972,mean=0.844474,variance=15.400435})
Feb 08, 2026 9:50:32 PM org.tribuo.common.sgd.AbstractSGDTrainer train
INFO: At iteration 10000, average loss = 3.510884525077099

```
:::


3 configs Ã— 3 folds = 9 evaluations:


::: {.sourceClojure}
```clojure
(count results)
```
:::



::: {.printedClojure}
```clojure
9

```
:::


Aggregate mean RMSE per config:


::: {.sourceClojure}
```clojure
(def summary
  (let [grouped (partition 3 results)]
    (mapv (fn [config rs]
            {:feature-set (:feature-set config)
             :model-type (-> config :model-spec :tribuo-trainer-name)
             :mean-rmse (tcc/mean (map :metric rs))})
          configs grouped)))
```
:::



::: {.sourceClojure}
```clojure
(tc/dataset summary)
```
:::


::: {.clay-dataset}
_unnamed [3 3]:

| :feature-set | :model-type | :mean-rmse |
|--------------|-------------|-----------:|
|   :poly+trig |        cart | 1.97410371 |
|         :raw |        cart | 1.79975941 |
|   :poly+trig |  linear-sgd | 2.00500709 |


:::


Second run â€” all training hits cache:


::: {.sourceClojure}
```clojure
(def results-2
  (pocket-evaluate-pipelines data-c :kfold {:k 3 :seed 42}
                             (mapv make-pipe configs)
                             rmse-metric))
```
:::



::: {.sourceClojure}
```clojure
(= (mapv :metric results) (mapv :metric results-2))
```
:::



::: {.printedClojure}
```clojure
true

```
:::


---


## Demo: hyperparameter sweep

Vary tree depth Ã— feature set. Each unique combination trains once
and is cached. Re-running adds only new combinations.


::: {.sourceClojure}
```clojure
(pocket/cleanup!)
```
:::



::: {.callout-note}
## OUT
```
21:50:32.049 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph

```
:::



::: {.printedClojure}
```clojure
{:dir "/tmp/pocket-metamorph", :existed true}

```
:::



::: {.sourceClojure}
```clojure
(def sweep-configs
  (vec (for [depth [4 6 8 12]
             fs [:raw :poly+trig]]
         {:feature-set fs
          :model-spec {:model-type :scicloj.ml.tribuo/regression
                       :tribuo-components [{:name "cart"
                                            :type "org.tribuo.regression.rtree.CARTRegressionTrainer"
                                            :properties {:maxDepth (str depth)}}]
                       :tribuo-trainer-name "cart"}})))
```
:::



::: {.sourceClojure}
```clojure
(def sweep-results
  (pocket-evaluate-pipelines data-c :kfold {:k 3 :seed 42}
                             (mapv make-pipe sweep-configs)
                             rmse-metric))
```
:::



::: {.callout-note}
## OUT
```
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.054 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/make-regression-data
21:50:32.058 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.058 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.060 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.066 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.067 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.067 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.069 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.069 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.071 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.077 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-test
21:50:32.079 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/fit-outlier-threshold
21:50:32.079 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/nth-split-train
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.082 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/clip-outliers
21:50:32.088 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.088 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.089 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.089 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.098 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.110 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.111 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/prepare-features
21:50:32.122 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.122 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.128 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.128 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.135 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.135 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.141 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.141 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.151 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.151 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.161 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.161 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.171 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.171 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.178 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.178 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.188 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.188 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.196 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.196 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.211 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.212 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.223 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.223 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.235 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.236 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.244 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.244 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.253 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.253 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.260 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.260 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.271 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.271 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model
21:50:32.284 INFO scicloj.pocket.impl.cache - Cache miss (mem), computing: pocket-book.pocket-pipeline/predict-model
21:50:32.285 INFO scicloj.pocket.impl.cache - Cache miss, computing: pocket-book.pocket-pipeline/train-model

```
:::


8 configs Ã— 3 folds = 24 evaluations:


::: {.sourceClojure}
```clojure
(count sweep-results)
```
:::



::: {.printedClojure}
```clojure
24

```
:::


Results by depth and feature set:


::: {.sourceClojure}
```clojure
(def sweep-summary
  (let [grouped (partition 3 sweep-results)]
    (->> (mapv (fn [config rs]
                 {:depth (-> config :model-spec :tribuo-components
                             first :properties :maxDepth)
                  :feature-set (:feature-set config)
                  :mean-rmse (tcc/mean (map :metric rs))})
               sweep-configs grouped)
         (sort-by :mean-rmse))))
```
:::



::: {.sourceClojure}
```clojure
(tc/dataset sweep-summary)
```
:::


::: {.clay-dataset}
_unnamed [8 3]:

| :depth | :feature-set | :mean-rmse |
|--------|--------------|-----------:|
|      4 |         :raw | 1.56523718 |
|      6 |         :raw | 1.78120543 |
|      4 |   :poly+trig | 1.79514560 |
|      8 |         :raw | 1.79975941 |
|     12 |         :raw | 1.80992021 |
|      8 |   :poly+trig | 1.97410371 |
|     12 |   :poly+trig | 1.98328222 |
|      6 |   :poly+trig | 1.98966980 |


:::


On this synthetic data, the shallow tree (depth 4) with raw features
outperforms deeper trees and engineered features â€” a reminder that
more complexity does not always help.

---


## Provenance

Pick one result and trace its full provenance. The DAG goes
from the trained model back to the original scalar parameters
(seed, noise-sd, outlier-fraction, etc.).


::: {.sourceClojure}
```clojure
(pocket/origin-story-mermaid (:model (first sweep-results)))
```
:::



```{=html}
<div class="mermaid">flowchart TD
  n0["train-model"]
  n1["prepare-features"]
  n2["clip-outliers"]
  n3["nth-split-train"]
  n4["make-regression-data"]
  n5[/"{:f #'pocket-book.pocket-pipeline/nonlinear-fn,<br>:n 500,<br>:noise-sd 0.5,<br>:seed 42,<br>:outlier-fraction 0.1,<br>:outlier-scale 15}"/]
  n5 --> n4
  n4 --> n3
  n6[/":kfold"/]
  n6 --> n3
  n7[/"{:k 3,<br>:seed 42}"/]
  n7 --> n3
  n8[/"0"/]
  n8 --> n3
  n3 --> n2
  n9["fit-outlier-threshold"]
  n3 --> n9
  n9 --> n2
  n2 --> n1
  n10[/":raw"/]
  n10 --> n1
  n1 --> n0
  n11[/"{:model-type :scicloj.ml.tribuo/regression,<br>:tribuo-components [{:name 'cart',<br>:type 'org.tribuo.regression.rtree.CARTRegressionTrainer',<br>:properties {:maxDepth '4'}}],<br>:tribuo-trainer-name 'cart'}"/]
  n11 --> n0</div>
```


---


## Discussion

**What the Pocket DAG approach brings to an ML workflow:**

| Aspect | What Pocket adds |
|--------|-----------------|
| Caching | Per-step, configurable â€” each step chooses `:mem`, `:mem+disk`, or `:none` |
| Provenance | Full DAG via `origin-story` â€” trace any result to its parameters |
| Disk persistence | Cached models and intermediates survive JVM restarts |
| Concurrent dedup | `ConcurrentHashMap` ensures each computation runs once across threads |

**Reusing metamorph:**

We use `mm/pipeline`, `mm/lift`, `mm/fit-pipe`, and
`mm/transform-pipe` directly â€” they pass `Cached` references through
`:metamorph/data` without inspecting them. Pocket only adds two
custom step types:


- **`pocket-model`** â€” like `ml/model`, but caches training via
  `pocket/cached` so models persist to disk

- **`pocket-fitted`** â€” a new pattern for stateful steps

In metamorph, every stateful step must dispatch on mode manually:

```clj
;; metamorph style â€” manual mode dispatch
(fn [{:metamorph/keys [data mode id] :as ctx}]
  (case mode
    :fit       (let [bounds (fit-threshold data)]
                 (assoc ctx id bounds
                        :metamorph/data (clip data bounds)))
    :transform (let [bounds (get ctx id)]
                 (assoc ctx :metamorph/data (clip data bounds)))))
```

`pocket-fitted` eliminates that boilerplate â€” we just provide
the fit function and the apply function:

```clj
;; Pocket style â€” same behavior, less ceremony
(pocket-fitted c-fit-outlier-threshold c-clip-outliers)
```

On top of this, `pocket-evaluate-pipelines` and `pocket-splits`
wrap cross-validation in `Cached` references for provenance. Everything
else is standard metamorph.

**What we write:**

1. Plain pipeline functions (data in, data out)
2. `caching-fn` wrappers with storage policies (one line each)
3. Pipeline composition via `mm/pipeline` with our custom steps
4. `pocket-evaluate-pipelines` for cross-validation across `Cached` splits

**Open question: where should the custom steps live?**
`pocket-fitted`, `pocket-model`, `pocket-splits`, and
`pocket-evaluate-pipelines` are currently defined in this notebook.
A future `scicloj.pocket.ml` namespace could provide them â€” but
only if the pattern proves stable across different use cases.


## Cleanup


::: {.sourceClojure}
```clojure
(pocket/cleanup!)
```
:::



::: {.callout-note}
## OUT
```
21:50:32.310 INFO scicloj.pocket - Cache cleanup: /tmp/pocket-metamorph

```
:::



::: {.printedClojure}
```clojure
{:dir "/tmp/pocket-metamorph", :existed true}

```
:::



```{=html}
<div style="background-color:grey;height:2px;width:100%;"></div>
```



```{=html}
<div><pre><small><small>source: <a href="https://github.com/scicloj/pocket/blob/master/notebooks/pocket_book/pocket_pipeline.clj">notebooks/pocket_book/pocket_pipeline.clj</a></small></small></pre></div>
```